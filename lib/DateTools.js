"use strict";

var _DateTools$units;

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

/**
 * Copyright &copy; 2017 Market Acumen, Inc.
 */
//const _ = require("lodash");
var Zesk = require("./Zesk");

function zero(x) {
	if (x < 10) {
		return "0" + x;
	}
	return String(x);
}

var DateTools = {
	toString: function toString(d) {
		return d.getUTCFullYear() + "-" + zero(d.getUTCMonth() + 1) + "-" + zero(d.getUTCDate()) + " " + zero(d.getUTCHours()) + ":" + zero(d.getUTCMinutes()) + ":" + zero(d.getUTCSeconds());
	},
	MILLISECOND: "millisecond",
	SECOND: "second",
	MINUTE: "minute",
	HOUR: "hour",
	DAY: "day",
	WEEK: "week",
	WEEKDAY: "weekday",
	MONTH: "month",
	QUARTER: "quarter",
	YEAR: "year",

	formatting: function formatting(d, localizer) {
		if (!localizer) {
			localizer = function localizer(x) {
				return x;
			};
		}
		var h12 = d.getUTCHours() % 12;
		if (h12 === 0) {
			h12 = 12;
		}
		return {
			YYYY: d.getUTCFullYear(),
			M: d.getUTCMonth() + 1,
			MM: zero(d.getUTCMonth() + 1),
			MMM: localizer(DateTools.short_months[d.getUTCMonth()]),
			MMMM: localizer(DateTools.months[d.getUTCMonth()]),
			W: d.getUTCDay(),
			WWW: localizer(DateTools.short_weekdays[d.getUTCDay()]),
			WWWW: localizer(DateTools.weekdays[d.getUTCDay()]),
			D: d.getUTCDate(),
			DD: zero(d.getUTCDate()),
			h: d.getUTCHours(),
			hh: zero(d.getUTCHours()),
			"12h": h12,
			"12hh": zero(h12),
			m: d.getUTCMinutes(),
			mm: zero(d.getUTCMinutes()),
			s: d.getUTCSeconds(),
			ss: zero(d.getUTCSeconds())
		};
	},
	format: function format(d, _format, localizer) {
		return Zesk.map(_format, DateTools.formatting(d, localizer));
	}
};

var SECONDS_IN_MINUTE = 60;
var MINUTES_IN_HOUR = 60;
var HOURS_IN_DAY = 24;
var DAYS_PER_WEEK = 7;
var DAYS_IN_YEAR = 365;
var MONTHS_IN_YEAR = 12;
var QUARTERS_IN_YEAR = 4;

var SECONDS_IN_HOUR = SECONDS_IN_MINUTE * MINUTES_IN_HOUR;
var SECONDS_IN_DAY = SECONDS_IN_HOUR * HOURS_IN_DAY;
var SECONDS_IN_WEEK = SECONDS_IN_DAY * DAYS_PER_WEEK;
var SECONDS_IN_YEAR = SECONDS_IN_DAY * DAYS_IN_YEAR;

DateTools.units = (_DateTools$units = {}, _defineProperty(_DateTools$units, DateTools.MILLISECOND, 0.001), _defineProperty(_DateTools$units, DateTools.SECOND, 1), _defineProperty(_DateTools$units, DateTools.MINUTE, SECONDS_IN_MINUTE), _defineProperty(_DateTools$units, DateTools.HOUR, SECONDS_IN_HOUR), _defineProperty(_DateTools$units, DateTools.DAY, SECONDS_IN_DAY), _defineProperty(_DateTools$units, DateTools.WEEK, SECONDS_IN_WEEK), _defineProperty(_DateTools$units, DateTools.YEAR, SECONDS_IN_YEAR), _defineProperty(_DateTools$units, DateTools.MONTH, SECONDS_IN_YEAR / MONTHS_IN_YEAR), _defineProperty(_DateTools$units, DateTools.QUARTER, SECONDS_IN_YEAR / QUARTERS_IN_YEAR), _DateTools$units);
DateTools.unitsOrder = [DateTools.MILLISECOND, DateTools.SECOND, DateTools.MINUTE, DateTools.HOUR, DateTools.DAY, DateTools.WEEK, DateTools.MONTH, DateTools.YEAR];

var subtract = function subtract(source, timestamp) {
	return source.getTime() - timestamp.getTime();
};

var difference = function difference(source, timestamp) {
	var unit = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : DateTools.SECOND;
	var precision = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 0;

	if (timestamp.getTime() > source.getTime()) {
		return -difference(timestamp, source, unit, precision);
	}
	if (unit === DateTools.WEEKDAY) {
		return source.getUTCDay() - timestamp.getUTCDay();
	}
	var delta = subtract(source, timestamp);
	delta *= 0.001;
	switch (unit) {
		case DateTools.MILLISECOND:
			return delta * 1000;
		case DateTools.SECOND:
			return delta;
		case DateTools.MINUTE:
			return Math.round(delta / 60.0, precision);
		case DateTools.HOUR:
			return Math.round(delta / 3600.0, precision);
		case DateTools.DAY:
			return Math.round(delta / 86400, precision);
		case DateTools.WEEK:
			return Math.round(delta / (86400 * 7), precision);
	}

	var mstart = timestamp.getUTCMonth(),
	    ystart = timestamp.getUTCFullYear();

	var mend = source.getUTCMonth(),
	    yend = source.getUTCFullYear();

	if (precision === 0) {
		switch (unit) {
			case DateTools.MONTH:
				return (yend - ystart) * 12 + (mend - mstart);
			case DateTools.QUARTER:
				mend = parseInt(mend / 4, 10);
				mstart = parseInt(mstart / 4, 10);
				return (yend - ystart) * 4 + (mend - mstart);
			case DateTools.YEAR:
				return yend - ystart;
			default:
				throw new Error("DateTools.difference(" + source + "," + timestamp + "," + unit + "): Bad unit");
		}
	} else {
		// Works like so:
		//
		// 2/22 -> 3/22 = 1 month
		// 2/12 -> 3/22 = 1 month + ((3/22-2/22) / 28)

		var intmon = (yend - ystart) * 12 + (mend - mstart);
		var total = DateTools.days_in_month(mstart, ystart);

		var temp = new Date();
		temp.setTime(timestamp.getTime());
		temp.setMonth(mstart);
		temp.setYear(ystart);

		var result = null,
		    fract = subtract(temp, source);
		fract = fract / parseFloat(total * 86400);

		switch (unit) {
			case DateTools.MONTH:
				result = Math.round(intmon + fract, precision);

				break;
			case DateTools.QUARTER:
				result = Math.round((intmon + fract) / 3, precision);

				break;
			case DateTools.YEAR:
				result = Math.round((intmon + fract) / 12, precision);

				break;
			default:
				throw new Error("DateTools.difference(" + source + "," + timestamp + "," + unit + "): Bad unit");
		}
		return result;
	}
};
DateTools.difference = difference;

DateTools.findUnit = function (seconds) {
	var result = DateTools.YEAR;
	var units = DateTools.units;
	Zesk.each(DateTools.unitsOrder, function () {
		var sec = units[this];
		if (seconds < sec) {
			return true;
		}
		result = this;
	});
	return result;
};

DateTools.toUnit = function (seconds, unit) {
	if (!DateTools.units[unit]) {
		throw new Error("Unknown unit " + unit + " in DateTools.toUnit");
	}
	return parseFloat(seconds) / DateTools.units[unit];
};

var months = function months() {
	var m = [],
	    d = new Date();
	m.length = MONTHS_IN_YEAR;
	return m.fill(0).map(function (a, i) {
		d.setUTCDate(1);
		d.setUTCMonth(i);
		return d.toDateString().split(" ")[1];
	});
};

DateTools.months = DateTools.short_months = months();

var weekdays = function weekdays() {
	var m = [],
	    d = new Date(),
	    init = void 0;
	d.setUTCFullYear(2019);
	d.setUTCDate(19);
	d.setUTCMonth(3); // Sunday
	d.setUTCHours(0);

	d.setUTCSeconds(0);

	init = d.getTime();
	m.length = DAYS_PER_WEEK;
	return m.fill(0).map(function (a, i) {
		d.setTime(init + 86400 * 1000 * i);
		return d.toDateString().split(" ")[0];
	});
};
DateTools.weekdays = DateTools.short_weekdays = weekdays();

module.exports = DateTools;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9EYXRlVG9vbHMuanMiXSwibmFtZXMiOlsiWmVzayIsInJlcXVpcmUiLCJ6ZXJvIiwieCIsIlN0cmluZyIsIkRhdGVUb29scyIsInRvU3RyaW5nIiwiZCIsImdldFVUQ0Z1bGxZZWFyIiwiZ2V0VVRDTW9udGgiLCJnZXRVVENEYXRlIiwiZ2V0VVRDSG91cnMiLCJnZXRVVENNaW51dGVzIiwiZ2V0VVRDU2Vjb25kcyIsIk1JTExJU0VDT05EIiwiU0VDT05EIiwiTUlOVVRFIiwiSE9VUiIsIkRBWSIsIldFRUsiLCJXRUVLREFZIiwiTU9OVEgiLCJRVUFSVEVSIiwiWUVBUiIsImZvcm1hdHRpbmciLCJsb2NhbGl6ZXIiLCJoMTIiLCJZWVlZIiwiTSIsIk1NIiwiTU1NIiwic2hvcnRfbW9udGhzIiwiTU1NTSIsIm1vbnRocyIsIlciLCJnZXRVVENEYXkiLCJXV1ciLCJzaG9ydF93ZWVrZGF5cyIsIldXV1ciLCJ3ZWVrZGF5cyIsIkQiLCJERCIsImgiLCJoaCIsIm0iLCJtbSIsInMiLCJzcyIsImZvcm1hdCIsIm1hcCIsIlNFQ09ORFNfSU5fTUlOVVRFIiwiTUlOVVRFU19JTl9IT1VSIiwiSE9VUlNfSU5fREFZIiwiREFZU19QRVJfV0VFSyIsIkRBWVNfSU5fWUVBUiIsIk1PTlRIU19JTl9ZRUFSIiwiUVVBUlRFUlNfSU5fWUVBUiIsIlNFQ09ORFNfSU5fSE9VUiIsIlNFQ09ORFNfSU5fREFZIiwiU0VDT05EU19JTl9XRUVLIiwiU0VDT05EU19JTl9ZRUFSIiwidW5pdHMiLCJ1bml0c09yZGVyIiwic3VidHJhY3QiLCJzb3VyY2UiLCJ0aW1lc3RhbXAiLCJnZXRUaW1lIiwiZGlmZmVyZW5jZSIsInVuaXQiLCJwcmVjaXNpb24iLCJkZWx0YSIsIk1hdGgiLCJyb3VuZCIsIm1zdGFydCIsInlzdGFydCIsIm1lbmQiLCJ5ZW5kIiwicGFyc2VJbnQiLCJFcnJvciIsImludG1vbiIsInRvdGFsIiwiZGF5c19pbl9tb250aCIsInRlbXAiLCJEYXRlIiwic2V0VGltZSIsInNldE1vbnRoIiwic2V0WWVhciIsInJlc3VsdCIsImZyYWN0IiwicGFyc2VGbG9hdCIsImZpbmRVbml0Iiwic2Vjb25kcyIsImVhY2giLCJzZWMiLCJ0b1VuaXQiLCJsZW5ndGgiLCJmaWxsIiwiYSIsImkiLCJzZXRVVENEYXRlIiwic2V0VVRDTW9udGgiLCJ0b0RhdGVTdHJpbmciLCJzcGxpdCIsImluaXQiLCJzZXRVVENGdWxsWWVhciIsInNldFVUQ0hvdXJzIiwic2V0VVRDU2Vjb25kcyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOzs7QUFHQTtBQUNBLElBQU1BLE9BQU9DLFFBQVEsUUFBUixDQUFiOztBQUVBLFNBQVNDLElBQVQsQ0FBY0MsQ0FBZCxFQUFpQjtBQUNoQixLQUFJQSxJQUFJLEVBQVIsRUFBWTtBQUNYLFNBQU8sTUFBTUEsQ0FBYjtBQUNBO0FBQ0QsUUFBT0MsT0FBT0QsQ0FBUCxDQUFQO0FBQ0E7O0FBRUQsSUFBSUUsWUFBWTtBQUNmQyxXQUFVLGtCQUFTQyxDQUFULEVBQVk7QUFDckIsU0FDQ0EsRUFBRUMsY0FBRixLQUNBLEdBREEsR0FFQU4sS0FBS0ssRUFBRUUsV0FBRixLQUFrQixDQUF2QixDQUZBLEdBR0EsR0FIQSxHQUlBUCxLQUFLSyxFQUFFRyxVQUFGLEVBQUwsQ0FKQSxHQUtBLEdBTEEsR0FNQVIsS0FBS0ssRUFBRUksV0FBRixFQUFMLENBTkEsR0FPQSxHQVBBLEdBUUFULEtBQUtLLEVBQUVLLGFBQUYsRUFBTCxDQVJBLEdBU0EsR0FUQSxHQVVBVixLQUFLSyxFQUFFTSxhQUFGLEVBQUwsQ0FYRDtBQWFBLEVBZmM7QUFnQmZDLGNBQWEsYUFoQkU7QUFpQmZDLFNBQVEsUUFqQk87QUFrQmZDLFNBQVEsUUFsQk87QUFtQmZDLE9BQU0sTUFuQlM7QUFvQmZDLE1BQUssS0FwQlU7QUFxQmZDLE9BQU0sTUFyQlM7QUFzQmZDLFVBQVMsU0F0Qk07QUF1QmZDLFFBQU8sT0F2QlE7QUF3QmZDLFVBQVMsU0F4Qk07QUF5QmZDLE9B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QUFtQjVCLFVBQVUwQixZQUFWLEdBQXlCRSxRQUE1Qzs7QUFFQSxJQUFNTSxXQUFXLFNBQVhBLFFBQVcsR0FBVztBQUMzQixLQUFJSyxJQUFJLEVBQVI7QUFBQSxLQUNDckMsSUFBSSxJQUFJNEUsSUFBSixFQURMO0FBQUEsS0FFQ29CLGFBRkQ7QUFHQWhHLEdBQUVpRyxjQUFGLENBQWlCLElBQWpCO0FBQ0FqRyxHQUFFNEYsVUFBRixDQUFhLEVBQWI7QUFDQTVGLEdBQUU2RixXQUFGLENBQWMsQ0FBZCxFQU4yQixDQU1UO0FBQ2xCN0YsR0FBRWtHLFdBQUYsQ0FBYyxDQUFkOztBQUVBbEcsR0FBRW1HLGFBQUYsQ0FBZ0IsQ0FBaEI7O0FBRUFILFFBQU9oRyxFQUFFMkQsT0FBRixFQUFQO0FBQ0F0QixHQUFFbUQsTUFBRixHQUFXMUMsYUFBWDtBQUNBLFFBQU9ULEVBQUVvRCxJQUFGLENBQU8sQ0FBUCxFQUFVL0MsR0FBVixDQUFjLFVBQVNnRCxDQUFULEVBQVlDLENBQVosRUFBZTtBQUNuQzNGLElBQUU2RSxPQUFGLENBQVVtQixPQUFPLFFBQVEsSUFBUixHQUFlTCxDQUFoQztBQUNBLFNBQU8zRixFQUFFOEYsWUFBRixHQUFpQkMsS0FBakIsQ0FBdUIsR0FBdkIsRUFBNEIsQ0FBNUIsQ0FBUDtBQUNBLEVBSE0sQ0FBUDtBQUlBLENBakJEO0FBa0JBakcsVUFBVWtDLFFBQVYsR0FBcUJsQyxVQUFVZ0MsY0FBVixHQUEyQkUsVUFBaEQ7O0FBRUFvRSxPQUFPQyxPQUFQLEdBQWlCdkcsU0FBakIiLCJmaWxlIjoiRGF0ZVRvb2xzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgJmNvcHk7IDIwMTcgTWFya2V0IEFjdW1lbiwgSW5jLlxuICovXG4vL2NvbnN0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xuY29uc3QgWmVzayA9IHJlcXVpcmUoXCIuL1plc2tcIik7XG5cbmZ1bmN0aW9uIHplcm8oeCkge1xuXHRpZiAoeCA8IDEwKSB7XG5cdFx0cmV0dXJuIFwiMFwiICsgeDtcblx0fVxuXHRyZXR1cm4gU3RyaW5nKHgpO1xufVxuXG52YXIgRGF0ZVRvb2xzID0ge1xuXHR0b1N0cmluZzogZnVuY3Rpb24oZCkge1xuXHRcdHJldHVybiAoXG5cdFx0XHRkLmdldFVUQ0Z1bGxZZWFyKCkgK1xuXHRcdFx0XCItXCIgK1xuXHRcdFx0emVybyhkLmdldFVUQ01vbnRoKCkgKyAxKSArXG5cdFx0XHRcIi1cIiArXG5cdFx0XHR6ZXJvKGQuZ2V0VVRDRGF0ZSgpKSArXG5cdFx0XHRcIiBcIiArXG5cdFx0XHR6ZXJvKGQuZ2V0VVRDSG91cnMoKSkgK1xuXHRcdFx0XCI6XCIgK1xuXHRcdFx0emVybyhkLmdldFVUQ01pbnV0ZXMoKSkgK1xuXHRcdFx0XCI6XCIgK1xuXHRcdFx0emVybyhkLmdldFVUQ1NlY29uZHMoKSlcblx0XHQpO1xuXHR9LFxuXHRNSUxMSVNFQ09ORDogXCJtaWxsaXNlY29uZFwiLFxuXHRTRUNPTkQ6IFwic2Vjb25kXCIsXG5cdE1JTlVURTogXCJtaW51dGVcIixcblx0SE9VUjogXCJob3VyXCIsXG5cdERBWTogXCJkYXlcIixcblx0V0VFSzogXCJ3ZWVrXCIsXG5cdFdFRUtEQVk6IFwid2Vla2RheVwiLFxuXHRNT05USDogXCJtb250aFwiLFxuXHRRVUFSVEVSOiBcInF1YXJ0ZXJcIixcblx0WUVBUjogXCJ5ZWFyXCIsXG5cblx0Zm9ybWF0dGluZzogZnVuY3Rpb24oZCwgbG9jYWxpemVyKSB7XG5cdFx0aWYgKCFsb2NhbGl6ZXIpIHtcblx0XHRcdGxvY2FsaXplciA9IGZ1bmN0aW9uKHgpIHtcblx0XHRcdFx0cmV0dXJuIHg7XG5cdFx0XHR9O1xuXHRcdH1cblx0XHRsZXQgaDEyID0gZC5nZXRVVENIb3VycygpICUgMTI7XG5cdFx0aWYgKGgxMiA9PT0gMCkge1xuXHRcdFx0aDEyID0gMTI7XG5cdFx0fVxuXHRcdHJldHVybiB7XG5cdFx0XHRZWVlZOiBkLmdldFVUQ0Z1bGxZZWFyKCksXG5cdFx0XHRNOiBkLmdldFVUQ01vbnRoKCkgKyAxLFxuXHRcdFx0TU06IHplcm8oZC5nZXRVVENNb250aCgpICsgMSksXG5cdFx0XHRNTU06IGxvY2FsaXplcihEYXRlVG9vbHMuc2hvcnRfbW9udGhzW2QuZ2V0VVRDTW9udGgoKV0pLFxuXHRcdFx0TU1NTTogbG9jYWxpemVyKERhdGVUb29scy5tb250aHNbZC5nZXRVVENNb250aCgpXSksXG5cdFx0XHRXOiBkLmdldFVUQ0RheSgpLFxuXHRcdFx0V1dXOiBsb2NhbGl6ZXIoRGF0ZVRvb2xzLnNob3J0X3dlZWtkYXlzW2QuZ2V0VVRDRGF5KCldKSxcblx0XHRcdFdXV1c6IGxvY2FsaXplcihEYXRlVG9vbHMud2Vla2RheXNbZC5nZXRVVENEYXkoKV0pLFxuXHRcdFx0RDogZC5nZXRVVENEYXRlKCksXG5cdFx0XHRERDogemVybyhkLmdldFVUQ0RhdGUoKSksXG5cdFx0XHRoOiBkLmdldFVUQ0hvdXJzKCksXG5cdFx0XHRoaDogemVybyhkLmdldFVUQ0hvdXJzKCkpLFxuXHRcdFx0XCIxMmhcIjogaDEyLFxuXHRcdFx0XCIxMmhoXCI6IHplcm8oaDEyKSxcblx0XHRcdG06IGQuZ2V0VVRDTWludXRlcygpLFxuXHRcdFx0bW06IHplcm8oZC5nZXRVVENNaW51dGVzKCkpLFxuXHRcdFx0czogZC5nZXRVVENTZWNvbmRzKCksXG5cdFx0XHRzczogemVybyhkLmdldFVUQ1NlY29uZHMoKSksXG5cdFx0fTtcblx0fSxcblx0Zm9ybWF0OiBmdW5jdGlvbihkLCBmb3JtYXQsIGxvY2FsaXplcikge1xuXHRcdHJldHVybiBaZXNrLm1hcChmb3JtYXQsIERhdGVUb29scy5mb3JtYXR0aW5nKGQsIGxvY2FsaXplcikpO1xuXHR9LFxufTtcblxuY29uc3QgU0VDT05EU19JTl9NSU5VVEUgPSA2MDtcbmNvbnN0IE1JTlVURVNfSU5fSE9VUiA9IDYwO1xuY29uc3QgSE9VUlNfSU5fREFZID0gMjQ7XG5jb25zdCBEQVlTX1BFUl9XRUVLID0gNztcbmNvbnN0IERBWVNfSU5fWUVBUiA9IDM2NTtcbmNvbnN0IE1PTlRIU19JTl9ZRUFSID0gMTI7XG5jb25zdCBRVUFSVEVSU19JTl9ZRUFSID0gNDtcblxuY29uc3QgU0VDT05EU19JTl9IT1VSID0gU0VDT05EU19JTl9NSU5VVEUgKiBNSU5VVEVTX0lOX0hPVVI7XG5jb25zdCBTRUNPTkRTX0lOX0RBWSA9IFNFQ09ORFNfSU5fSE9VUiAqIEhPVVJTX0lOX0RBWTtcbmNvbnN0IFNFQ09ORFNfSU5fV0VFSyA9IFNFQ09ORFNfSU5fREFZICogREFZU19QRVJfV0VFSztcbmNvbnN0IFNFQ09ORFNfSU5fWUVBUiA9IFNFQ09ORFNfSU5fREFZICogREFZU19JTl9ZRUFSO1xuXG5EYXRlVG9vbHMudW5pdHMgPSB7XG5cdFtEYXRlVG9vbHMuTUlMTElTRUNPTkRdOiAwLjAwMSxcblx0W0RhdGVUb29scy5TRUNPTkRdOiAxLFxuXHRbRGF0ZVRvb2xzLk1JTlVURV06IFNFQ09ORFNfSU5fTUlOVVRFLFxuXHRbRGF0ZVRvb2xzLkhPVVJdOiBTRUNPTkRTX0lOX0hPVVIsXG5cdFtEYXRlVG9vbHMuREFZXTogU0VDT05EU19JTl9EQVksXG5cdFtEYXRlVG9vbHMuV0VFS106IFNFQ09ORFNfSU5fV0VFSyxcblx0W0RhdGVUb29scy5ZRUFSXTogU0VDT05EU19JTl9ZRUFSLFxuXHRbRGF0ZVRvb2xzLk1PTlRIXTogU0VDT05EU19JTl9ZRUFSIC8gTU9OVEhTX0lOX1lFQVIsXG5cdFtEYXRlVG9vbHMuUVVBUlRFUl06IFNFQ09ORFNfSU5fWUVBUiAvIFFVQVJURVJTX0lOX1lFQVIsXG59O1xuRGF0ZVRvb2xzLnVuaXRzT3JkZXIgPSBbXG5cdERhdGVUb29scy5NSUxMSVNFQ09ORCxcblx0RGF0ZVRvb2xzLlNFQ09ORCxcblx0RGF0ZVRvb2xzLk1JTlVURSxcblx0RGF0ZVRvb2xzLkhPVVIsXG5cdERhdGVUb29scy5EQVksXG5cdERhdGVUb29scy5XRUVLLFxuXHREYXRlVG9vbHMuTU9OVEgsXG5cdERhdGVUb29scy5ZRUFSLFxuXTtcblxuY29uc3Qgc3VidHJhY3QgPSBmdW5jdGlvbihzb3VyY2UsIHRpbWVzdGFtcCkge1xuXHRyZXR1cm4gc291cmNlLmdldFRpbWUoKSAtIHRpbWVzdGFtcC5nZXRUaW1lKCk7XG59O1xuXG5jb25zdCBkaWZmZXJlbmNlID0gZnVuY3Rpb24oc291cmNlLCB0aW1lc3RhbXAsIHVuaXQgPSBEYXRlVG9vbHMuU0VDT05ELCBwcmVjaXNpb24gPSAwKSB7XG5cdGlmICh0aW1lc3RhbXAuZ2V0VGltZSgpID4gc291cmNlLmdldFRpbWUoKSkge1xuXHRcdHJldHVybiAtZGlmZmVyZW5jZSh0aW1lc3RhbXAsIHNvdXJjZSwgdW5pdCwgcHJlY2lzaW9uKTtcblx0fVxuXHRpZiAodW5pdCA9PT0gRGF0ZVRvb2xzLldFRUtEQVkpIHtcblx0XHRyZXR1cm4gc291cmNlLmdldFVUQ0RheSgpIC0gdGltZXN0YW1wLmdldFVUQ0RheSgpO1xuXHR9XG5cdGxldCBkZWx0YSA9IHN1YnRyYWN0KHNvdXJjZSwgdGltZXN0YW1wKTtcblx0ZGVsdGEgKj0gMC4wMDE7XG5cdHN3aXRjaCAodW5pdCkge1xuXHRcdGNhc2UgRGF0ZVRvb2xzLk1JTExJU0VDT05EOlxuXHRcdFx0cmV0dXJuIGRlbHRhICogMTAwMDtcblx0XHRjYXNlIERhdGVUb29scy5TRUNPTkQ6XG5cdFx0XHRyZXR1cm4gZGVsdGE7XG5cdFx0Y2FzZSBEYXRlVG9vbHMuTUlOVVRFOlxuXHRcdFx0cmV0dXJuIE1hdGgucm91bmQoZGVsdGEgLyA2MC4wLCBwcmVjaXNpb24pO1xuXHRcdGNhc2UgRGF0ZVRvb2xzLkhPVVI6XG5cdFx0XHRyZXR1cm4gTWF0aC5yb3VuZChkZWx0YSAvIDM2MDAuMCwgcHJlY2lzaW9uKTtcblx0XHRjYXNlIERhdGVUb29scy5EQVk6XG5cdFx0XHRyZXR1cm4gTWF0aC5yb3VuZChkZWx0YSAvIDg2NDAwLCBwcmVjaXNpb24pO1xuXHRcdGNhc2UgRGF0ZVRvb2xzLldFRUs6XG5cdFx0XHRyZXR1cm4gTWF0aC5yb3VuZChkZWx0YSAvICg4NjQwMCAqIDcpLCBwcmVjaXNpb24pO1xuXHR9XG5cblx0bGV0IG1zdGFydCA9IHRpbWVzdGFtcC5nZXRVVENNb250aCgpLFxuXHRcdHlzdGFydCA9IHRpbWVzdGFtcC5nZXRVVENGdWxsWWVhcigpO1xuXG5cdGxldCBtZW5kID0gc291cmNlLmdldFVUQ01vbnRoKCksXG5cdFx0eWVuZCA9IHNvdXJjZS5nZXRVVENGdWxsWWVhcigpO1xuXG5cdGlmIChwcmVjaXNpb24gPT09IDApIHtcblx0XHRzd2l0Y2ggKHVuaXQpIHtcblx0XHRcdGNhc2UgRGF0ZVRvb2xzLk1PTlRIOlxuXHRcdFx0XHRyZXR1cm4gKHllbmQgLSB5c3RhcnQpICogMTIgKyAobWVuZCAtIG1zdGFydCk7XG5cdFx0XHRjYXNlIERhdGVUb29scy5RVUFSVEVSOlxuXHRcdFx0XHRtZW5kID0gcGFyc2VJbnQobWVuZCAvIDQsIDEwKTtcblx0XHRcdFx0bXN0YXJ0ID0gcGFyc2VJbnQobXN0YXJ0IC8gNCwgMTApO1xuXHRcdFx0XHRyZXR1cm4gKHllbmQgLSB5c3RhcnQpICogNCArIChtZW5kIC0gbXN0YXJ0KTtcblx0XHRcdGNhc2UgRGF0ZVRvb2xzLllFQVI6XG5cdFx0XHRcdHJldHVybiB5ZW5kIC0geXN0YXJ0O1xuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiRGF0ZVRvb2xzLmRpZmZlcmVuY2UoXCIgKyBzb3VyY2UgKyBcIixcIiArIHRpbWVzdGFtcCArIFwiLFwiICsgdW5pdCArIFwiKTogQmFkIHVuaXRcIik7XG5cdFx0fVxuXHR9IGVsc2Uge1xuXHRcdC8vIFdvcmtzIGxpa2Ugc286XG5cdFx0Ly9cblx0XHQvLyAyLzIyIC0+IDMvMjIgPSAxIG1vbnRoXG5cdFx0Ly8gMi8xMiAtPiAzLzIyID0gMSBtb250aCArICgoMy8yMi0yLzIyKSAvIDI4KVxuXG5cdFx0bGV0IGludG1vbiA9ICh5ZW5kIC0geXN0YXJ0KSAqIDEyICsgKG1lbmQgLSBtc3RhcnQpO1xuXHRcdGxldCB0b3RhbCA9IERhdGVUb29scy5kYXlzX2luX21vbnRoKG1zdGFydCwgeXN0YXJ0KTtcblxuXHRcdGxldCB0ZW1wID0gbmV3IERhdGUoKTtcblx0XHR0ZW1wLnNldFRpbWUodGltZXN0YW1wLmdldFRpbWUoKSk7XG5cdFx0dGVtcC5zZXRNb250aChtc3RhcnQpO1xuXHRcdHRlbXAuc2V0WWVhcih5c3RhcnQpO1xuXG5cdFx0bGV0IHJlc3VsdCA9IG51bGwsXG5cdFx0XHRmcmFjdCA9IHN1YnRyYWN0KHRlbXAsIHNvdXJjZSk7XG5cdFx0ZnJhY3QgPSBmcmFjdCAvIHBhcnNlRmxvYXQodG90YWwgKiA4NjQwMCk7XG5cblx0XHRzd2l0Y2ggKHVuaXQpIHtcblx0XHRcdGNhc2UgRGF0ZVRvb2xzLk1PTlRIOlxuXHRcdFx0XHRyZXN1bHQgPSBNYXRoLnJvdW5kKGludG1vbiArIGZyYWN0LCBwcmVjaXNpb24pO1xuXG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSBEYXRlVG9vbHMuUVVBUlRFUjpcblx0XHRcdFx0cmVzdWx0ID0gTWF0aC5yb3VuZCgoaW50bW9uICsgZnJhY3QpIC8gMywgcHJlY2lzaW9uKTtcblxuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgRGF0ZVRvb2xzLllFQVI6XG5cdFx0XHRcdHJlc3VsdCA9IE1hdGgucm91bmQoKGludG1vbiArIGZyYWN0KSAvIDEyLCBwcmVjaXNpb24pO1xuXG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiRGF0ZVRvb2xzLmRpZmZlcmVuY2UoXCIgKyBzb3VyY2UgKyBcIixcIiArIHRpbWVzdGFtcCArIFwiLFwiICsgdW5pdCArIFwiKTogQmFkIHVuaXRcIik7XG5cdFx0fVxuXHRcdHJldHVybiByZXN1bHQ7XG5cdH1cbn07XG5EYXRlVG9vbHMuZGlmZmVyZW5jZSA9IGRpZmZlcmVuY2U7XG5cbkRhdGVUb29scy5maW5kVW5pdCA9IGZ1bmN0aW9uKHNlY29uZHMpIHtcblx0bGV0IHJlc3VsdCA9IERhdGVUb29scy5ZRUFSO1xuXHRjb25zdCB1bml0cyA9IERhdGVUb29scy51bml0cztcblx0WmVzay5lYWNoKERhdGVUb29scy51bml0c09yZGVyLCBmdW5jdGlvbigpIHtcblx0XHRsZXQgc2VjID0gdW5pdHNbdGhpc107XG5cdFx0aWYgKHNlY29uZHMgPCBzZWMpIHtcblx0XHRcdHJldHVybiB0cnVlO1xuXHRcdH1cblx0XHRyZXN1bHQgPSB0aGlzO1xuXHR9KTtcblx0cmV0dXJuIHJlc3VsdDtcbn07XG5cbkRhdGVUb29scy50b1VuaXQgPSBmdW5jdGlvbihzZWNvbmRzLCB1bml0KSB7XG5cdGlmICghRGF0ZVRvb2xzLnVuaXRzW3VuaXRdKSB7XG5cdFx0dGhyb3cgbmV3IEVycm9yKFwiVW5rbm93biB1bml0IFwiICsgdW5pdCArIFwiIGluIERhdGVUb29scy50b1VuaXRcIik7XG5cdH1cblx0cmV0dXJuIHBhcnNlRmxvYXQoc2Vjb25kcykgLyBEYXRlVG9vbHMudW5pdHNbdW5pdF07XG59O1xuXG5jb25zdCBtb250aHMgPSBmdW5jdGlvbigpIHtcblx0bGV0IG0gPSBbXSxcblx0XHRkID0gbmV3IERhdGUoKTtcblx0bS5sZW5ndGggPSBNT05USFNfSU5fWUVBUjtcblx0cmV0dXJuIG0uZmlsbCgwKS5tYXAoZnVuY3Rpb24oYSwgaSkge1xuXHRcdGQuc2V0VVRDRGF0ZSgxKTtcblx0XHRkLnNldFVUQ01vbnRoKGkpO1xuXHRcdHJldHVybiBkLnRvRGF0ZVN0cmluZygpLnNwbGl0KFwiIFwiKVsxXTtcblx0fSk7XG59O1xuXG5EYXRlVG9vbHMubW9udGhzID0gRGF0ZVRvb2xzLnNob3J0X21vbnRocyA9IG1vbnRocygpO1xuXG5jb25zdCB3ZWVrZGF5cyA9IGZ1bmN0aW9uKCkge1xuXHRsZXQgbSA9IFtdLFxuXHRcdGQgPSBuZXcgRGF0ZSgpLFxuXHRcdGluaXQ7XG5cdGQuc2V0VVRDRnVsbFllYXIoMjAxOSk7XG5cdGQuc2V0VVRDRGF0ZSgxOSk7XG5cdGQuc2V0VVRDTW9udGgoMyk7IC8vIFN1bmRheVxuXHRkLnNldFVUQ0hvdXJzKDApO1xuXG5cdGQuc2V0VVRDU2Vjb25kcygwKTtcblxuXHRpbml0ID0gZC5nZXRUaW1lKCk7XG5cdG0ubGVuZ3RoID0gREFZU19QRVJfV0VFSztcblx0cmV0dXJuIG0uZmlsbCgwKS5tYXAoZnVuY3Rpb24oYSwgaSkge1xuXHRcdGQuc2V0VGltZShpbml0ICsgODY0MDAgKiAxMDAwICogaSk7XG5cdFx0cmV0dXJuIGQudG9EYXRlU3RyaW5nKCkuc3BsaXQoXCIgXCIpWzBdO1xuXHR9KTtcbn07XG5EYXRlVG9vbHMud2Vla2RheXMgPSBEYXRlVG9vbHMuc2hvcnRfd2Vla2RheXMgPSB3ZWVrZGF5cygpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IERhdGVUb29scztcbiJdfQ==