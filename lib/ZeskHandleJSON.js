"use strict";

/**
 * Copyright &copy; 2017 Market Acumen, Inc.
 */

var $ = require("jquery");
var Zesk = require("./Zesk");

module.exports = function (data) {
	var total = 0,
	    success = function success() {
		--total;
		if (total === 0) {
			if (data.ready) {
				$.each(data.ready, function () {
					/* Zesk.log("evaluating " + this); */
					$.globalEval(this);
				});
			}
			if (data.location) {
				document.location = data.location;
			}
		}
	},
	    error = function error(jqXHR) {
		console.log("Request failed", jqXHR);
		success();
	};
	$.each({
		head: data.head_tags || [],
		body: data.body_tags || []
	}, function (append) {
		var tags = this;
		$.each(tags, function () {
			var tag = this,
			    name = tag.name,
			    attrs = tag.attributes || {},
			    content = tag.content || null;
			$(append).append(HTML.tag(name, attrs, content));
		});
	});
	if (data.stylesheets) {
		$.each(data.stylesheets, function () {
			var tag = this,
			    name = tag.name,
			    attrs = tag.attributes || {},
			    content = tag.content || null;
			if (name === "link") {
				if (attrs.href && Zesk.stylesheet_loaded(attrs.href, attrs.media)) {
					return;
				}
				Zesk.log("Loading stylesheet " + attrs.href + "(media=" + attrs.media + ")");
			}
			$("head").append(HTML.tag(name, attrs, content));
		});
	}
	if (data.scripts) {
		$.each(data.scripts, function () {
			if (!Zesk.script_loaded(this)) {
				Zesk.log("Loading " + this);
				total++;
				Zesk.page_scripts[this] = this;
				$.ajax({
					url: this,
					dataType: "script",
					success: success,
					error: error,
					async: false
				});
			}
		});
	}
	if (data.message) {
		if (is_array(data.message)) {
			$.each(data.message, function () {
				Zesk.message(this, data.message_options || {});
			});
		} else {
			Zesk.message(data.message);
		}
	}
	total++;
	success();
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9aZXNrSGFuZGxlSlNPTi5qcyJdLCJuYW1lcyI6WyIkIiwicmVxdWlyZSIsIlplc2siLCJtb2R1bGUiLCJleHBvcnRzIiwiZGF0YSIsInRvdGFsIiwic3VjY2VzcyIsInJlYWR5IiwiZWFjaCIsImdsb2JhbEV2YWwiLCJsb2NhdGlvbiIsImRvY3VtZW50IiwiZXJyb3IiLCJqcVhIUiIsImNvbnNvbGUiLCJsb2ciLCJoZWFkIiwiaGVhZF90YWdzIiwiYm9keSIsImJvZHlfdGFncyIsImFwcGVuZCIsInRhZ3MiLCJ0YWciLCJuYW1lIiwiYXR0cnMiLCJhdHRyaWJ1dGVzIiwiY29udGVudCIsIkhUTUwiLCJzdHlsZXNoZWV0cyIsImhyZWYiLCJzdHlsZXNoZWV0X2xvYWRlZCIsIm1lZGlhIiwic2NyaXB0cyIsInNjcmlwdF9sb2FkZWQiLCJwYWdlX3NjcmlwdHMiLCJhamF4IiwidXJsIiwiZGF0YVR5cGUiLCJhc3luYyIsIm1lc3NhZ2UiLCJpc19hcnJheSIsIm1lc3NhZ2Vfb3B0aW9ucyJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7OztBQUlBLElBQU1BLElBQUlDLFFBQVEsUUFBUixDQUFWO0FBQ0EsSUFBTUMsT0FBT0QsUUFBUSxRQUFSLENBQWI7O0FBRUFFLE9BQU9DLE9BQVAsR0FBaUIsVUFBU0MsSUFBVCxFQUFlO0FBQy9CLEtBQUlDLFFBQVEsQ0FBWjtBQUFBLEtBQ0NDLFVBQVUsU0FBVkEsT0FBVSxHQUFXO0FBQ3BCLElBQUVELEtBQUY7QUFDQSxNQUFJQSxVQUFVLENBQWQsRUFBaUI7QUFDaEIsT0FBSUQsS0FBS0csS0FBVCxFQUFnQjtBQUNmUixNQUFFUyxJQUFGLENBQU9KLEtBQUtHLEtBQVosRUFBbUIsWUFBVztBQUM3QjtBQUNBUixPQUFFVSxVQUFGLENBQWEsSUFBYjtBQUNBLEtBSEQ7QUFJQTtBQUNELE9BQUlMLEtBQUtNLFFBQVQsRUFBbUI7QUFDbEJDLGFBQVNELFFBQVQsR0FBb0JOLEtBQUtNLFFBQXpCO0FBQ0E7QUFDRDtBQUNELEVBZEY7QUFBQSxLQWVDRSxRQUFRLFNBQVJBLEtBQVEsQ0FBU0MsS0FBVCxFQUFnQjtBQUN2QkMsVUFBUUMsR0FBUixDQUFZLGdCQUFaLEVBQThCRixLQUE5QjtBQUNBUDtBQUNBLEVBbEJGO0FBbUJBUCxHQUFFUyxJQUFGLENBQ0M7QUFDQ1EsUUFBTVosS0FBS2EsU0FBTCxJQUFrQixFQUR6QjtBQUVDQyxRQUFNZCxLQUFLZSxTQUFMLElBQWtCO0FBRnpCLEVBREQsRUFLQyxVQUFTQyxNQUFULEVBQWlCO0FBQ2hCLE1BQUlDLE9BQU8sSUFBWDtBQUNBdEIsSUFBRVMsSUFBRixDQUFPYSxJQUFQLEVBQWEsWUFBVztBQUN2QixPQUFJQyxNQUFNLElBQVY7QUFBQSxPQUNDQyxPQUFPRCxJQUFJQyxJQURaO0FBQUEsT0FFQ0MsUUFBUUYsSUFBSUcsVUFBSixJQUFrQixFQUYzQjtBQUFBLE9BR0NDLFVBQVVKLElBQUlJLE9BQUosSUFBZSxJQUgxQjtBQUlBM0IsS0FBRXFCLE1BQUYsRUFBVUEsTUFBVixDQUFpQk8sS0FBS0wsR0FBTCxDQUFTQyxJQUFULEVBQWVDLEtBQWYsRUFBc0JFLE9BQXRCLENBQWpCO0FBQ0EsR0FORDtBQU9BLEVBZEY7QUFnQkEsS0FBSXRCLEtBQUt3QixXQUFULEVBQXNCO0FBQ3JCN0IsSUFBRVMsSUFBRixDQUFPSixLQUFLd0IsV0FBWixFQUF5QixZQUFXO0FBQ25DLE9BQUlOLE1BQU0sSUFBVjtBQUFBLE9BQ0NDLE9BQU9ELElBQUlDLElBRFo7QUFBQSxPQUVDQyxRQUFRRixJQUFJRyxVQUFKLElBQWtCLEVBRjNCO0FBQUEsT0FHQ0MsVUFBVUosSUFBSUksT0FBSixJQUFlLElBSDFCO0FBSUEsT0FBSUgsU0FBUyxNQUFiLEVBQXFCO0FBQ3BCLFFBQUlDLE1BQU1LLElBQU4sSUFBYzVCLEtBQUs2QixpQkFBTCxDQUF1Qk4sTUFBTUssSUFBN0IsRUFBbUNMLE1BQU1PLEtBQXpDLENBQWxCLEVBQW1FO0FBQ2xFO0FBQ0E7QUFDRDlCLFNBQUtjLEdBQUwsQ0FBUyx3QkFBd0JTLE1BQU1LLElBQTlCLEdBQXFDLFNBQXJDLEdBQWlETCxNQUFNTyxLQUF2RCxHQUErRCxHQUF4RTtBQUNBO0FBQ0RoQyxLQUFFLE1BQUYsRUFBVXFCLE1BQVYsQ0FBaUJPLEtBQUtMLEdBQUwsQ0FBU0MsSUFBVCxFQUFlQyxLQUFmLEVBQXNCRSxPQUF0QixDQUFqQjtBQUNBLEdBWkQ7QUFhQTtBQUNELEtBQUl0QixLQUFLNEIsT0FBVCxFQUFrQjtBQUNqQmpDLElBQUVTLElBQUYsQ0FBT0osS0FBSzRCLE9BQVosRUFBcUIsWUFBVztBQUMvQixPQUFJLENBQUMvQixLQUFLZ0MsYUFBTCxDQUFtQixJQUFuQixDQUFMLEVBQStCO0FBQzlCaEMsU0FBS2MsR0FBTCxDQUFTLGFBQWEsSUFBdEI7QUFDQVY7QUFDQUosU0FBS2lDLFlBQUwsQ0FBa0IsSUFBbEIsSUFBMEIsSUFBMUI7QUFDQW5DLE1BQUVvQyxJQUFGLENBQU87QUFDTkMsVUFBSyxJQURDO0FBRU5DLGVBQVUsUUFGSjtBQUdOL0IsY0FBU0EsT0FISDtBQUlOTSxZQUFPQSxLQUpEO0FBS04wQixZQUFPO0FBTEQsS0FBUDtBQU9BO0FBQ0QsR0FiRDtBQWNBO0FBQ0QsS0FBSWxDLEtBQUttQyxPQUFULEVBQWtCO0FBQ2pCLE1BQUlDLFNBQVNwQyxLQUFLbUMsT0FBZCxDQUFKLEVBQTRCO0FBQzNCeEMsS0FBRVMsSUFBRixDQUFPSixLQUFLbUMsT0FBWixFQUFxQixZQUFXO0FBQy9CdEMsU0FBS3NDLE9BQUwsQ0FBYSxJQUFiLEVBQW1CbkMsS0FBS3FDLGVBQUwsSUFBd0IsRUFBM0M7QUFDQSxJQUZEO0FBR0EsR0FKRCxNQUlPO0FBQ054QyxRQUFLc0MsT0FBTCxDQUFhbkMsS0FBS21DLE9BQWxCO0FBQ0E7QUFDRDtBQUNEbEM7QUFDQUM7QUFDQSxDQTlFRCIsImZpbGUiOiJaZXNrSGFuZGxlSlNPTi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0ICZjb3B5OyAyMDE3IE1hcmtldCBBY3VtZW4sIEluYy5cbiAqL1xuXG5jb25zdCAkID0gcmVxdWlyZShcImpxdWVyeVwiKTtcbmNvbnN0IFplc2sgPSByZXF1aXJlKFwiLi9aZXNrXCIpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGRhdGEpIHtcblx0dmFyIHRvdGFsID0gMCxcblx0XHRzdWNjZXNzID0gZnVuY3Rpb24oKSB7XG5cdFx0XHQtLXRvdGFsO1xuXHRcdFx0aWYgKHRvdGFsID09PSAwKSB7XG5cdFx0XHRcdGlmIChkYXRhLnJlYWR5KSB7XG5cdFx0XHRcdFx0JC5lYWNoKGRhdGEucmVhZHksIGZ1bmN0aW9uKCkge1xuXHRcdFx0XHRcdFx0LyogWmVzay5sb2coXCJldmFsdWF0aW5nIFwiICsgdGhpcyk7ICovXG5cdFx0XHRcdFx0XHQkLmdsb2JhbEV2YWwodGhpcyk7XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH1cblx0XHRcdFx0aWYgKGRhdGEubG9jYXRpb24pIHtcblx0XHRcdFx0XHRkb2N1bWVudC5sb2NhdGlvbiA9IGRhdGEubG9jYXRpb247XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9LFxuXHRcdGVycm9yID0gZnVuY3Rpb24oanFYSFIpIHtcblx0XHRcdGNvbnNvbGUubG9nKFwiUmVxdWVzdCBmYWlsZWRcIiwganFYSFIpO1xuXHRcdFx0c3VjY2VzcygpO1xuXHRcdH07XG5cdCQuZWFjaChcblx0XHR7XG5cdFx0XHRoZWFkOiBkYXRhLmhlYWRfdGFncyB8fCBbXSxcblx0XHRcdGJvZHk6IGRhdGEuYm9keV90YWdzIHx8IFtdLFxuXHRcdH0sXG5cdFx0ZnVuY3Rpb24oYXBwZW5kKSB7XG5cdFx0XHR2YXIgdGFncyA9IHRoaXM7XG5cdFx0XHQkLmVhY2godGFncywgZnVuY3Rpb24oKSB7XG5cdFx0XHRcdHZhciB0YWcgPSB0aGlzLFxuXHRcdFx0XHRcdG5hbWUgPSB0YWcubmFtZSxcblx0XHRcdFx0XHRhdHRycyA9IHRhZy5hdHRyaWJ1dGVzIHx8IHt9LFxuXHRcdFx0XHRcdGNvbnRlbnQgPSB0YWcuY29udGVudCB8fCBudWxsO1xuXHRcdFx0XHQkKGFwcGVuZCkuYXBwZW5kKEhUTUwudGFnKG5hbWUsIGF0dHJzLCBjb250ZW50KSk7XG5cdFx0XHR9KTtcblx0XHR9XG5cdCk7XG5cdGlmIChkYXRhLnN0eWxlc2hlZXRzKSB7XG5cdFx0JC5lYWNoKGRhdGEuc3R5bGVzaGVldHMsIGZ1bmN0aW9uKCkge1xuXHRcdFx0dmFyIHRhZyA9IHRoaXMsXG5cdFx0XHRcdG5hbWUgPSB0YWcubmFtZSxcblx0XHRcdFx0YXR0cnMgPSB0YWcuYXR0cmlidXRlcyB8fCB7fSxcblx0XHRcdFx0Y29udGVudCA9IHRhZy5jb250ZW50IHx8IG51bGw7XG5cdFx0XHRpZiAobmFtZSA9PT0gXCJsaW5rXCIpIHtcblx0XHRcdFx0aWYgKGF0dHJzLmhyZWYgJiYgWmVzay5zdHlsZXNoZWV0X2xvYWRlZChhdHRycy5ocmVmLCBhdHRycy5tZWRpYSkpIHtcblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdH1cblx0XHRcdFx0WmVzay5sb2coXCJMb2FkaW5nIHN0eWxlc2hlZXQgXCIgKyBhdHRycy5ocmVmICsgXCIobWVkaWE9XCIgKyBhdHRycy5tZWRpYSArIFwiKVwiKTtcblx0XHRcdH1cblx0XHRcdCQoXCJoZWFkXCIpLmFwcGVuZChIVE1MLnRhZyhuYW1lLCBhdHRycywgY29udGVudCkpO1xuXHRcdH0pO1xuXHR9XG5cdGlmIChkYXRhLnNjcmlwdHMpIHtcblx0XHQkLmVhY2goZGF0YS5zY3JpcHRzLCBmdW5jdGlvbigpIHtcblx0XHRcdGlmICghWmVzay5zY3JpcHRfbG9hZGVkKHRoaXMpKSB7XG5cdFx0XHRcdFplc2subG9nKFwiTG9hZGluZyBcIiArIHRoaXMpO1xuXHRcdFx0XHR0b3RhbCsrO1xuXHRcdFx0XHRaZXNrLnBhZ2Vfc2NyaXB0c1t0aGlzXSA9IHRoaXM7XG5cdFx0XHRcdCQuYWpheCh7XG5cdFx0XHRcdFx0dXJsOiB0aGlzLFxuXHRcdFx0XHRcdGRhdGFUeXBlOiBcInNjcmlwdFwiLFxuXHRcdFx0XHRcdHN1Y2Nlc3M6IHN1Y2Nlc3MsXG5cdFx0XHRcdFx0ZXJyb3I6IGVycm9yLFxuXHRcdFx0XHRcdGFzeW5jOiBmYWxzZSxcblx0XHRcdFx0fSk7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblx0aWYgKGRhdGEubWVzc2FnZSkge1xuXHRcdGlmIChpc19hcnJheShkYXRhLm1lc3NhZ2UpKSB7XG5cdFx0XHQkLmVhY2goZGF0YS5tZXNzYWdlLCBmdW5jdGlvbigpIHtcblx0XHRcdFx0WmVzay5tZXNzYWdlKHRoaXMsIGRhdGEubWVzc2FnZV9vcHRpb25zIHx8IHt9KTtcblx0XHRcdH0pO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRaZXNrLm1lc3NhZ2UoZGF0YS5tZXNzYWdlKTtcblx0XHR9XG5cdH1cblx0dG90YWwrKztcblx0c3VjY2VzcygpO1xufTtcbiJdfQ==