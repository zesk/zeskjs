"use strict";

/**
* Copyright &copy; 2017 Market Acumen, Inc.
*/

var $ = require("jquery");
var Zesk = require("./Zesk");

module.exports = function(data) {
	var total = 0,
		success = function success() {
			--total;
			if (total === 0) {
				if (data.ready) {
					$.each(data.ready, function() {
						/* Zesk.log("evaluating " + this); */
						$.globalEval(this);
					});
				}
				if (data.location) {
					document.location = data.location;
				}
			}
		},
		error = function error(jqXHR) {
			console.log("Request failed", jqXHR);
			success();
		};
	$.each(
		{
			head: data.head_tags || [],
			body: data.body_tags || [],
		},
		function(append) {
			var tags = this;
			$.each(tags, function() {
				var tag = this,
					name = tag.name,
					attrs = tag.attributes || {},
					content = tag.content || null;
				$(append).append(HTML.tag(name, attrs, content));
			});
		}
	);
	if (data.stylesheets) {
		$.each(data.stylesheets, function() {
			var tag = this,
				name = tag.name,
				attrs = tag.attributes || {},
				content = tag.content || null;
			if (name === "link") {
				if (attrs.href && Zesk.stylesheet_loaded(attrs.href, attrs.media)) {
					return;
				}
				Zesk.log("Loading stylesheet " + attrs.href + "(media=" + attrs.media + ")");
			}
			$("head").append(HTML.tag(name, attrs, content));
		});
	}
	if (data.scripts) {
		$.each(data.scripts, function() {
			if (!Zesk.script_loaded(this)) {
				Zesk.log("Loading " + this);
				total++;
				Zesk.page_scripts[this] = this;
				$.ajax({
					url: this,
					dataType: "script",
					success: success,
					error: error,
					async: false,
				});
			}
		});
	}
	if (data.message) {
		if (is_array(data.message)) {
			$.each(data.message, function() {
				Zesk.message(this, data.message_options || {});
			});
		} else {
			Zesk.message(data.message);
		}
	}
	total++;
	success();
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9aZXNrSGFuZGxlSlNPTi5qcyJdLCJuYW1lcyI6WyIkIiwicmVxdWlyZSIsIlplc2siLCJtb2R1bGUiLCJleHBvcnRzIiwiZGF0YSIsInRvdGFsIiwic3VjY2VzcyIsInJlYWR5IiwiZWFjaCIsImdsb2JhbEV2YWwiLCJsb2NhdGlvbiIsImRvY3VtZW50IiwiZXJyb3IiLCJqcVhIUiIsImNvbnNvbGUiLCJsb2ciLCJoZWFkX3RhZ3MiLCJib2R5X3RhZ3MiLCJhcHBlbmQiLCJ0YWdzIiwidGFnIiwibmFtZSIsImF0dHJzIiwiYXR0cmlidXRlcyIsImNvbnRlbnQiLCJIVE1MIiwic3R5bGVzaGVldHMiLCJocmVmIiwic3R5bGVzaGVldF9sb2FkZWQiLCJtZWRpYSIsInNjcmlwdHMiLCJzY3JpcHRfbG9hZGVkIiwicGFnZV9zY3JpcHRzIiwiYWpheCIsInVybCIsImRhdGFUeXBlIiwiYXN5bmMiLCJtZXNzYWdlIiwiaXNfYXJyYXkiLCJtZXNzYWdlX29wdGlvbnMiXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7QUFJQSxJQUFNQSxJQUFJQyxRQUFRLFFBQVIsQ0FBVjtBQUNBLElBQU1DLE9BQU9ELFFBQVEsUUFBUixDQUFiOztBQUVBRSxPQUFPQyxPQUFQLEdBQWlCLFVBQVNDLElBQVQsRUFBZTtBQUM1QixLQUFJQyxRQUFRLENBQVo7QUFBQSxLQUFlQyxVQUFVLFNBQVZBLE9BQVUsR0FBVztBQUNuQyxJQUFFRCxLQUFGO0FBQ0EsTUFBSUEsVUFBVSxDQUFkLEVBQWlCO0FBQ2hCLE9BQUlELEtBQUtHLEtBQVQsRUFBZ0I7QUFDZlIsTUFBRVMsSUFBRixDQUFPSixLQUFLRyxLQUFaLEVBQW1CLFlBQVc7QUFDN0I7QUFDQVIsT0FBRVUsVUFBRixDQUFhLElBQWI7QUFDQSxLQUhEO0FBSUE7QUFDRCxPQUFJTCxLQUFLTSxRQUFULEVBQW1CO0FBQ2xCQyxhQUFTRCxRQUFULEdBQW9CTixLQUFLTSxRQUF6QjtBQUNBO0FBQ0Q7QUFDRCxFQWJEO0FBQUEsS0FhR0UsUUFBUSxTQUFSQSxLQUFRLENBQVNDLEtBQVQsRUFBZ0I7QUFDMUJDLFVBQVFDLEdBQVIsQ0FBWSxnQkFBWixFQUE4QkYsS0FBOUI7QUFDQVA7QUFDQSxFQWhCRDtBQWlCQVAsR0FBRVMsSUFBRixDQUFPO0FBQ0gsVUFBUUosS0FBS1ksU0FBTCxJQUFrQixFQUR2QjtBQUVILFVBQVFaLEtBQUthLFNBQUwsSUFBa0I7QUFGdkIsRUFBUCxFQUdHLFVBQVNDLE1BQVQsRUFBaUI7QUFDbkIsTUFBSUMsT0FBTyxJQUFYO0FBQ0FwQixJQUFFUyxJQUFGLENBQU9XLElBQVAsRUFBYSxZQUFXO0FBQ3ZCLE9BQUlDLE1BQU0sSUFBVjtBQUFBLE9BQWdCQyxPQUFPRCxJQUFJQyxJQUEzQjtBQUFBLE9BQWlDQyxRQUFRRixJQUFJRyxVQUFKLElBQWtCLEVBQTNEO0FBQUEsT0FBK0RDLFVBQVVKLElBQUlJLE9BQUosSUFBZSxJQUF4RjtBQUNBekIsS0FBRW1CLE1BQUYsRUFBVUEsTUFBVixDQUFpQk8sS0FBS0wsR0FBTCxDQUFTQyxJQUFULEVBQWVDLEtBQWYsRUFBc0JFLE9BQXRCLENBQWpCO0FBQ0EsR0FIRDtBQUlBLEVBVEQ7QUFVQSxLQUFJcEIsS0FBS3NCLFdBQVQsRUFBc0I7QUFDckIzQixJQUFFUyxJQUFGLENBQU9KLEtBQUtzQixXQUFaLEVBQXlCLFlBQVc7QUFDbkMsT0FBSU4sTUFBTSxJQUFWO0FBQUEsT0FBZ0JDLE9BQU9ELElBQUlDLElBQTNCO0FBQUEsT0FBaUNDLFFBQVFGLElBQUlHLFVBQUosSUFBa0IsRUFBM0Q7QUFBQSxPQUErREMsVUFBVUosSUFBSUksT0FBSixJQUFlLElBQXhGO0FBQ0EsT0FBSUgsU0FBUyxNQUFiLEVBQXFCO0FBQ3BCLFFBQUlDLE1BQU1LLElBQU4sSUFBYzFCLEtBQUsyQixpQkFBTCxDQUF1Qk4sTUFBTUssSUFBN0IsRUFBbUNMLE1BQU1PLEtBQXpDLENBQWxCLEVBQW1FO0FBQ2xFO0FBQ0E7QUFDRDVCLFNBQUtjLEdBQUwsQ0FBUyx3QkFBd0JPLE1BQU1LLElBQTlCLEdBQXFDLFNBQXJDLEdBQWlETCxNQUFNTyxLQUF2RCxHQUErRCxHQUF4RTtBQUNBO0FBQ0Q5QixLQUFFLE1BQUYsRUFBVW1CLE1BQVYsQ0FBaUJPLEtBQUtMLEdBQUwsQ0FBU0MsSUFBVCxFQUFlQyxLQUFmLEVBQXNCRSxPQUF0QixDQUFqQjtBQUNBLEdBVEQ7QUFVQTtBQUNELEtBQUlwQixLQUFLMEIsT0FBVCxFQUFrQjtBQUNqQi9CLElBQUVTLElBQUYsQ0FBT0osS0FBSzBCLE9BQVosRUFBcUIsWUFBVztBQUMvQixPQUFJLENBQUM3QixLQUFLOEIsYUFBTCxDQUFtQixJQUFuQixDQUFMLEVBQStCO0FBQzlCOUIsU0FBS2MsR0FBTCxDQUFTLGFBQWEsSUFBdEI7QUFDQVY7QUFDQUosU0FBSytCLFlBQUwsQ0FBa0IsSUFBbEIsSUFBMEIsSUFBMUI7QUFDQWpDLE1BQUVrQyxJQUFGLENBQU87QUFDSEMsVUFBSyxJQURGO0FBRUhDLGVBQVUsUUFGUDtBQUdIN0IsY0FBU0EsT0FITjtBQUlITSxZQUFPQSxLQUpKO0FBS0h3QixZQUFPO0FBTEosS0FBUDtBQU9BO0FBQ0QsR0FiRDtBQWNBO0FBQ0QsS0FBSWhDLEtBQUtpQyxPQUFULEVBQWtCO0FBQ2pCLE1BQUlDLFNBQVNsQyxLQUFLaUMsT0FBZCxDQUFKLEVBQTRCO0FBQzNCdEMsS0FBRVMsSUFBRixDQUFPSixLQUFLaUMsT0FBWixFQUFxQixZQUFXO0FBQy9CcEMsU0FBS29DLE9BQUwsQ0FBYSxJQUFiLEVBQW1CakMsS0FBS21DLGVBQUwsSUFBd0IsRUFBM0M7QUFDQSxJQUZEO0FBR0EsR0FKRCxNQUlPO0FBQ050QyxRQUFLb0MsT0FBTCxDQUFhakMsS0FBS2lDLE9BQWxCO0FBQ0E7QUFDRDtBQUNEaEM7QUFDQUM7QUFDSCxDQW5FRCIsImZpbGUiOiJaZXNrSGFuZGxlSlNPTi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuKiBDb3B5cmlnaHQgJmNvcHk7IDIwMTcgTWFya2V0IEFjdW1lbiwgSW5jLlxuKi9cblxuY29uc3QgJCA9IHJlcXVpcmUoJ2pxdWVyeScpO1xuY29uc3QgWmVzayA9IHJlcXVpcmUoJy4vWmVzaycpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICB2YXIgdG90YWwgPSAwLCBzdWNjZXNzID0gZnVuY3Rpb24oKSB7XG5cdCAgICAtLXRvdGFsO1xuXHQgICAgaWYgKHRvdGFsID09PSAwKSB7XG5cdFx0ICAgIGlmIChkYXRhLnJlYWR5KSB7XG5cdFx0XHQgICAgJC5lYWNoKGRhdGEucmVhZHksIGZ1bmN0aW9uKCkge1xuXHRcdFx0XHQgICAgLyogWmVzay5sb2coXCJldmFsdWF0aW5nIFwiICsgdGhpcyk7ICovXG5cdFx0XHRcdCAgICAkLmdsb2JhbEV2YWwodGhpcyk7XG5cdFx0XHQgICAgfSk7XG5cdFx0ICAgIH1cblx0XHQgICAgaWYgKGRhdGEubG9jYXRpb24pIHtcblx0XHRcdCAgICBkb2N1bWVudC5sb2NhdGlvbiA9IGRhdGEubG9jYXRpb247XG5cdFx0ICAgIH1cblx0ICAgIH1cbiAgICB9LCBlcnJvciA9IGZ1bmN0aW9uKGpxWEhSKSB7XG5cdCAgICBjb25zb2xlLmxvZyhcIlJlcXVlc3QgZmFpbGVkXCIsIGpxWEhSKTtcblx0ICAgIHN1Y2Nlc3MoKTtcbiAgICB9O1xuICAgICQuZWFjaCh7XG4gICAgICAgICdoZWFkJzogZGF0YS5oZWFkX3RhZ3MgfHwgW10sXG4gICAgICAgICdib2R5JzogZGF0YS5ib2R5X3RhZ3MgfHwgW11cbiAgICB9LCBmdW5jdGlvbihhcHBlbmQpIHtcblx0ICAgIHZhciB0YWdzID0gdGhpcztcblx0ICAgICQuZWFjaCh0YWdzLCBmdW5jdGlvbigpIHtcblx0XHQgICAgdmFyIHRhZyA9IHRoaXMsIG5hbWUgPSB0YWcubmFtZSwgYXR0cnMgPSB0YWcuYXR0cmlidXRlcyB8fCB7fSwgY29udGVudCA9IHRhZy5jb250ZW50IHx8IG51bGw7XG5cdFx0ICAgICQoYXBwZW5kKS5hcHBlbmQoSFRNTC50YWcobmFtZSwgYXR0cnMsIGNvbnRlbnQpKTtcblx0ICAgIH0pO1xuICAgIH0pO1xuICAgIGlmIChkYXRhLnN0eWxlc2hlZXRzKSB7XG5cdCAgICAkLmVhY2goZGF0YS5zdHlsZXNoZWV0cywgZnVuY3Rpb24oKSB7XG5cdFx0ICAgIHZhciB0YWcgPSB0aGlzLCBuYW1lID0gdGFnLm5hbWUsIGF0dHJzID0gdGFnLmF0dHJpYnV0ZXMgfHwge30sIGNvbnRlbnQgPSB0YWcuY29udGVudCB8fCBudWxsO1xuXHRcdCAgICBpZiAobmFtZSA9PT0gXCJsaW5rXCIpIHtcblx0XHRcdCAgICBpZiAoYXR0cnMuaHJlZiAmJiBaZXNrLnN0eWxlc2hlZXRfbG9hZGVkKGF0dHJzLmhyZWYsIGF0dHJzLm1lZGlhKSkge1xuXHRcdFx0XHQgICAgcmV0dXJuO1xuXHRcdFx0ICAgIH1cblx0XHRcdCAgICBaZXNrLmxvZyhcIkxvYWRpbmcgc3R5bGVzaGVldCBcIiArIGF0dHJzLmhyZWYgKyBcIihtZWRpYT1cIiArIGF0dHJzLm1lZGlhICsgXCIpXCIpO1xuXHRcdCAgICB9XG5cdFx0ICAgICQoJ2hlYWQnKS5hcHBlbmQoSFRNTC50YWcobmFtZSwgYXR0cnMsIGNvbnRlbnQpKTtcblx0ICAgIH0pO1xuICAgIH1cbiAgICBpZiAoZGF0YS5zY3JpcHRzKSB7XG5cdCAgICAkLmVhY2goZGF0YS5zY3JpcHRzLCBmdW5jdGlvbigpIHtcblx0XHQgICAgaWYgKCFaZXNrLnNjcmlwdF9sb2FkZWQodGhpcykpIHtcblx0XHRcdCAgICBaZXNrLmxvZyhcIkxvYWRpbmcgXCIgKyB0aGlzKTtcblx0XHRcdCAgICB0b3RhbCsrO1xuXHRcdFx0ICAgIFplc2sucGFnZV9zY3JpcHRzW3RoaXNdID0gdGhpcztcblx0XHRcdCAgICAkLmFqYXgoe1xuXHRcdFx0ICAgICAgICB1cmw6IHRoaXMsXG5cdFx0XHQgICAgICAgIGRhdGFUeXBlOiAnc2NyaXB0Jyxcblx0XHRcdCAgICAgICAgc3VjY2Vzczogc3VjY2Vzcyxcblx0XHRcdCAgICAgICAgZXJyb3I6IGVycm9yLFxuXHRcdFx0ICAgICAgICBhc3luYzogZmFsc2Vcblx0XHRcdCAgICB9KTtcblx0XHQgICAgfVxuXHQgICAgfSk7XG4gICAgfVxuICAgIGlmIChkYXRhLm1lc3NhZ2UpIHtcblx0ICAgIGlmIChpc19hcnJheShkYXRhLm1lc3NhZ2UpKSB7XG5cdFx0ICAgICQuZWFjaChkYXRhLm1lc3NhZ2UsIGZ1bmN0aW9uKCkge1xuXHRcdFx0ICAgIFplc2subWVzc2FnZSh0aGlzLCBkYXRhLm1lc3NhZ2Vfb3B0aW9ucyB8fCB7fSk7XG5cdFx0ICAgIH0pO1xuXHQgICAgfSBlbHNlIHtcblx0XHQgICAgWmVzay5tZXNzYWdlKGRhdGEubWVzc2FnZSk7XG5cdCAgICB9XG4gICAgfVxuICAgIHRvdGFsKys7XG4gICAgc3VjY2VzcygpO1xufTsiXX0=
