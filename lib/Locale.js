"use strict";

/**
 * Copyright &copy; 2017 Market Acumen, Inc.
 */
var Zesk = require("./Zesk");

var Locale = {},
    is_object = Zesk.is_object,
    to_string = Zesk.to_string,
    avalue = Zesk.avalue,
    plural_en = function plural_en(s, count) {
	count = parseInt(count, 10);
	if (count === 1) {
		return s;
	}
	var ess = Locale.translate("plural:=" + s.toLowerCase(), "en", null);
	if (ess) {
		return Locale.case_match_simple(ess, s);
	}
	var s1 = s.substring(s.length - 1);
	switch (s1) {
		case "x":
			return s + "es";
		case "y":
			return s.substring(0, s.length - 1) + "ies";
		default:
			break;
	}
	return s + "s";
};
Locale = {
	plural: function plural(s, n, locale) {
		n = n || 2;
		if (Locale.language(locale) === "en") {
			return plural_en(s, n);
		} else {
			return plural_en(s, n);
		}
	},
	plural_n: function plural_n(s, n, locale) {
		return n + " " + Locale.plural(s, n, locale);
	},
	locale: function locale(set) {
		if (set) {
			return Zesk.set("locale", set);
		}
		return Zesk.get("locale", "en_US");
	},
	language: function language() {
		var x = to_string(arguments[0] || Locale.locale());
		return x.left("_", "en").toLowerCase();
	},
	ordinal: function ordinal(n) {
		return n + Locale.ordinal_suffix(n);
	},
	ordinal_suffix: function ordinal_suffix(n) {
		var m10 = n % 10,
		    m100 = n % 100;
		if (m100 > 10 && m100 < 20) {
			return "th";
		}
		return avalue({ 1: "st", 2: "nd", 3: "rd" }, m10, "th");
	},
	translation: function translation(locale, map) {
		var tt = Zesk.get("translation-table", {});
		locale = locale.toLowerCase();
		if (!tt[locale]) {
			tt[locale] = {};
		}
		for (var k in map) {
			if (map.hasOwnProperty(k)) {
				tt[locale][k] = map[k].toString();
			}
		}
		Zesk.set("translation-table", tt);
	},
	translate: function translate(string, locale) {
		var text = string.toString(),
		    phrase = string.right(":=", string),
		    tt = Zesk.get("translation-table"),
		    r,
		    _default = arguments.length > 2 ? arguments[2] : phrase;

		locale = locale || Locale.locale();
		tt = [avalue(tt, locale, {}), avalue(tt, Locale.language(locale), {})];
		r = Zesk.each(tt, function (i, t) {
			//	console.log('tried ', text, i, t, t[text]);
			return t[text] || null;
		});
		if (r) {
			return r;
		}
		r = Zesk.each(tt, function (i, t) {
			//	console.log('tried ', phrase, i, t, t[phrase]);
			return t[phrase] || null;
		});
		if (r) {
			return r;
		}
		r = Zesk.each(tt, function (i, t) {
			//	console.log('tried ', phrase.toLowerCase(), i, t, t[phrase.toLowerCase()]);
			return t[phrase.toLowerCase()] || null;
		});
		if (r) {
			return Locale.case_match_simple(r, phrase);
		}
		return _default;
	},
	case_match_simple: function case_match_simple(string, pattern) {
		var char1 = pattern.substr(0, 1);
		var char2 = pattern.substr(1, 1);
		if (char1 === char1.toLowerCase(char1)) {
			return string.toLowerCase();
		} else if (char2 === char2.toLowerCase()) {
			return string.substring(0, 1).toUpperCase() + string.substring(1).toLowerCase();
		} else {
			return string.toUpperCase();
		}
	},
	load: function load(locale, tt) {
		var tables = Zesk.get("translation-table", {});
		tables[locale] = tt;
	}
};
Locale.translation("en", {
	"plural:=day": "days",
	"plural:=staff": "staff",
	"plural:=sheep": "sheep",
	"plural:=octopus": "octopi",
	"plural:=news": "news"
});
Locale.__ = function (phrase, map) {
	if (phrase instanceof Object) {
		Zesk.each(phrase, function (k) {
			phrase[k] = Locale.__(phrase[k], map);
		});
		return phrase;
	}
	phrase = Locale.translate(phrase);
	if (!is_object(map)) {
		return phrase;
	}
	return phrase.map(map, true);
};
module.exports = Locale;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Mb2NhbGUuanMiXSwibmFtZXMiOlsiWmVzayIsInJlcXVpcmUiLCJMb2NhbGUiLCJpc19vYmplY3QiLCJ0b19zdHJpbmciLCJhdmFsdWUiLCJwbHVyYWxfZW4iLCJzIiwiY291bnQiLCJwYXJzZUludCIsImVzcyIsInRyYW5zbGF0ZSIsInRvTG93ZXJDYXNlIiwiY2FzZV9tYXRjaF9zaW1wbGUiLCJzMSIsInN1YnN0cmluZyIsImxlbmd0aCIsInBsdXJhbCIsIm4iLCJsb2NhbGUiLCJsYW5ndWFnZSIsInBsdXJhbF9uIiwic2V0IiwiZ2V0IiwieCIsImFyZ3VtZW50cyIsImxlZnQiLCJvcmRpbmFsIiwib3JkaW5hbF9zdWZmaXgiLCJtMTAiLCJtMTAwIiwidHJhbnNsYXRpb24iLCJtYXAiLCJ0dCIsImsiLCJoYXNPd25Qcm9wZXJ0eSIsInRvU3RyaW5nIiwic3RyaW5nIiwidGV4dCIsInBocmFzZSIsInJpZ2h0IiwiciIsIl9kZWZhdWx0IiwiZWFjaCIsImkiLCJ0IiwicGF0dGVybiIsImNoYXIxIiwic3Vic3RyIiwiY2hhcjIiLCJ0b1VwcGVyQ2FzZSIsImxvYWQiLCJ0YWJsZXMiLCJfXyIsIk9iamVjdCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUE7OztBQUdBLElBQU1BLE9BQU9DLFFBQVEsUUFBUixDQUFiOztBQUVBLElBQUlDLFNBQVMsRUFBYjtBQUFBLElBQ0NDLFlBQVlILEtBQUtHLFNBRGxCO0FBQUEsSUFFQ0MsWUFBWUosS0FBS0ksU0FGbEI7QUFBQSxJQUdDQyxTQUFTTCxLQUFLSyxNQUhmO0FBQUEsSUFJQ0MsWUFBWSxTQUFaQSxTQUFZLENBQVNDLENBQVQsRUFBWUMsS0FBWixFQUFtQjtBQUM5QkEsU0FBUUMsU0FBU0QsS0FBVCxFQUFnQixFQUFoQixDQUFSO0FBQ0EsS0FBSUEsVUFBVSxDQUFkLEVBQWlCO0FBQ2hCLFNBQU9ELENBQVA7QUFDQTtBQUNELEtBQUlHLE1BQU1SLE9BQU9TLFNBQVAsQ0FB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QixrQkFBaUIsT0FITztBQUl4QixvQkFBbUIsUUFKSztBQUt4QixpQkFBZ0I7QUFMUSxDQUF6QjtBQU9BN0IsT0FBT21ELEVBQVAsR0FBWSxVQUFTZCxNQUFULEVBQWlCUCxHQUFqQixFQUFzQjtBQUNqQyxLQUFJTyxrQkFBa0JlLE1BQXRCLEVBQThCO0FBQzdCdEQsT0FBSzJDLElBQUwsQ0FBVUosTUFBVixFQUFrQixVQUFTTCxDQUFULEVBQVk7QUFDN0JLLFVBQU9MLENBQVAsSUFBWWhDLE9BQU9tRCxFQUFQLENBQVVkLE9BQU9MLENBQVAsQ0FBVixFQUFxQkYsR0FBckIsQ0FBWjtBQUNBLEdBRkQ7QUFHQSxTQUFPTyxNQUFQO0FBQ0E7QUFDREEsVUFBU3JDLE9BQU9TLFNBQVAsQ0FBaUI0QixNQUFqQixDQUFUO0FBQ0EsS0FBSSxDQUFDcEMsVUFBVTZCLEdBQVYsQ0FBTCxFQUFxQjtBQUNwQixTQUFPTyxNQUFQO0FBQ0E7QUFDRCxRQUFPQSxPQUFPUCxHQUFQLENBQVdBLEdBQVgsRUFBZ0IsSUFBaEIsQ0FBUDtBQUNBLENBWkQ7QUFhQXVCLE9BQU9DLE9BQVAsR0FBaUJ0RCxNQUFqQiIsImZpbGUiOiJMb2NhbGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAmY29weTsgMjAxNyBNYXJrZXQgQWN1bWVuLCBJbmMuXG4gKi9cbmNvbnN0IFplc2sgPSByZXF1aXJlKFwiLi9aZXNrXCIpO1xuXG52YXIgTG9jYWxlID0ge30sXG5cdGlzX29iamVjdCA9IFplc2suaXNfb2JqZWN0LFxuXHR0b19zdHJpbmcgPSBaZXNrLnRvX3N0cmluZyxcblx0YXZhbHVlID0gWmVzay5hdmFsdWUsXG5cdHBsdXJhbF9lbiA9IGZ1bmN0aW9uKHMsIGNvdW50KSB7XG5cdFx0Y291bnQgPSBwYXJzZUludChjb3VudCwgMTApO1xuXHRcdGlmIChjb3VudCA9PT0gMSkge1xuXHRcdFx0cmV0dXJuIHM7XG5cdFx0fVxuXHRcdHZhciBlc3MgPSBMb2NhbGUudHJhbnNsYXRlKFwicGx1cmFsOj1cIiArIHMudG9Mb3dlckNhc2UoKSwgXCJlblwiLCBudWxsKTtcblx0XHRpZiAoZXNzKSB7XG5cdFx0XHRyZXR1cm4gTG9jYWxlLmNhc2VfbWF0Y2hfc2ltcGxlKGVzcywgcyk7XG5cdFx0fVxuXHRcdHZhciBzMSA9IHMuc3Vic3RyaW5nKHMubGVuZ3RoIC0gMSk7XG5cdFx0c3dpdGNoIChzMSkge1xuXHRcdFx0Y2FzZSBcInhcIjpcblx0XHRcdFx0cmV0dXJuIHMgKyBcImVzXCI7XG5cdFx0XHRjYXNlIFwieVwiOlxuXHRcdFx0XHRyZXR1cm4gcy5zdWJzdHJpbmcoMCwgcy5sZW5ndGggLSAxKSArIFwiaWVzXCI7XG5cdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRicmVhaztcblx0XHR9XG5cdFx0cmV0dXJuIHMgKyBcInNcIjtcblx0fTtcbkxvY2FsZSA9IHtcblx0cGx1cmFsOiBmdW5jdGlvbiBwbHVyYWwocywgbiwgbG9jYWxlKSB7XG5cdFx0biA9IG4gfHwgMjtcblx0XHRpZiAoTG9jYWxlLmxhbmd1YWdlKGxvY2FsZSkgPT09IFwiZW5cIikge1xuXHRcdFx0cmV0dXJuIHBsdXJhbF9lbihzLCBuKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0cmV0dXJuIHBsdXJhbF9lbihzLCBuKTtcblx0XHR9XG5cdH0sXG5cdHBsdXJhbF9uOiBmdW5jdGlvbihzLCBuLCBsb2NhbGUpIHtcblx0XHRyZXR1cm4gbiArIFwiIFwiICsgTG9jYWxlLnBsdXJhbChzLCBuLCBsb2NhbGUpO1xuXHR9LFxuXHRsb2NhbGU6IGZ1bmN0aW9uKHNldCkge1xuXHRcdGlmIChzZXQpIHtcblx0XHRcdHJldHVybiBaZXNrLnNldChcImxvY2FsZVwiLCBzZXQpO1xuXHRcdH1cblx0XHRyZXR1cm4gWmVzay5nZXQoXCJsb2NhbGVcIiwgXCJlbl9VU1wiKTtcblx0fSxcblx0bGFuZ3VhZ2U6IGZ1bmN0aW9uKCkge1xuXHRcdHZhciB4ID0gdG9fc3RyaW5nKGFyZ3VtZW50c1swXSB8fCBMb2NhbGUubG9jYWxlKCkpO1xuXHRcdHJldHVybiB4LmxlZnQoXCJfXCIsIFwiZW5cIikudG9Mb3dlckNhc2UoKTtcblx0fSxcblx0b3JkaW5hbDogZnVuY3Rpb24obikge1xuXHRcdHJldHVybiBuICsgTG9jYWxlLm9yZGluYWxfc3VmZml4KG4pO1xuXHR9LFxuXHRvcmRpbmFsX3N1ZmZpeDogZnVuY3Rpb24obikge1xuXHRcdHZhciBtMTAgPSBuICUgMTAsXG5cdFx0XHRtMTAwID0gbiAlIDEwMDtcblx0XHRpZiAobTEwMCA+IDEwICYmIG0xMDAgPCAyMCkge1xuXHRcdFx0cmV0dXJuIFwidGhcIjtcblx0XHR9XG5cdFx0cmV0dXJuIGF2YWx1ZSh7IDE6IFwic3RcIiwgMjogXCJuZFwiLCAzOiBcInJkXCIgfSwgbTEwLCBcInRoXCIpO1xuXHR9LFxuXHR0cmFuc2xhdGlvbjogZnVuY3Rpb24obG9jYWxlLCBtYXApIHtcblx0XHR2YXIgdHQgPSBaZXNrLmdldChcInRyYW5zbGF0aW9uLXRhYmxlXCIsIHt9KTtcblx0XHRsb2NhbGUgPSBsb2NhbGUudG9Mb3dlckNhc2UoKTtcblx0XHRpZiAoIXR0W2xvY2FsZV0pIHtcblx0XHRcdHR0W2xvY2FsZV0gPSB7fTtcblx0XHR9XG5cdFx0Zm9yICh2YXIgayBpbiBtYXApIHtcblx0XHRcdGlmIChtYXAuaGFzT3duUHJvcGVydHkoaykpIHtcblx0XHRcdFx0dHRbbG9jYWxlXVtrXSA9IG1hcFtrXS50b1N0cmluZygpO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRaZXNrLnNldChcInRyYW5zbGF0aW9uLXRhYmxlXCIsIHR0KTtcblx0fSxcblx0dHJhbnNsYXRlOiBmdW5jdGlvbihzdHJpbmcsIGxvY2FsZSkge1xuXHRcdHZhciB0ZXh0ID0gc3RyaW5nLnRvU3RyaW5nKCksXG5cdFx0XHRwaHJhc2UgPSBzdHJpbmcucmlnaHQoXCI6PVwiLCBzdHJpbmcpLFxuXHRcdFx0dHQgPSBaZXNrLmdldChcInRyYW5zbGF0aW9uLXRhYmxlXCIpLFxuXHRcdFx0cixcblx0XHRcdF9kZWZhdWx0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBhcmd1bWVudHNbMl0gOiBwaHJhc2U7XG5cblx0XHRsb2NhbGUgPSBsb2NhbGUgfHwgTG9jYWxlLmxvY2FsZSgpO1xuXHRcdHR0ID0gW2F2YWx1ZSh0dCwgbG9jYWxlLCB7fSksIGF2YWx1ZSh0dCwgTG9jYWxlLmxhbmd1YWdlKGxvY2FsZSksIHt9KV07XG5cdFx0ciA9IFplc2suZWFjaCh0dCwgZnVuY3Rpb24oaSwgdCkge1xuXHRcdFx0Ly9cdGNvbnNvbGUubG9nKCd0cmllZCAnLCB0ZXh0LCBpLCB0LCB0W3RleHRdKTtcblx0XHRcdHJldHVybiB0W3RleHRdIHx8IG51bGw7XG5cdFx0fSk7XG5cdFx0aWYgKHIpIHtcblx0XHRcdHJldHVybiByO1xuXHRcdH1cblx0XHRyID0gWmVzay5lYWNoKHR0LCBmdW5jdGlvbihpLCB0KSB7XG5cdFx0XHQvL1x0Y29uc29sZS5sb2coJ3RyaWVkICcsIHBocmFzZSwgaSwgdCwgdFtwaHJhc2VdKTtcblx0XHRcdHJldHVybiB0W3BocmFzZV0gfHwgbnVsbDtcblx0XHR9KTtcblx0XHRpZiAocikge1xuXHRcdFx0cmV0dXJuIHI7XG5cdFx0fVxuXHRcdHIgPSBaZXNrLmVhY2godHQsIGZ1bmN0aW9uKGksIHQpIHtcblx0XHRcdC8vXHRjb25zb2xlLmxvZygndHJpZWQgJywgcGhyYXNlLnRvTG93ZXJDYXNlKCksIGksIHQsIHRbcGhyYXNlLnRvTG93ZXJDYXNlKCldKTtcblx0XHRcdHJldHVybiB0W3BocmFzZS50b0xvd2VyQ2FzZSgpXSB8fCBudWxsO1xuXHRcdH0pO1xuXHRcdGlmIChyKSB7XG5cdFx0XHRyZXR1cm4gTG9jYWxlLmNhc2VfbWF0Y2hfc2ltcGxlKHIsIHBocmFzZSk7XG5cdFx0fVxuXHRcdHJldHVybiBfZGVmYXVsdDtcblx0fSxcblx0Y2FzZV9tYXRjaF9zaW1wbGU6IGZ1bmN0aW9uKHN0cmluZywgcGF0dGVybikge1xuXHRcdHZhciBjaGFyMSA9IHBhdHRlcm4uc3Vic3RyKDAsIDEpO1xuXHRcdHZhciBjaGFyMiA9IHBhdHRlcm4uc3Vic3RyKDEsIDEpO1xuXHRcdGlmIChjaGFyMSA9PT0gY2hhcjEudG9Mb3dlckNhc2UoY2hhcjEpKSB7XG5cdFx0XHRyZXR1cm4gc3RyaW5nLnRvTG93ZXJDYXNlKCk7XG5cdFx0fSBlbHNlIGlmIChjaGFyMiA9PT0gY2hhcjIudG9Mb3dlckNhc2UoKSkge1xuXHRcdFx0cmV0dXJuIHN0cmluZy5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHN0cmluZy5zdWJzdHJpbmcoMSkudG9Mb3dlckNhc2UoKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0cmV0dXJuIHN0cmluZy50b1VwcGVyQ2FzZSgpO1xuXHRcdH1cblx0fSxcblx0bG9hZDogZnVuY3Rpb24obG9jYWxlLCB0dCkge1xuXHRcdHZhciB0YWJsZXMgPSBaZXNrLmdldChcInRyYW5zbGF0aW9uLXRhYmxlXCIsIHt9KTtcblx0XHR0YWJsZXNbbG9jYWxlXSA9IHR0O1xuXHR9LFxufTtcbkxvY2FsZS50cmFuc2xhdGlvbihcImVuXCIsIHtcblx0XCJwbHVyYWw6PWRheVwiOiBcImRheXNcIixcblx0XCJwbHVyYWw6PXN0YWZmXCI6IFwic3RhZmZcIixcblx0XCJwbHVyYWw6PXNoZWVwXCI6IFwic2hlZXBcIixcblx0XCJwbHVyYWw6PW9jdG9wdXNcIjogXCJvY3RvcGlcIixcblx0XCJwbHVyYWw6PW5ld3NcIjogXCJuZXdzXCIsXG59KTtcbkxvY2FsZS5fXyA9IGZ1bmN0aW9uKHBocmFzZSwgbWFwKSB7XG5cdGlmIChwaHJhc2UgaW5zdGFuY2VvZiBPYmplY3QpIHtcblx0XHRaZXNrLmVhY2gocGhyYXNlLCBmdW5jdGlvbihrKSB7XG5cdFx0XHRwaHJhc2Vba10gPSBMb2NhbGUuX18ocGhyYXNlW2tdLCBtYXApO1xuXHRcdH0pO1xuXHRcdHJldHVybiBwaHJhc2U7XG5cdH1cblx0cGhyYXNlID0gTG9jYWxlLnRyYW5zbGF0ZShwaHJhc2UpO1xuXHRpZiAoIWlzX29iamVjdChtYXApKSB7XG5cdFx0cmV0dXJuIHBocmFzZTtcblx0fVxuXHRyZXR1cm4gcGhyYXNlLm1hcChtYXAsIHRydWUpO1xufTtcbm1vZHVsZS5leHBvcnRzID0gTG9jYWxlO1xuIl19