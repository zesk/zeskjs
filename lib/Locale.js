'use strict';

/**
* Copyright &copy; 2017 Market Acumen, Inc.
*/
var Zesk = require("./Zesk");

var Locale = {},
    is_object = Zesk.is_object,
    to_string = Zesk.to_string,
    avalue = Zesk.avalue,
    plural_en = function plural_en(s, count) {
	count = parseInt(count, 10);
	if (count === 1) {
		return s;
	}
	var ess = Locale.translate('plural:=' + s.toLowerCase(), 'en', null);
	if (ess) {
		return Locale.case_match_simple(ess, s);
	}
	var s1 = s.substring(s.length - 1);
	switch (s1) {
		case 'x':
			return s + "es";
		case 'y':
			return s.substring(0, s.length - 1) + "ies";
		default:
			break;
	}
	return s + 's';
};
Locale = {
	plural: function plural(s, n, locale) {
		n = n || 2;
		if (Locale.language(locale) === "en") {
			return plural_en(s, n);
		} else {
			return plural_en(s, n);
		}
	},
	plural_n: function plural_n(s, n, locale) {
		return n + " " + Locale.plural(s, n, locale);
	},
	locale: function locale(set) {
		if (set) {
			return Zesk.set('locale', set);
		}
		return Zesk.get('locale', 'en_US');
	},
	language: function language() {
		var x = to_string(arguments[0] || Locale.locale());
		return x.left('_', 'en').toLowerCase();
	},
	ordinal: function ordinal(n) {
		return n + Locale.ordinal_suffix(n);
	},
	ordinal_suffix: function ordinal_suffix(n) {
		var m10 = n % 10,
		    m100 = n % 100;
		if (m100 > 10 && m100 < 20) {
			return "th";
		}
		return avalue({ 1: "st", 2: "nd", 3: "rd" }, m10, "th");
	},
	translation: function translation(locale, map) {
		var tt = Zesk.get('translation-table', {});
		locale = locale.toLowerCase();
		if (!tt[locale]) {
			tt[locale] = {};
		}
		for (var k in map) {
			if (map.hasOwnProperty(k)) {
				tt[locale][k] = map[k].toString();
			}
		}
		Zesk.set('translation-table', tt);
	},
	translate: function translate(string, locale) {
		var text = string.toString(),
		    phrase = string.right(':=', string),
		    tt = Zesk.get('translation-table'),
		    r,
		    _default = arguments.length > 2 ? arguments[2] : phrase;

		locale = locale || Locale.locale();
		tt = [avalue(tt, locale, {}), avalue(tt, Locale.language(locale), {})];
		r = Zesk.each(tt, function (i, t) {
			//	console.log('tried ', text, i, t, t[text]);
			return t[text] || null;
		});
		if (r) {
			return r;
		}
		r = Zesk.each(tt, function (i, t) {
			//	console.log('tried ', phrase, i, t, t[phrase]);
			return t[phrase] || null;
		});
		if (r) {
			return r;
		}
		r = Zesk.each(tt, function (i, t) {
			//	console.log('tried ', phrase.toLowerCase(), i, t, t[phrase.toLowerCase()]);
			return t[phrase.toLowerCase()] || null;
		});
		if (r) {
			return Locale.case_match_simple(r, phrase);
		}
		return _default;
	},
	case_match_simple: function case_match_simple(string, pattern) {
		var char1 = pattern.substr(0, 1);
		var char2 = pattern.substr(1, 1);
		if (char1 === char1.toLowerCase(char1)) {
			return string.toLowerCase();
		} else if (char2 === char2.toLowerCase()) {
			return string.substring(0, 1).toUpperCase() + string.substring(1).toLowerCase();
		} else {
			return string.toUpperCase();
		}
	},
	load: function load(locale, tt) {
		var tables = Zesk.get('translation-table', {});
		tables[locale] = tt;
	}
};
Locale.translation('en', {
	'plural:=day': 'days',
	'plural:=staff': 'staff',
	'plural:=sheep': 'sheep',
	'plural:=octopus': 'octopi',
	'plural:=news': 'news'
});
Locale.__ = function (phrase, map) {
	if (phrase instanceof Object) {
		Zesk.each(phrase, function (k) {
			phrase[k] = Locale.__(phrase[k], map);
		});
		return phrase;
	}
	phrase = Locale.translate(phrase);
	if (!is_object(map)) {
		return phrase;
	}
	return phrase.map(map, true);
};
module.exports = Locale;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Mb2NhbGUuanMiXSwibmFtZXMiOlsiWmVzayIsInJlcXVpcmUiLCJMb2NhbGUiLCJpc19vYmplY3QiLCJ0b19zdHJpbmciLCJhdmFsdWUiLCJwbHVyYWxfZW4iLCJzIiwiY291bnQiLCJwYXJzZUludCIsImVzcyIsInRyYW5zbGF0ZSIsInRvTG93ZXJDYXNlIiwiY2FzZV9tYXRjaF9zaW1wbGUiLCJzMSIsInN1YnN0cmluZyIsImxlbmd0aCIsInBsdXJhbCIsIm4iLCJsb2NhbGUiLCJsYW5ndWFnZSIsInBsdXJhbF9uIiwic2V0IiwiZ2V0IiwieCIsImFyZ3VtZW50cyIsImxlZnQiLCJvcmRpbmFsIiwib3JkaW5hbF9zdWZmaXgiLCJtMTAiLCJtMTAwIiwidHJhbnNsYXRpb24iLCJtYXAiLCJ0dCIsImsiLCJoYXNPd25Qcm9wZXJ0eSIsInRvU3RyaW5nIiwic3RyaW5nIiwidGV4dCIsInBocmFzZSIsInJpZ2h0IiwiciIsIl9kZWZhdWx0IiwiZWFjaCIsImkiLCJ0IiwicGF0dGVybiIsImNoYXIxIiwic3Vic3RyIiwiY2hhcjIiLCJ0b1VwcGVyQ2FzZSIsImxvYWQiLCJ0YWJsZXMiLCJfXyIsIk9iamVjdCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUE7OztBQUdBLElBQU1BLE9BQU9DLFFBQVEsUUFBUixDQUFiOztBQUVBLElBQ0FDLFNBQVMsRUFEVDtBQUFBLElBRUFDLFlBQVlILEtBQUtHLFNBRmpCO0FBQUEsSUFHQUMsWUFBWUosS0FBS0ksU0FIakI7QUFBQSxJQUlBQyxTQUFTTCxLQUFLSyxNQUpkO0FBQUEsSUFLQUMsWUFBWSxTQUFaQSxTQUFZLENBQVVDLENBQVYsRUFBYUMsS0FBYixFQUFvQjtBQUMvQkEsU0FBUUMsU0FBU0QsS0FBVCxFQUFnQixFQUFoQixDQUFSO0FBQ0EsS0FBSUEsVUFBVSxDQUFkLEVBQWlCO0FBQ2hCLFNBQU9ELENBQVA7QUFDQTtBQUNELEtBQUlHLE1BQU1SLE9BQU9TLFNBQVAsQ0FB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QUd4QixrQkFBa0IsT0FITTtBQUl4QixvQkFBb0IsUUFKSTtBQUt4QixpQkFBaUI7QUFMTyxDQUF6QjtBQU9BN0IsT0FBT21ELEVBQVAsR0FBWSxVQUFVZCxNQUFWLEVBQWtCUCxHQUFsQixFQUF1QjtBQUNsQyxLQUFJTyxrQkFBa0JlLE1BQXRCLEVBQThCO0FBQzdCdEQsT0FBSzJDLElBQUwsQ0FBVUosTUFBVixFQUFrQixVQUFVTCxDQUFWLEVBQWE7QUFDOUJLLFVBQU9MLENBQVAsSUFBWWhDLE9BQU9tRCxFQUFQLENBQVVkLE9BQU9MLENBQVAsQ0FBVixFQUFxQkYsR0FBckIsQ0FBWjtBQUNBLEdBRkQ7QUFHQSxTQUFPTyxNQUFQO0FBQ0E7QUFDREEsVUFBU3JDLE9BQU9TLFNBQVAsQ0FBaUI0QixNQUFqQixDQUFUO0FBQ0EsS0FBSSxDQUFDcEMsVUFBVTZCLEdBQVYsQ0FBTCxFQUFxQjtBQUNwQixTQUFPTyxNQUFQO0FBQ0E7QUFDRCxRQUFPQSxPQUFPUCxHQUFQLENBQVdBLEdBQVgsRUFBZ0IsSUFBaEIsQ0FBUDtBQUNBLENBWkQ7QUFhQXVCLE9BQU9DLE9BQVAsR0FBaUJ0RCxNQUFqQiIsImZpbGUiOiJMb2NhbGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiogQ29weXJpZ2h0ICZjb3B5OyAyMDE3IE1hcmtldCBBY3VtZW4sIEluYy5cbiovXG5jb25zdCBaZXNrID0gcmVxdWlyZShcIi4vWmVza1wiKTtcblxudmFyIFxuTG9jYWxlID0ge30sXG5pc19vYmplY3QgPSBaZXNrLmlzX29iamVjdCxcbnRvX3N0cmluZyA9IFplc2sudG9fc3RyaW5nLFxuYXZhbHVlID0gWmVzay5hdmFsdWUsXG5wbHVyYWxfZW4gPSBmdW5jdGlvbiAocywgY291bnQpIHtcblx0Y291bnQgPSBwYXJzZUludChjb3VudCwgMTApO1xuXHRpZiAoY291bnQgPT09IDEpIHtcblx0XHRyZXR1cm4gcztcblx0fVxuXHR2YXIgZXNzID0gTG9jYWxlLnRyYW5zbGF0ZSgncGx1cmFsOj0nICsgcy50b0xvd2VyQ2FzZSgpLCAnZW4nLCBudWxsKTtcblx0aWYgKGVzcykge1xuXHRcdHJldHVybiBMb2NhbGUuY2FzZV9tYXRjaF9zaW1wbGUoZXNzLCBzKTtcblx0fVxuXHR2YXIgczEgPSBzLnN1YnN0cmluZyhzLmxlbmd0aCAtIDEpO1xuXHRzd2l0Y2ggKHMxKSB7XG5cdFx0Y2FzZSAneCc6XG5cdFx0XHRyZXR1cm4gcyArIFwiZXNcIjtcblx0XHRjYXNlICd5Jzpcblx0XHRcdHJldHVybiBzLnN1YnN0cmluZygwLCBzLmxlbmd0aCAtIDEpICsgXCJpZXNcIjtcblx0XHRkZWZhdWx0OlxuXHRcdFx0YnJlYWs7XG5cdH1cblx0cmV0dXJuIHMgKyAncyc7XG59O1xuTG9jYWxlID0ge1xuXHRwbHVyYWw6IGZ1bmN0aW9uIHBsdXJhbChzLCBuLCBsb2NhbGUpIHtcblx0XHRuID0gbiB8fCAyO1xuXHRcdGlmIChMb2NhbGUubGFuZ3VhZ2UobG9jYWxlKSA9PT0gXCJlblwiKSB7XG5cdFx0XHRyZXR1cm4gcGx1cmFsX2VuKHMsIG4pO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRyZXR1cm4gcGx1cmFsX2VuKHMsIG4pO1xuXHRcdH1cblx0fSxcblx0cGx1cmFsX246IGZ1bmN0aW9uIChzLCBuLCBsb2NhbGUpIHtcblx0XHRyZXR1cm4gbiArIFwiIFwiICsgTG9jYWxlLnBsdXJhbChzLCBuLCBsb2NhbGUpO1xuXHR9LFxuXHRsb2NhbGU6IGZ1bmN0aW9uIChzZXQpIHtcblx0XHRpZiAoc2V0KSB7XG5cdFx0XHRyZXR1cm4gWmVzay5zZXQoJ2xvY2FsZScsIHNldCk7XG5cdFx0fVxuXHRcdHJldHVybiBaZXNrLmdldCgnbG9jYWxlJywgJ2VuX1VTJyk7XG5cdH0sXG5cdGxhbmd1YWdlOiBmdW5jdGlvbiAoKSB7XG5cdFx0dmFyIHggPSB0b19zdHJpbmcoYXJndW1lbnRzWzBdIHx8IExvY2FsZS5sb2NhbGUoKSk7XG5cdFx0cmV0dXJuIHgubGVmdCgnXycsICdlbicpLnRvTG93ZXJDYXNlKCk7XG5cdH0sXG5cdG9yZGluYWw6IGZ1bmN0aW9uIChuKSB7XG5cdFx0cmV0dXJuIG4gKyBMb2NhbGUub3JkaW5hbF9zdWZmaXgobik7XG5cdH0sXG5cdG9yZGluYWxfc3VmZml4OiBmdW5jdGlvbiAobikge1xuXHRcdHZhclxuXHRcdG0xMCA9IG4gJSAxMCxcblx0XHRtMTAwID0gbiAlIDEwMDtcblx0XHRpZiAobTEwMCA+IDEwICYmIG0xMDAgPCAyMCkge1xuXHRcdFx0cmV0dXJuIFwidGhcIjtcblx0XHR9XG5cdFx0cmV0dXJuIGF2YWx1ZSh7IDE6IFwic3RcIiwgMjogXCJuZFwiLCAzOiBcInJkXCIgfSwgbTEwLCBcInRoXCIpO1xuXHR9LFxuXHR0cmFuc2xhdGlvbjogZnVuY3Rpb24gKGxvY2FsZSwgbWFwKSB7XG5cdFx0dmFyIHR0ID0gWmVzay5nZXQoJ3RyYW5zbGF0aW9uLXRhYmxlJywge30pO1xuXHRcdGxvY2FsZSA9IGxvY2FsZS50b0xvd2VyQ2FzZSgpO1xuXHRcdGlmICghdHRbbG9jYWxlXSkge1xuXHRcdFx0dHRbbG9jYWxlXSA9IHt9O1xuXHRcdH1cblx0XHRmb3IgKCB2YXIgayBpbiBtYXApIHtcblx0XHRcdGlmIChtYXAuaGFzT3duUHJvcGVydHkoaykpIHtcblx0XHRcdFx0dHRbbG9jYWxlXVtrXSA9IG1hcFtrXS50b1N0cmluZygpO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRaZXNrLnNldCgndHJhbnNsYXRpb24tdGFibGUnLCB0dCk7XG5cdH0sXG5cdHRyYW5zbGF0ZTogZnVuY3Rpb24oc3RyaW5nLCBsb2NhbGUpIHtcblx0XHR2YXJcblx0XHR0ZXh0ID0gc3RyaW5nLnRvU3RyaW5nKCksXG5cdFx0cGhyYXNlID0gc3RyaW5nLnJpZ2h0KCc6PScsIHN0cmluZyksXG5cdFx0dHQgPSBaZXNrLmdldCgndHJhbnNsYXRpb24tdGFibGUnKSxcblx0XHRyLFxuXHRcdF9kZWZhdWx0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBhcmd1bWVudHNbMl0gOiBwaHJhc2U7XG5cblx0XHRsb2NhbGUgPSBsb2NhbGUgfHwgTG9jYWxlLmxvY2FsZSgpO1xuXHRcdHR0ID0gWyBhdmFsdWUodHQsIGxvY2FsZSwge30pLCBhdmFsdWUodHQsIExvY2FsZS5sYW5ndWFnZShsb2NhbGUpLCB7fSkgXTtcblx0XHRyID0gWmVzay5lYWNoKHR0LCBmdW5jdGlvbihpLCB0KSB7XG5cdFx0Ly9cdGNvbnNvbGUubG9nKCd0cmllZCAnLCB0ZXh0LCBpLCB0LCB0W3RleHRdKTtcblx0XHRcdHJldHVybiB0W3RleHRdIHx8IG51bGw7XG5cdFx0fSk7XG5cdFx0aWYgKHIpIHtcblx0XHRcdHJldHVybiByO1xuXHRcdH1cblx0XHRyID0gWmVzay5lYWNoKHR0LCBmdW5jdGlvbihpLCB0KSB7XG5cdFx0Ly9cdGNvbnNvbGUubG9nKCd0cmllZCAnLCBwaHJhc2UsIGksIHQsIHRbcGhyYXNlXSk7XG5cdFx0XHRyZXR1cm4gdFtwaHJhc2VdIHx8IG51bGw7XG5cdFx0fSk7XG5cdFx0aWYgKHIpIHtcblx0XHRcdHJldHVybiByO1xuXHRcdH1cblx0XHRyID0gWmVzay5lYWNoKHR0LCBmdW5jdGlvbihpLCB0KSB7XG5cdFx0Ly9cdGNvbnNvbGUubG9nKCd0cmllZCAnLCBwaHJhc2UudG9Mb3dlckNhc2UoKSwgaSwgdCwgdFtwaHJhc2UudG9Mb3dlckNhc2UoKV0pO1xuXHRcdFx0cmV0dXJuIHRbcGhyYXNlLnRvTG93ZXJDYXNlKCldIHx8IG51bGw7XG5cdFx0fSk7XG5cdFx0aWYgKHIpIHtcblx0XHRcdHJldHVybiBMb2NhbGUuY2FzZV9tYXRjaF9zaW1wbGUociwgcGhyYXNlKTtcblx0XHR9XG5cdFx0cmV0dXJuIF9kZWZhdWx0O1xuXHR9LFxuXHRjYXNlX21hdGNoX3NpbXBsZTogZnVuY3Rpb24gKHN0cmluZywgcGF0dGVybikge1xuXHRcdHZhciBjaGFyMSA9IHBhdHRlcm4uc3Vic3RyKDAsIDEpO1xuXHRcdHZhciBjaGFyMiA9IHBhdHRlcm4uc3Vic3RyKDEsIDEpO1xuXHRcdGlmIChjaGFyMSA9PT0gY2hhcjEudG9Mb3dlckNhc2UoY2hhcjEpKSB7XG5cdFx0XHRyZXR1cm4gc3RyaW5nLnRvTG93ZXJDYXNlKCk7XG5cdFx0fSBlbHNlIGlmIChjaGFyMiA9PT0gY2hhcjIudG9Mb3dlckNhc2UoKSkge1xuXHRcdFx0cmV0dXJuIHN0cmluZy5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHN0cmluZy5zdWJzdHJpbmcoMSkudG9Mb3dlckNhc2UoKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0cmV0dXJuIHN0cmluZy50b1VwcGVyQ2FzZSgpO1xuXHRcdH1cblx0fSxcblx0bG9hZDogZnVuY3Rpb24gKGxvY2FsZSwgdHQpIHtcblx0XHR2YXIgdGFibGVzID0gWmVzay5nZXQoJ3RyYW5zbGF0aW9uLXRhYmxlJywge30pO1xuXHRcdHRhYmxlc1tsb2NhbGVdID0gdHQ7XG5cdH1cbn07XG5Mb2NhbGUudHJhbnNsYXRpb24oJ2VuJywge1xuXHQncGx1cmFsOj1kYXknIDogJ2RheXMnLFxuXHQncGx1cmFsOj1zdGFmZicgOiAnc3RhZmYnLFxuXHQncGx1cmFsOj1zaGVlcCcgOiAnc2hlZXAnLFxuXHQncGx1cmFsOj1vY3RvcHVzJyA6ICdvY3RvcGknLFxuXHQncGx1cmFsOj1uZXdzJyA6ICduZXdzJ1xufSk7XG5Mb2NhbGUuX18gPSBmdW5jdGlvbiAocGhyYXNlLCBtYXApIHtcblx0aWYgKHBocmFzZSBpbnN0YW5jZW9mIE9iamVjdCkge1xuXHRcdFplc2suZWFjaChwaHJhc2UsIGZ1bmN0aW9uIChrKSB7XG5cdFx0XHRwaHJhc2Vba10gPSBMb2NhbGUuX18ocGhyYXNlW2tdLCBtYXApO1xuXHRcdH0pO1xuXHRcdHJldHVybiBwaHJhc2U7XG5cdH1cblx0cGhyYXNlID0gTG9jYWxlLnRyYW5zbGF0ZShwaHJhc2UpO1xuXHRpZiAoIWlzX29iamVjdChtYXApKSB7XG5cdFx0cmV0dXJuIHBocmFzZTtcblx0fVxuXHRyZXR1cm4gcGhyYXNlLm1hcChtYXAsIHRydWUpO1xufTtcbm1vZHVsZS5leHBvcnRzID0gTG9jYWxlO1xuIl19