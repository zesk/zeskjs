"use strict";

var _lodash = require("lodash");

var _lodash2 = _interopRequireDefault(_lodash);

var _Zesk = require("./Zesk");

var _Zesk2 = _interopRequireDefault(_Zesk);

var _DateTools = require("./DateTools");

var _DateTools2 = _interopRequireDefault(_DateTools);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Locale = {},
    is_object = _Zesk2.default.is_object,
    to_string = _Zesk2.default.to_string,
    avalue = _Zesk2.default.avalue,
    plural_en = function plural_en(s, count) {
	count = parseInt(count, 10);
	if (count === 1) {
		return s;
	}
	var ess = Locale.translate("plural:=" + s.toLowerCase(), "en", null);
	if (ess) {
		return Locale.case_match_simple(ess, s);
	}
	var s1 = s.substring(s.length - 1);
	switch (s1) {
		case "x":
			return s + "es";
		case "y":
			return s.substring(0, s.length - 1) + "ies";
		default:
			break;
	}
	return s + "s";
}; /**
    * Copyright &copy; 2017 Market Acumen, Inc.
    */

Locale = {
	plural: function plural(s, n, locale) {
		n = n || 2;
		if (Locale.language(locale) === "en") {
			return plural_en(s, n);
		} else {
			return plural_en(s, n);
		}
	},
	plural_n: function plural_n(s, n, locale) {
		return n + " " + Locale.plural(s, n, locale);
	},
	locale: function locale(set) {
		if (set) {
			return _Zesk2.default.set("locale", set);
		}
		return _Zesk2.default.get("locale", "en_US");
	},
	language: function language() {
		var x = to_string(arguments[0] || Locale.locale());
		return x.left("_", "en").toLowerCase();
	},
	ordinal: function ordinal(n) {
		return n + Locale.ordinal_suffix(n);
	},
	ordinal_suffix: function ordinal_suffix(n) {
		var m10 = n % 10,
		    m100 = n % 100;
		if (m100 > 10 && m100 < 20) {
			return "th";
		}
		return avalue({ 1: "st", 2: "nd", 3: "rd" }, m10, "th");
	},
	translation: function translation(locale, map) {
		var tt = _Zesk2.default.get("translation-table", {});
		locale = locale.toLowerCase();
		if (!tt[locale]) {
			tt[locale] = {};
		}
		for (var k in map) {
			if (map.hasOwnProperty(k)) {
				tt[locale][k] = map[k].toString();
			}
		}
		_Zesk2.default.set("translation-table", tt);
	},
	translate: function translate(string, locale) {
		var text = string.toString(),
		    phrase = string.right(":=", string),
		    tt = _Zesk2.default.get("translation-table"),
		    r = void 0,
		    _default = arguments.length > 2 ? arguments[2] : phrase;

		locale = locale || Locale.locale();
		tt = [avalue(tt, locale, {}), avalue(tt, Locale.language(locale), {})];
		r = _Zesk2.default.each(tt, function (i, t) {
			//	console.log('tried ', text, i, t, t[text]);
			return t[text] || null;
		});
		if (r) {
			return r;
		}
		r = _Zesk2.default.each(tt, function (i, t) {
			//	console.log('tried ', phrase, i, t, t[phrase]);
			return t[phrase] || null;
		});
		if (r) {
			return r;
		}
		r = _Zesk2.default.each(tt, function (i, t) {
			//	console.log('tried ', phrase.toLowerCase(), i, t, t[phrase.toLowerCase()]);
			return t[phrase.toLowerCase()] || null;
		});
		if (r) {
			return Locale.case_match_simple(r, phrase);
		}
		return _default;
	},
	case_match_simple: function case_match_simple(string, pattern) {
		var char1 = pattern.substr(0, 1);
		var char2 = pattern.substr(1, 1);
		if (char1 === char1.toLowerCase(char1)) {
			return string.toLowerCase();
		} else if (char2 === char2.toLowerCase()) {
			return string.substring(0, 1).toUpperCase() + string.substring(1).toLowerCase();
		} else {
			return string.toUpperCase();
		}
	},
	load: function load(locale, tt) {
		var tables = _Zesk2.default.get("translation-table", {});
		tables[locale] = tt;
	}
};
Locale.translation("en", {
	"plural:=day": "days",
	"plural:=staff": "staff",
	"plural:=sheep": "sheep",
	"plural:=octopus": "octopi",
	"plural:=news": "news"
});
Locale.__ = function (phrase, map) {
	if (_lodash2.default.isUndefined(phrase)) {
		return "-undefined-value-";
	}
	if (phrase instanceof Object) {
		_Zesk2.default.each(phrase, function (k) {
			phrase[k] = Locale.__(phrase[k], map);
		});
		return phrase;
	}
	phrase = Locale.translate(phrase);
	if (!is_object(map)) {
		return phrase;
	}
	return phrase.map(map, true);
};

Locale.durationString = function (delta, min_unit) {
	var number = null;
	if (delta < 0) {
		delta = -delta;
	}
	if (_Zesk2.default.is_string(min_unit)) {
		min_unit = _DateTools2.default.units[min_unit] || 0;
	}
	_Zesk2.default.each(_DateTools2.default.units, function (unit, nsecs) {
		if (unit === min_unit || delta > nsecs * 2 - 1) {
			number = parseInt(delta / nsecs, 10);
			return Locale.plural_n(Locale.__(unit), number);
		}
	});
	return {
		duration: Locale.plural_n(Locale.__(_DateTools2.default.SECOND), parseInt(delta, 10)),
		number: number
	};
};

/**
 * Output a string like "in 3 days", "5 hours ago"
 *
 * @param {Date} ts
 *        	Date to generate string
 * @param {string} min_unit
 *        	Minimum unit to output
 * @param {string} zero_string
 *        	Optional string if < 1 unit away
 * @return string
 */
Locale.nowString = function (ts, min_unit, zero_string) {
	var now = new Date();
	var delta = (now.getTime() - ts.getTime()) / 1000;

	var _Locale$durationStrin = Locale.durationString(delta, min_unit),
	    duration = _Locale$durationStrin.duration,
	    number = _Locale$durationStrin.number;

	var phrase = null;
	if (number === 0 && _Zesk2.default.is_string(zero_string)) {
		phrase = zero_string;
	} else if (delta < 0) {
		phrase = "Locale::now_string:=in {duration}";
	} else {
		phrase = "Locale::now_string:={duration} ago";
	}
	return Locale.__(phrase, {
		duration: duration,
		min_unit: min_unit,
		zero_string: zero_string
	});
};

module.exports = Locale;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Mb2NhbGUuanMiXSwibmFtZXMiOlsiTG9jYWxlIiwiaXNfb2JqZWN0IiwiWmVzayIsInRvX3N0cmluZyIsImF2YWx1ZSIsInBsdXJhbF9lbiIsInMiLCJjb3VudCIsInBhcnNlSW50IiwiZXNzIiwidHJhbnNsYXRlIiwidG9Mb3dlckNhc2UiLCJjYXNlX21hdGNoX3NpbXBsZSIsInMxIiwic3Vic3RyaW5nIiwibGVuZ3RoIiwicGx1cmFsIiwibiIsImxvY2FsZSIsImxhbmd1YWdlIiwicGx1cmFsX24iLCJzZXQiLCJnZXQiLCJ4IiwiYXJndW1lbnRzIiwibGVmdCIsIm9yZGluYWwiLCJvcmRpbmFsX3N1ZmZpeCIsIm0xMCIsIm0xMDAiLCJ0cmFuc2xhdGlvbiIsIm1hcCIsInR0IiwiayIsImhhc093blByb3BlcnR5IiwidG9TdHJpbmciLCJzdHJpbmciLCJ0ZXh0IiwicGhyYXNlIiwicmlnaHQiLCJyIiwiX2RlZmF1bHQiLCJlYWNoIiwiaSIsInQiLCJwYXR0ZXJuIiwiY2hhcjEiLCJzdWJzdHIiLCJjaGFyMiIsInRvVXBwZXJDYXNlIiwibG9hZCIsInRhYmxlcyIsIl9fIiwiXyIsImlzVW5kZWZpbmVkIiwiT2JqZWN0IiwiZHVyYXRpb25TdHJpbmciLCJkZWx0YSIsIm1pbl91bml0IiwibnVtYmVyIiwiaXNfc3RyaW5nIiwiRGF0ZVRvb2xzIiwidW5pdHMiLCJ1bml0IiwibnNlY3MiLCJkdXJhdGlvbiIsIlNFQ09ORCIsIm5vd1N0cmluZyIsInRzIiwiemVyb19zdHJpbmciLCJub3ciLCJEYXRlIiwiZ2V0VGltZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBR0E7Ozs7QUFFQTs7OztBQUNBOzs7Ozs7QUFFQSxJQUFJQSxTQUFTLEVBQWI7QUFBQSxJQUNDQyxZQUFZQyxlQUFLRCxTQURsQjtBQUFBLElBRUNFLFlBQVlELGVBQUtDLFNBRmxCO0FBQUEsSUFHQ0MsU0FBU0YsZUFBS0UsTUFIZjtBQUFBLElBSUNDLFlBQVks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QUFDQSxFQUZELE1BRU8sSUFBSVosUUFBUSxDQUFaLEVBQWU7QUFDckJuQixXQUFTLG1DQUFUO0FBQ0EsRUFGTSxNQUVBO0FBQ05BLFdBQVMsb0NBQVQ7QUFDQTtBQUNELFFBQU90QyxPQUFPb0QsRUFBUCxDQUFVZCxNQUFWLEVBQWtCO0FBQ3hCMkIsWUFBVUEsUUFEYztBQUV4QlAsWUFBVUEsUUFGYztBQUd4QlcsZUFBYUE7QUFIVyxFQUFsQixDQUFQO0FBS0EsQ0FqQkQ7O0FBbUJBSSxPQUFPQyxPQUFQLEdBQWlCMUUsTUFBakIiLCJmaWxlIjoiTG9jYWxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgJmNvcHk7IDIwMTcgTWFya2V0IEFjdW1lbiwgSW5jLlxuICovXG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgWmVzayBmcm9tIFwiLi9aZXNrXCI7XG5pbXBvcnQgRGF0ZVRvb2xzIGZyb20gXCIuL0RhdGVUb29sc1wiO1xuXG5sZXQgTG9jYWxlID0ge30sXG5cdGlzX29iamVjdCA9IFplc2suaXNfb2JqZWN0LFxuXHR0b19zdHJpbmcgPSBaZXNrLnRvX3N0cmluZyxcblx0YXZhbHVlID0gWmVzay5hdmFsdWUsXG5cdHBsdXJhbF9lbiA9IGZ1bmN0aW9uKHMsIGNvdW50KSB7XG5cdFx0Y291bnQgPSBwYXJzZUludChjb3VudCwgMTApO1xuXHRcdGlmIChjb3VudCA9PT0gMSkge1xuXHRcdFx0cmV0dXJuIHM7XG5cdFx0fVxuXHRcdGxldCBlc3MgPSBMb2NhbGUudHJhbnNsYXRlKFwicGx1cmFsOj1cIiArIHMudG9Mb3dlckNhc2UoKSwgXCJlblwiLCBudWxsKTtcblx0XHRpZiAoZXNzKSB7XG5cdFx0XHRyZXR1cm4gTG9jYWxlLmNhc2VfbWF0Y2hfc2ltcGxlKGVzcywgcyk7XG5cdFx0fVxuXHRcdGxldCBzMSA9IHMuc3Vic3RyaW5nKHMubGVuZ3RoIC0gMSk7XG5cdFx0c3dpdGNoIChzMSkge1xuXHRcdFx0Y2FzZSBcInhcIjpcblx0XHRcdFx0cmV0dXJuIHMgKyBcImVzXCI7XG5cdFx0XHRjYXNlIFwieVwiOlxuXHRcdFx0XHRyZXR1cm4gcy5zdWJzdHJpbmcoMCwgcy5sZW5ndGggLSAxKSArIFwiaWVzXCI7XG5cdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRicmVhaztcblx0XHR9XG5cdFx0cmV0dXJuIHMgKyBcInNcIjtcblx0fTtcbkxvY2FsZSA9IHtcblx0cGx1cmFsOiBmdW5jdGlvbiBwbHVyYWwocywgbiwgbG9jYWxlKSB7XG5cdFx0biA9IG4gfHwgMjtcblx0XHRpZiAoTG9jYWxlLmxhbmd1YWdlKGxvY2FsZSkgPT09IFwiZW5cIikge1xuXHRcdFx0cmV0dXJuIHBsdXJhbF9lbihzLCBuKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0cmV0dXJuIHBsdXJhbF9lbihzLCBuKTtcblx0XHR9XG5cdH0sXG5cdHBsdXJhbF9uOiBmdW5jdGlvbihzLCBuLCBsb2NhbGUpIHtcblx0XHRyZXR1cm4gbiArIFwiIFwiICsgTG9jYWxlLnBsdXJhbChzLCBuLCBsb2NhbGUpO1xuXHR9LFxuXHRsb2NhbGU6IGZ1bmN0aW9uKHNldCkge1xuXHRcdGlmIChzZXQpIHtcblx0XHRcdHJldHVybiBaZXNrLnNldChcImxvY2FsZVwiLCBzZXQpO1xuXHRcdH1cblx0XHRyZXR1cm4gWmVzay5nZXQoXCJsb2NhbGVcIiwgXCJlbl9VU1wiKTtcblx0fSxcblx0bGFuZ3VhZ2U6IGZ1bmN0aW9uKCkge1xuXHRcdGxldCB4ID0gdG9fc3RyaW5nKGFyZ3VtZW50c1swXSB8fCBMb2NhbGUubG9jYWxlKCkpO1xuXHRcdHJldHVybiB4LmxlZnQoXCJfXCIsIFwiZW5cIikudG9Mb3dlckNhc2UoKTtcblx0fSxcblx0b3JkaW5hbDogZnVuY3Rpb24obikge1xuXHRcdHJldHVybiBuICsgTG9jYWxlLm9yZGluYWxfc3VmZml4KG4pO1xuXHR9LFxuXHRvcmRpbmFsX3N1ZmZpeDogZnVuY3Rpb24obikge1xuXHRcdGxldCBtMTAgPSBuICUgMTAsXG5cdFx0XHRtMTAwID0gbiAlIDEwMDtcblx0XHRpZiAobTEwMCA+IDEwICYmIG0xMDAgPCAyMCkge1xuXHRcdFx0cmV0dXJuIFwidGhcIjtcblx0XHR9XG5cdFx0cmV0dXJuIGF2YWx1ZSh7IDE6IFwic3RcIiwgMjogXCJuZFwiLCAzOiBcInJkXCIgfSwgbTEwLCBcInRoXCIpO1xuXHR9LFxuXHR0cmFuc2xhdGlvbjogZnVuY3Rpb24obG9jYWxlLCBtYXApIHtcblx0XHRsZXQgdHQgPSBaZXNrLmdldChcInRyYW5zbGF0aW9uLXRhYmxlXCIsIHt9KTtcblx0XHRsb2NhbGUgPSBsb2NhbGUudG9Mb3dlckNhc2UoKTtcblx0XHRpZiAoIXR0W2xvY2FsZV0pIHtcblx0XHRcdHR0W2xvY2FsZV0gPSB7fTtcblx0XHR9XG5cdFx0Zm9yIChsZXQgayBpbiBtYXApIHtcblx0XHRcdGlmIChtYXAuaGFzT3duUHJvcGVydHkoaykpIHtcblx0XHRcdFx0dHRbbG9jYWxlXVtrXSA9IG1hcFtrXS50b1N0cmluZygpO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRaZXNrLnNldChcInRyYW5zbGF0aW9uLXRhYmxlXCIsIHR0KTtcblx0fSxcblx0dHJhbnNsYXRlOiBmdW5jdGlvbihzdHJpbmcsIGxvY2FsZSkge1xuXHRcdGxldCB0ZXh0ID0gc3RyaW5nLnRvU3RyaW5nKCksXG5cdFx0XHRwaHJhc2UgPSBzdHJpbmcucmlnaHQoXCI6PVwiLCBzdHJpbmcpLFxuXHRcdFx0dHQgPSBaZXNrLmdldChcInRyYW5zbGF0aW9uLXRhYmxlXCIpLFxuXHRcdFx0cixcblx0XHRcdF9kZWZhdWx0ID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBhcmd1bWVudHNbMl0gOiBwaHJhc2U7XG5cblx0XHRsb2NhbGUgPSBsb2NhbGUgfHwgTG9jYWxlLmxvY2FsZSgpO1xuXHRcdHR0ID0gW2F2YWx1ZSh0dCwgbG9jYWxlLCB7fSksIGF2YWx1ZSh0dCwgTG9jYWxlLmxhbmd1YWdlKGxvY2FsZSksIHt9KV07XG5cdFx0ciA9IFplc2suZWFjaCh0dCwgZnVuY3Rpb24oaSwgdCkge1xuXHRcdFx0Ly9cdGNvbnNvbGUubG9nKCd0cmllZCAnLCB0ZXh0LCBpLCB0LCB0W3RleHRdKTtcblx0XHRcdHJldHVybiB0W3RleHRdIHx8IG51bGw7XG5cdFx0fSk7XG5cdFx0aWYgKHIpIHtcblx0XHRcdHJldHVybiByO1xuXHRcdH1cblx0XHRyID0gWmVzay5lYWNoKHR0LCBmdW5jdGlvbihpLCB0KSB7XG5cdFx0XHQvL1x0Y29uc29sZS5sb2coJ3RyaWVkICcsIHBocmFzZSwgaSwgdCwgdFtwaHJhc2VdKTtcblx0XHRcdHJldHVybiB0W3BocmFzZV0gfHwgbnVsbDtcblx0XHR9KTtcblx0XHRpZiAocikge1xuXHRcdFx0cmV0dXJuIHI7XG5cdFx0fVxuXHRcdHIgPSBaZXNrLmVhY2godHQsIGZ1bmN0aW9uKGksIHQpIHtcblx0XHRcdC8vXHRjb25zb2xlLmxvZygndHJpZWQgJywgcGhyYXNlLnRvTG93ZXJDYXNlKCksIGksIHQsIHRbcGhyYXNlLnRvTG93ZXJDYXNlKCldKTtcblx0XHRcdHJldHVybiB0W3BocmFzZS50b0xvd2VyQ2FzZSgpXSB8fCBudWxsO1xuXHRcdH0pO1xuXHRcdGlmIChyKSB7XG5cdFx0XHRyZXR1cm4gTG9jYWxlLmNhc2VfbWF0Y2hfc2ltcGxlKHIsIHBocmFzZSk7XG5cdFx0fVxuXHRcdHJldHVybiBfZGVmYXVsdDtcblx0fSxcblx0Y2FzZV9tYXRjaF9zaW1wbGU6IGZ1bmN0aW9uKHN0cmluZywgcGF0dGVybikge1xuXHRcdGxldCBjaGFyMSA9IHBhdHRlcm4uc3Vic3RyKDAsIDEpO1xuXHRcdGxldCBjaGFyMiA9IHBhdHRlcm4uc3Vic3RyKDEsIDEpO1xuXHRcdGlmIChjaGFyMSA9PT0gY2hhcjEudG9Mb3dlckNhc2UoY2hhcjEpKSB7XG5cdFx0XHRyZXR1cm4gc3RyaW5nLnRvTG93ZXJDYXNlKCk7XG5cdFx0fSBlbHNlIGlmIChjaGFyMiA9PT0gY2hhcjIudG9Mb3dlckNhc2UoKSkge1xuXHRcdFx0cmV0dXJuIHN0cmluZy5zdWJzdHJpbmcoMCwgMSkudG9VcHBlckNhc2UoKSArIHN0cmluZy5zdWJzdHJpbmcoMSkudG9Mb3dlckNhc2UoKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0cmV0dXJuIHN0cmluZy50b1VwcGVyQ2FzZSgpO1xuXHRcdH1cblx0fSxcblx0bG9hZDogZnVuY3Rpb24obG9jYWxlLCB0dCkge1xuXHRcdGxldCB0YWJsZXMgPSBaZXNrLmdldChcInRyYW5zbGF0aW9uLXRhYmxlXCIsIHt9KTtcblx0XHR0YWJsZXNbbG9jYWxlXSA9IHR0O1xuXHR9LFxufTtcbkxvY2FsZS50cmFuc2xhdGlvbihcImVuXCIsIHtcblx0XCJwbHVyYWw6PWRheVwiOiBcImRheXNcIixcblx0XCJwbHVyYWw6PXN0YWZmXCI6IFwic3RhZmZcIixcblx0XCJwbHVyYWw6PXNoZWVwXCI6IFwic2hlZXBcIixcblx0XCJwbHVyYWw6PW9jdG9wdXNcIjogXCJvY3RvcGlcIixcblx0XCJwbHVyYWw6PW5ld3NcIjogXCJuZXdzXCIsXG59KTtcbkxvY2FsZS5fXyA9IGZ1bmN0aW9uKHBocmFzZSwgbWFwKSB7XG5cdGlmIChfLmlzVW5kZWZpbmVkKHBocmFzZSkpIHtcblx0XHRyZXR1cm4gXCItdW5kZWZpbmVkLXZhbHVlLVwiO1xuXHR9XG5cdGlmIChwaHJhc2UgaW5zdGFuY2VvZiBPYmplY3QpIHtcblx0XHRaZXNrLmVhY2gocGhyYXNlLCBmdW5jdGlvbihrKSB7XG5cdFx0XHRwaHJhc2Vba10gPSBMb2NhbGUuX18ocGhyYXNlW2tdLCBtYXApO1xuXHRcdH0pO1xuXHRcdHJldHVybiBwaHJhc2U7XG5cdH1cblx0cGhyYXNlID0gTG9jYWxlLnRyYW5zbGF0ZShwaHJhc2UpO1xuXHRpZiAoIWlzX29iamVjdChtYXApKSB7XG5cdFx0cmV0dXJuIHBocmFzZTtcblx0fVxuXHRyZXR1cm4gcGhyYXNlLm1hcChtYXAsIHRydWUpO1xufTtcblxuTG9jYWxlLmR1cmF0aW9uU3RyaW5nID0gZnVuY3Rpb24oZGVsdGEsIG1pbl91bml0KSB7XG5cdGxldCBudW1iZXIgPSBudWxsO1xuXHRpZiAoZGVsdGEgPCAwKSB7XG5cdFx0ZGVsdGEgPSAtZGVsdGE7XG5cdH1cblx0aWYgKFplc2suaXNfc3RyaW5nKG1pbl91bml0KSkge1xuXHRcdG1pbl91bml0ID0gRGF0ZVRvb2xzLnVuaXRzW21pbl91bml0XSB8fCAwO1xuXHR9XG5cdFplc2suZWFjaChEYXRlVG9vbHMudW5pdHMsIGZ1bmN0aW9uKHVuaXQsIG5zZWNzKSB7XG5cdFx0aWYgKHVuaXQgPT09IG1pbl91bml0IHx8IGRlbHRhID4gbnNlY3MgKiAyIC0gMSkge1xuXHRcdFx0bnVtYmVyID0gcGFyc2VJbnQoZGVsdGEgLyBuc2VjcywgMTApO1xuXHRcdFx0cmV0dXJuIExvY2FsZS5wbHVyYWxfbihMb2NhbGUuX18odW5pdCksIG51bWJlcik7XG5cdFx0fVxuXHR9KTtcblx0cmV0dXJuIHtcblx0XHRkdXJhdGlvbjogTG9jYWxlLnBsdXJhbF9uKExvY2FsZS5fXyhEYXRlVG9vbHMuU0VDT05EKSwgcGFyc2VJbnQoZGVsdGEsIDEwKSksXG5cdFx0bnVtYmVyOiBudW1iZXIsXG5cdH07XG59O1xuXG4vKipcbiAqIE91dHB1dCBhIHN0cmluZyBsaWtlIFwiaW4gMyBkYXlzXCIsIFwiNSBob3VycyBhZ29cIlxuICpcbiAqIEBwYXJhbSB7RGF0ZX0gdHNcbiAqICAgICAgICBcdERhdGUgdG8gZ2VuZXJhdGUgc3RyaW5nXG4gKiBAcGFyYW0ge3N0cmluZ30gbWluX3VuaXRcbiAqICAgICAgICBcdE1pbmltdW0gdW5pdCB0byBvdXRwdXRcbiAqIEBwYXJhbSB7c3RyaW5nfSB6ZXJvX3N0cmluZ1xuICogICAgICAgIFx0T3B0aW9uYWwgc3RyaW5nIGlmIDwgMSB1bml0IGF3YXlcbiAqIEByZXR1cm4gc3RyaW5nXG4gKi9cbkxvY2FsZS5ub3dTdHJpbmcgPSBmdW5jdGlvbih0cywgbWluX3VuaXQsIHplcm9fc3RyaW5nKSB7XG5cdGxldCBub3cgPSBuZXcgRGF0ZSgpO1xuXHRsZXQgZGVsdGEgPSAobm93LmdldFRpbWUoKSAtIHRzLmdldFRpbWUoKSkgLyAxMDAwO1xuXHRsZXQgeyBkdXJhdGlvbiwgbnVtYmVyIH0gPSBMb2NhbGUuZHVyYXRpb25TdHJpbmcoZGVsdGEsIG1pbl91bml0KTtcblx0bGV0IHBocmFzZSA9IG51bGw7XG5cdGlmIChudW1iZXIgPT09IDAgJiYgWmVzay5pc19zdHJpbmcoemVyb19zdHJpbmcpKSB7XG5cdFx0cGhyYXNlID0gemVyb19zdHJpbmc7XG5cdH0gZWxzZSBpZiAoZGVsdGEgPCAwKSB7XG5cdFx0cGhyYXNlID0gXCJMb2NhbGU6Om5vd19zdHJpbmc6PWluIHtkdXJhdGlvbn1cIjtcblx0fSBlbHNlIHtcblx0XHRwaHJhc2UgPSBcIkxvY2FsZTo6bm93X3N0cmluZzo9e2R1cmF0aW9ufSBhZ29cIjtcblx0fVxuXHRyZXR1cm4gTG9jYWxlLl9fKHBocmFzZSwge1xuXHRcdGR1cmF0aW9uOiBkdXJhdGlvbixcblx0XHRtaW5fdW5pdDogbWluX3VuaXQsXG5cdFx0emVyb19zdHJpbmc6IHplcm9fc3RyaW5nLFxuXHR9KTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gTG9jYWxlO1xuIl19