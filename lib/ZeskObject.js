"use strict";

/**
 * Copyright &copy; 2017 Market Acumen, Inc.
 */
var _ = require("lodash");
var ZeskException = require("./ZeskException");

var $ = require("jquery");
var qs = require("qs");
var serializers = require("./MemberTypes").serializers;

var RSVP = require("rsvp-that-works");
var format = require("string-format-obj");

var ZeskObject = function ZeskObject(mixed, options) {
    this._options = _.isObject(options) ? _.cloneDeep(options) : {};
    this._class = $.extend({
        id_column: null,
        primary_keys: [],
        member_types: {},
        null: {},
        member_defaults: {}
    }, this._options.class || {}, this._class || this.class_definition());
    this._initialize_class();
    this._need_load = false;
    $.extend(this, this._class.member_defaults);
    if (mixed) {
        this._init_instance(mixed);
    }
    this._original = $.extend({}, this._members());
    this.initialize();
};

Object.assign(ZeskObject.prototype, {
    _members: function _members() {
        var _this = this;

        var result = {};
        var c = this._class;
        _.forEach(this._class.member_types, function (type, key) {
            result[key] = _this[key] || c.member_defaults[key];
        });
        return result;
    },
    /**
     * Called after object is created with "new" 
     */
    initialize: function initialize() {},
    /**
     * Called after item is fetched and initialized from remote source
     */
    fetched: function fetched() {},

    /**
     * Return the class definition
     */
    class_definition: function class_definition() {
        return {};
    },

    id_column: function id_column() {
        return this._class.id_column || null;
    },

    _initialize_class: function _initialize_class() {
        var c = this._class;
        _.forEach(c.member_types, function (type, name) {
            if (_.isUndefined(c.member_defaults[name])) {
                c.member_defaults[name] = null;
            }
        });
    },
    _init_instance: function _init_instance(mixed) {
        if (_.isObject(mixed)) {
            var self = this;
            var c = this._class;
            _.forEach(mixed, function (value, key) {
                if (!c.member_types[key]) {
                    self[key] = value;
                    // Extra value, store as usual for now.
                    return;
                }
                self[key] = value;
            });
            this._need_load = false;
        } else if ((_.isNumber(mixed) || _.isString(mixed)) && this.id_column()) {
            this[this._class.id_column] = mixed;
            this._need_load = true;
        } else {
            console.log("Unknown init type for " + this.constructor.name + ": " + mixed);
        }
    },

    super_initialize: function super_initialize() {
        this._endpoints = $.extend({
            GET: null,
            PUT: null,
            POST: null,
            DELETE: null
        }, this._endpoints || {});
    },

    is_new: function is_new() {
        var self = this,
            result = true;
        $.each(this._class.primary_keys, function () {
            if (self[this]) {
                result = false;
                return false;
            }
        });
        return result;
    },

    fetch: function fetch(options) {
        var _this2 = this;

        if (!_.isObject(options)) {
            options = {};
        }
        if (!this._endpoints.GET) {
            throw new ZeskException("{class} does not have GET endpoint", { class: this.constructor.name });
        }
        var promise = new RSVP.Promise();
        var url = this._format_url(this._endpoints.GET, options);
        this._ajax("GET", url, {
            success: function success(data) {
                _this2._fetch_resolve(data);
                _this2.fetched();
                promise.resolve(_this2, data);
            },
            error: function error(xhr, message) {
                _this2._fetch_reject();
                promise.reject(new Error(message));
            },
            dataType: "json"
        });
        return promise;
    },

    store: function store() {
        var _this3 = this;

        var promise = new RSVP.Promise();
        var method = this.is_new() ? "PUT" : "POST";
        var url = this._format_url(this._endpoints[method]);
        this._ajax(method, url, {
            success: function success(data) {
                _this3._store_resolve(data);
                data.this = _this3;
                promise.resolve(data);
            },
            error: function error(xhr, message) {
                _this3._store_reject(xhr, message);
                promise.reject(new Error(message));
            },
            data: this._storeData()
        });
        return promise;
    },

    _objectToId: function _objectToId(v) {
        if (!_.isObject(v)) {
            return null;
        }
        if (v._class && v._class.id_column) {
            return v[v._class.id_column];
        }
        if (v.id) {
            return v.id;
        }
        return null;
    },

    _convertType: function _convertType(value, type) {
        if (value === null) {
            return null;
        }
        if (type === "object") {
            var newvalue = this._objectToId(value);
            if (newvalue !== null) {
                return newvalue;
            }
        }
        if (serializers[type]) {
            return serializers[type](value);
        }
        return String(value);
    },
    _storeData: function _storeData() {
        var _this4 = this;

        var c = this._class;
        var data = {};
        _.forEach(c.member_types, function (type, key) {
            var value = _this4._convertType(_this4[key], type);
            if (value !== null || c.null[key]) {
                data[key] = value;
            }
        });
        return data;
    },

    _format_url: function _format_url(url) {
        var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

        var q = qs.stringify(options);
        var u = format(url, this);
        if (!q) {
            return u;
        }
        return u + (q && u.indexOf("?") >= 0 ? "&" : "?") + q;
    },

    _ajax: function _ajax(method, url, data) {
        data = data || {};
        if (_.isObject(data.data)) {
            data.data = JSON.stringify(data.data);
        }
        $.ajax(url, $.extend({
            dataType: "json",
            contentType: "application/json",
            context: this,
            method: method
        }, data));
    },

    /**
     * Run on each child object as fetched as a member of this object. Should convert to a JavaScript class.
     */
    _resolve_object: function _resolve_object(data) {
        return data;
    },
    _fetch_resolve: function _fetch_resolve(data) {
        var self = this;
        var c = this._class;
        $.each(data, function (member) {
            if (member.substr(0, 1) === "_") {
                return;
            }
            if (c.member_types[member]) {
                if (_.isObject(this)) {
                    self[member] = self._resolve_object(this);
                } else {
                    self[member] = this;
                }
            }
        });
        this._need_load = false;
        console.log("Loaded " + this.constructor.name + " #" + this[this._class.id_column]);
    },

    _fetch_reject: function _fetch_reject(xhr, message) {
        console.error("Fetch of object failed " + message);
    },
    _store_resolve: function _store_resolve(data) {
        if (data.status) {
            console.info("Store of object succeeded. Result: " + JSON.stringify(data));
        } else {
            console.error("Store of object failed in application (status). Data follows.");
            console.error(data);
        }
    },
    _store_reject: function _store_reject(xhr, message) {
        console.error("Store of object failed. Result: " + message);
    }
});

ZeskObject.mixedToId = function (mixed) {
    if (_.isNumber(mixed)) {
        return parseInt(mixed, 10);
    }
    if (_.isObject(mixed)) {
        return mixed;
    }
};

ZeskObject.fetchById = function (Constructor, mixed) {
    var result = new Constructor(mixed);
    return result.fetch();
};

module.exports = ZeskObject;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9aZXNrT2JqZWN0LmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiWmVza0V4Y2VwdGlvbiIsIiQiLCJxcyIsInNlcmlhbGl6ZXJzIiwiUlNWUCIsImZvcm1hdCIsIlplc2tPYmplY3QiLCJtaXhlZCIsIm9wdGlvbnMiLCJfb3B0aW9ucyIsImlzT2JqZWN0IiwiY2xvbmVEZWVwIiwiX2NsYXNzIiwiZXh0ZW5kIiwiaWRfY29sdW1uIiwicHJpbWFyeV9rZXlzIiwibWVtYmVyX3R5cGVzIiwibnVsbCIsIm1lbWJlcl9kZWZhdWx0cyIsImNsYXNzIiwiY2xhc3NfZGVmaW5pdGlvbiIsIl9pbml0aWFsaXplX2NsYXNzIiwiX25lZWRfbG9hZCIsIl9pbml0X2luc3RhbmNlIiwiX29yaWdpbmFsIiwiX21lbWJlcnMiLCJpbml0aWFsaXplIiwiT2JqZWN0IiwiYXNzaWduIiwicHJvdG90eXBlIiwicmVzdWx0IiwiYyIsImZvckVhY2giLCJ0eXBlIiwia2V5IiwiZmV0Y2hlZCIsIm5hbWUiLCJpc1VuZGVmaW5lZCIsInNlbGYiLCJ2YWx1ZSIsImlzTnVtYmVyIiwiaXNTdHJpbmciLCJjb25zb2xlIiwibG9nIiwiY29uc3RydWN0b3IiLCJzdXBlcl9pbml0aWFsaXplIiwiX2VuZHBvaW50cyIsIkdFVCIsIlBVVCIsIlBPU1QiLCJERUxFVEUiLCJpc19uZXciLCJlYWNoIiwiZmV0Y2giLCJwcm9taXNlIiwiUHJvbWlzZSIsInVybCIsIl9mb3JtYXRfdXJsIiwiX2FqYXgiLCJzdWNjZXNzIiwiX2ZldGNoX3Jlc29sdmUiLCJkYXRhIiwicmVzb2x2ZSIsImVycm9yIiwieGhyIiwibWVzc2FnZSIsIl9mZXRjaF9yZWplY3QiLCJyZWplY3QiLCJFcnJvciIsImRhdGFUeXBlIiwic3RvcmUiLCJtZXRob2QiLCJfc3RvcmVfcmVzb2x2ZSIsInRoaXMiLCJfc3RvcmVfcmVqZWN0IiwiX3N0b3JlRGF0YSIsIl9vYmplY3RUb0lkIiwidiIsImlkIiwiX2NvbnZlcnRUeXBlIiwibmV3dmFsdWUiLCJTdHJpbmciLCJxIiwic3RyaW5naWZ5IiwidSIsImluZGV4T2YiLCJKU09OIiwiYWpheCIsImNvbnRlbnRUeXBlIiwiY29udGV4dCIsIl9yZXNvbHZlX29iamVjdCIsIm1lbWJlciIsInN1YnN0ciIsInN0YXR1cyIsImluZm8iLCJtaXhlZFRvSWQiLCJwYXJzZUludCIsImZldGNoQnlJZCIsIkNvbnN0cnVjdG9yIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7O0FBR0EsSUFBSUEsSUFBSUMsUUFBUSxRQUFSLENBQVI7QUFDQSxJQUFJQyxnQkFBZ0JELFFBQVEsaUJBQVIsQ0FBcEI7O0FBRUEsSUFBSUUsSUFBSUYsUUFBUSxRQUFSLENBQVI7QUFDQSxJQUFJRyxLQUFLSCxRQUFRLElBQVIsQ0FBVDtBQUNBLElBQUlJLGNBQWNKLFFBQVEsZUFBUixFQUF5QkksV0FBM0M7O0FBRUEsSUFBSUMsT0FBT0wsUUFBUSxpQkFBUixDQUFYO0FBQ0EsSUFBSU0sU0FBU04sUUFBUSxtQkFBUixDQUFiOztBQUVBLElBQUlPLGFBQWEsU0FBYkEsVUFBYSxDQUFTQyxLQUFULEVBQWdCQyxPQUFoQixFQUF5QjtBQUN0QyxTQUFLQyxRQUFMLEdBQWdCWCxFQUFFWSxRQUFGLENBQVdGLE9BQVgsSUFBc0JWLEVBQUVhLFNBQUYsQ0FBWUgsT0FBWixDQUF0QixHQUE2QyxFQUE3RDtBQUNBLFNBQUtJLE1BQUwsR0FBY1gsRUFBRVksTUFBRixDQUNWO0FBQ0lDLG1CQUFXLElBRGY7QUFFSUMsc0JBQWMsRUFGbEI7QUFHSUMsc0JBQWMsRUFIbEI7QUFJSUMsY0FBTSxFQUpWO0FBS0lDLHlCQUFpQjtBQUxyQixLQURVLEVBUVYsS0FBS1QsUUFBTCxDQUFjVSxLQUFkLElBQXVCLEVBUmIsRUFTVixLQUFLUCxNQUFMLElBQWUsS0FBS1EsZ0JBQUwsRUFUTCxDQUFkO0FBV0EsU0FBS0MsaUJBQUw7QUFDQSxTQUFLQyxVQUFMLEdBQWtCLEtBQWxCO0FBQ0FyQixNQUFFWSxNQUFG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QVgsR0FBdUIsVUFBU0MsV0FBVCxFQUFzQjNGLEtBQXRCLEVBQTZCO0FBQ2hELFFBQUl1QixTQUFTLElBQUlvRSxXQUFKLENBQWdCM0YsS0FBaEIsQ0FBYjtBQUNBLFdBQU91QixPQUFPdUIsS0FBUCxFQUFQO0FBQ0gsQ0FIRDs7QUFLQThDLE9BQU9DLE9BQVAsR0FBaUI5RixVQUFqQiIsImZpbGUiOiJaZXNrT2JqZWN0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDb3B5cmlnaHQgJmNvcHk7IDIwMTcgTWFya2V0IEFjdW1lbiwgSW5jLlxuICovXG5sZXQgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XG5sZXQgWmVza0V4Y2VwdGlvbiA9IHJlcXVpcmUoXCIuL1plc2tFeGNlcHRpb25cIik7XG5cbmxldCAkID0gcmVxdWlyZShcImpxdWVyeVwiKTtcbmxldCBxcyA9IHJlcXVpcmUoXCJxc1wiKTtcbmxldCBzZXJpYWxpemVycyA9IHJlcXVpcmUoXCIuL01lbWJlclR5cGVzXCIpLnNlcmlhbGl6ZXJzO1xuXG52YXIgUlNWUCA9IHJlcXVpcmUoXCJyc3ZwLXRoYXQtd29ya3NcIik7XG52YXIgZm9ybWF0ID0gcmVxdWlyZShcInN0cmluZy1mb3JtYXQtb2JqXCIpO1xuXG52YXIgWmVza09iamVjdCA9IGZ1bmN0aW9uKG1peGVkLCBvcHRpb25zKSB7XG4gICAgdGhpcy5fb3B0aW9ucyA9IF8uaXNPYmplY3Qob3B0aW9ucykgPyBfLmNsb25lRGVlcChvcHRpb25zKSA6IHt9O1xuICAgIHRoaXMuX2NsYXNzID0gJC5leHRlbmQoXG4gICAgICAgIHtcbiAgICAgICAgICAgIGlkX2NvbHVtbjogbnVsbCxcbiAgICAgICAgICAgIHByaW1hcnlfa2V5czogW10sXG4gICAgICAgICAgICBtZW1iZXJfdHlwZXM6IHt9LFxuICAgICAgICAgICAgbnVsbDoge30sXG4gICAgICAgICAgICBtZW1iZXJfZGVmYXVsdHM6IHt9LFxuICAgICAgICB9LFxuICAgICAgICB0aGlzLl9vcHRpb25zLmNsYXNzIHx8IHt9LFxuICAgICAgICB0aGlzLl9jbGFzcyB8fCB0aGlzLmNsYXNzX2RlZmluaXRpb24oKVxuICAgICk7XG4gICAgdGhpcy5faW5pdGlhbGl6ZV9jbGFzcygpO1xuICAgIHRoaXMuX25lZWRfbG9hZCA9IGZhbHNlO1xuICAgICQuZXh0ZW5kKHRoaXMsIHRoaXMuX2NsYXNzLm1lbWJlcl9kZWZhdWx0cyk7XG4gICAgaWYgKG1peGVkKSB7XG4gICAgICAgIHRoaXMuX2luaXRfaW5zdGFuY2UobWl4ZWQpO1xuICAgIH1cbiAgICB0aGlzLl9vcmlnaW5hbCA9ICQuZXh0ZW5kKHt9LCB0aGlzLl9tZW1iZXJzKCkpO1xuICAgIHRoaXMuaW5pdGlhbGl6ZSgpO1xufTtcblxuT2JqZWN0LmFzc2lnbihaZXNrT2JqZWN0LnByb3RvdHlwZSwge1xuICAgIF9tZW1iZXJzOiBmdW5jdGlvbigpIHtcbiAgICAgICAgbGV0IHJlc3VsdCA9IHt9O1xuICAgICAgICBsZXQgYyA9IHRoaXMuX2NsYXNzO1xuICAgICAgICBfLmZvckVhY2godGhpcy5fY2xhc3MubWVtYmVyX3R5cGVzLCAodHlwZSwga2V5KSA9PiB7XG4gICAgICAgICAgICByZXN1bHRba2V5XSA9IHRoaXNba2V5XSB8fCBjLm1lbWJlcl9kZWZhdWx0c1trZXldO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIENhbGxlZCBhZnRlciBvYmplY3QgaXMgY3JlYXRlZCB3aXRoIFwibmV3XCIgXG4gICAgICovXG4gICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7fSxcbiAgICAvKipcbiAgICAgKiBDYWxsZWQgYWZ0ZXIgaXRlbSBpcyBmZXRjaGVkIGFuZCBpbml0aWFsaXplZCBmcm9tIHJlbW90ZSBzb3VyY2VcbiAgICAgKi9cbiAgICBmZXRjaGVkOiBmdW5jdGlvbigpIHt9LFxuXG4gICAgLyoqXG4gICAgICogUmV0dXJuIHRoZSBjbGFzcyBkZWZpbml0aW9uXG4gICAgICovXG4gICAgY2xhc3NfZGVmaW5pdGlvbjogZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB7fTtcbiAgICB9LFxuXG4gICAgaWRfY29sdW1uOiBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NsYXNzLmlkX2NvbHVtbiB8fCBudWxsO1xuICAgIH0sXG5cbiAgICBfaW5pdGlhbGl6ZV9jbGFzczogZnVuY3Rpb24oKSB7XG4gICAgICAgIGxldCBjID0gdGhpcy5fY2xhc3M7XG4gICAgICAgIF8uZm9yRWFjaChjLm1lbWJlcl90eXBlcywgKHR5cGUsIG5hbWUpID0+IHtcbiAgICAgICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKGMubWVtYmVyX2RlZmF1bHRzW25hbWVdKSkge1xuICAgICAgICAgICAgICAgIGMubWVtYmVyX2RlZmF1bHRzW25hbWVdID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBfaW5pdF9pbnN0YW5jZTogZnVuY3Rpb24obWl4ZWQpIHtcbiAgICAgICAgaWYgKF8uaXNPYmplY3QobWl4ZWQpKSB7XG4gICAgICAgICAgICBsZXQgc2VsZiA9IHRoaXM7XG4gICAgICAgICAgICBsZXQgYyA9IHRoaXMuX2NsYXNzO1xuICAgICAgICAgICAgXy5mb3JFYWNoKG1peGVkLCAodmFsdWUsIGtleSkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICghYy5tZW1iZXJfdHlwZXNba2V5XSkge1xuICAgICAgICAgICAgICAgICAgICBzZWxmW2tleV0gPSB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgLy8gRXh0cmEgdmFsdWUsIHN0b3JlIGFzIHVzdWFsIGZvciBub3cuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgc2VsZltrZXldID0gdmFsdWU7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMuX25lZWRfbG9hZCA9IGZhbHNlO1xuICAgICAgICB9IGVsc2UgaWYgKChfLmlzTnVtYmVyKG1peGVkKSB8fCBfLmlzU3RyaW5nKG1peGVkKSkgJiYgdGhpcy5pZF9jb2x1bW4oKSkge1xuICAgICAgICAgICAgdGhpc1t0aGlzLl9jbGFzcy5pZF9jb2x1bW5dID0gbWl4ZWQ7XG4gICAgICAgICAgICB0aGlzLl9uZWVkX2xvYWQgPSB0cnVlO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJVbmtub3duIGluaXQgdHlwZSBmb3IgXCIgKyB0aGlzLmNvbnN0cnVjdG9yLm5hbWUgKyBcIjogXCIgKyBtaXhlZCk7XG4gICAgICAgIH1cbiAgICB9LFxuXG4gICAgc3VwZXJfaW5pdGlhbGl6ZTogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuX2VuZHBvaW50cyA9ICQuZXh0ZW5kKFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIEdFVDogbnVsbCxcbiAgICAgICAgICAgICAgICBQVVQ6IG51bGwsXG4gICAgICAgICAgICAgICAgUE9TVDogbnVsbCxcbiAgICAgICAgICAgICAgICBERUxFVEU6IG51bGwsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdGhpcy5fZW5kcG9pbnRzIHx8IHt9XG4gICAgICAgICk7XG4gICAgfSxcblxuICAgIGlzX25ldzogZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBzZWxmID0gdGhpcyxcbiAgICAgICAgICAgIHJlc3VsdCA9IHRydWU7XG4gICAgICAgICQuZWFjaCh0aGlzLl9jbGFzcy5wcmltYXJ5X2tleXMsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgaWYgKHNlbGZbdGhpc10pIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sXG5cbiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykge1xuICAgICAgICBpZiAoIV8uaXNPYmplY3Qob3B0aW9ucykpIHtcbiAgICAgICAgICAgIG9wdGlvbnMgPSB7fTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuX2VuZHBvaW50cy5HRVQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBaZXNrRXhjZXB0aW9uKFwie2NsYXNzfSBkb2VzIG5vdCBoYXZlIEdFVCBlbmRwb2ludFwiLCB7IGNsYXNzOiB0aGlzLmNvbnN0cnVjdG9yLm5hbWUgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHByb21pc2UgPSBuZXcgUlNWUC5Qcm9taXNlKCk7XG4gICAgICAgIHZhciB1cmwgPSB0aGlzLl9mb3JtYXRfdXJsKHRoaXMuX2VuZHBvaW50cy5HRVQsIG9wdGlvbnMpO1xuICAgICAgICB0aGlzLl9hamF4KFwiR0VUXCIsIHVybCwge1xuICAgICAgICAgICAgc3VjY2VzczogZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fZmV0Y2hfcmVzb2x2ZShkYXRhKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZldGNoZWQoKTtcbiAgICAgICAgICAgICAgICBwcm9taXNlLnJlc29sdmUodGhpcywgZGF0YSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyb3I6ICh4aHIsIG1lc3NhZ2UpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9mZXRjaF9yZWplY3QoKTtcbiAgICAgICAgICAgICAgICBwcm9taXNlLnJlamVjdChuZXcgRXJyb3IobWVzc2FnZSkpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGRhdGFUeXBlOiBcImpzb25cIixcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBwcm9taXNlO1xuICAgIH0sXG5cbiAgICBzdG9yZTogZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBwcm9taXNlID0gbmV3IFJTVlAuUHJvbWlzZSgpO1xuICAgICAgICB2YXIgbWV0aG9kID0gdGhpcy5pc19uZXcoKSA/IFwiUFVUXCIgOiBcIlBPU1RcIjtcbiAgICAgICAgbGV0IHVybCA9IHRoaXMuX2Zvcm1hdF91cmwodGhpcy5fZW5kcG9pbnRzW21ldGhvZF0pO1xuICAgICAgICB0aGlzLl9hamF4KG1ldGhvZCwgdXJsLCB7XG4gICAgICAgICAgICBzdWNjZXNzOiBkYXRhID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9zdG9yZV9yZXNvbHZlKGRhdGEpO1xuICAgICAgICAgICAgICAgIGRhdGEudGhpcyA9IHRoaXM7XG4gICAgICAgICAgICAgICAgcHJvbWlzZS5yZXNvbHZlKGRhdGEpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yOiAoeGhyLCBtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fc3RvcmVfcmVqZWN0KHhociwgbWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgcHJvbWlzZS5yZWplY3QobmV3IEVycm9yKG1lc3NhZ2UpKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkYXRhOiB0aGlzLl9zdG9yZURhdGEoKSxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBwcm9taXNlO1xuICAgIH0sXG5cbiAgICBfb2JqZWN0VG9JZDogZnVuY3Rpb24odikge1xuICAgICAgICBpZiAoIV8uaXNPYmplY3QodikpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2Ll9jbGFzcyAmJiB2Ll9jbGFzcy5pZF9jb2x1bW4pIHtcbiAgICAgICAgICAgIHJldHVybiB2W3YuX2NsYXNzLmlkX2NvbHVtbl07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHYuaWQpIHtcbiAgICAgICAgICAgIHJldHVybiB2LmlkO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH0sXG5cbiAgICBfY29udmVydFR5cGU6IGZ1bmN0aW9uKHZhbHVlLCB0eXBlKSB7XG4gICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGUgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgIGxldCBuZXd2YWx1ZSA9IHRoaXMuX29iamVjdFRvSWQodmFsdWUpO1xuICAgICAgICAgICAgaWYgKG5ld3ZhbHVlICE9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ld3ZhbHVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmIChzZXJpYWxpemVyc1t0eXBlXSkge1xuICAgICAgICAgICAgcmV0dXJuIHNlcmlhbGl6ZXJzW3R5cGVdKHZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKTtcbiAgICB9LFxuICAgIF9zdG9yZURhdGE6IGZ1bmN0aW9uKCkge1xuICAgICAgICBsZXQgYyA9IHRoaXMuX2NsYXNzO1xuICAgICAgICBsZXQgZGF0YSA9IHt9O1xuICAgICAgICBfLmZvckVhY2goYy5tZW1iZXJfdHlwZXMsICh0eXBlLCBrZXkpID0+IHtcbiAgICAgICAgICAgIGxldCB2YWx1ZSA9IHRoaXMuX2NvbnZlcnRUeXBlKHRoaXNba2V5XSwgdHlwZSk7XG4gICAgICAgICAgICBpZiAodmFsdWUgIT09IG51bGwgfHwgYy5udWxsW2tleV0pIHtcbiAgICAgICAgICAgICAgICBkYXRhW2tleV0gPSB2YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgIH0sXG5cbiAgICBfZm9ybWF0X3VybDogZnVuY3Rpb24odXJsLCBvcHRpb25zID0ge30pIHtcbiAgICAgICAgdmFyIHEgPSBxcy5zdHJpbmdpZnkob3B0aW9ucyk7XG4gICAgICAgIHZhciB1ID0gZm9ybWF0KHVybCwgdGhpcyk7XG4gICAgICAgIGlmICghcSkge1xuICAgICAgICAgICAgcmV0dXJuIHU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHUgKyAocSAmJiB1LmluZGV4T2YoXCI/XCIpID49IDAgPyBcIiZcIiA6IFwiP1wiKSArIHE7XG4gICAgfSxcblxuICAgIF9hamF4OiBmdW5jdGlvbihtZXRob2QsIHVybCwgZGF0YSkge1xuICAgICAgICBkYXRhID0gZGF0YSB8fCB7fTtcbiAgICAgICAgaWYgKF8uaXNPYmplY3QoZGF0YS5kYXRhKSkge1xuICAgICAgICAgICAgZGF0YS5kYXRhID0gSlNPTi5zdHJpbmdpZnkoZGF0YS5kYXRhKTtcbiAgICAgICAgfVxuICAgICAgICAkLmFqYXgoXG4gICAgICAgICAgICB1cmwsXG4gICAgICAgICAgICAkLmV4dGVuZChcbiAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiBcImpzb25cIixcbiAgICAgICAgICAgICAgICAgICAgY29udGVudFR5cGU6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICAgICAgICAgICAgICBjb250ZXh0OiB0aGlzLFxuICAgICAgICAgICAgICAgICAgICBtZXRob2Q6IG1ldGhvZCxcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIGRhdGFcbiAgICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICB9LFxuXG4gICAgLyoqXG4gICAgICogUnVuIG9uIGVhY2ggY2hpbGQgb2JqZWN0IGFzIGZldGNoZWQgYXMgYSBtZW1iZXIgb2YgdGhpcyBvYmplY3QuIFNob3VsZCBjb252ZXJ0IHRvIGEgSmF2YVNjcmlwdCBjbGFzcy5cbiAgICAgKi9cbiAgICBfcmVzb2x2ZV9vYmplY3Q6IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfSxcbiAgICBfZmV0Y2hfcmVzb2x2ZTogZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgICAgIHZhciBjID0gdGhpcy5fY2xhc3M7XG4gICAgICAgICQuZWFjaChkYXRhLCBmdW5jdGlvbihtZW1iZXIpIHtcbiAgICAgICAgICAgIGlmIChtZW1iZXIuc3Vic3RyKDAsIDEpID09PSBcIl9cIikge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChjLm1lbWJlcl90eXBlc1ttZW1iZXJdKSB7XG4gICAgICAgICAgICAgICAgaWYgKF8uaXNPYmplY3QodGhpcykpIHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZlttZW1iZXJdID0gc2VsZi5fcmVzb2x2ZV9vYmplY3QodGhpcyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZlttZW1iZXJdID0gdGhpcztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLl9uZWVkX2xvYWQgPSBmYWxzZTtcbiAgICAgICAgY29uc29sZS5sb2coXCJMb2FkZWQgXCIgKyB0aGlzLmNvbnN0cnVjdG9yLm5hbWUgKyBcIiAjXCIgKyB0aGlzW3RoaXMuX2NsYXNzLmlkX2NvbHVtbl0pO1xuICAgIH0sXG5cbiAgICBfZmV0Y2hfcmVqZWN0OiBmdW5jdGlvbih4aHIsIG1lc3NhZ2UpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIkZldGNoIG9mIG9iamVjdCBmYWlsZWQgXCIgKyBtZXNzYWdlKTtcbiAgICB9LFxuICAgIF9zdG9yZV9yZXNvbHZlOiBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgIGlmIChkYXRhLnN0YXR1cykge1xuICAgICAgICAgICAgY29uc29sZS5pbmZvKFwiU3RvcmUgb2Ygb2JqZWN0IHN1Y2NlZWRlZC4gUmVzdWx0OiBcIiArIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJTdG9yZSBvZiBvYmplY3QgZmFpbGVkIGluIGFwcGxpY2F0aW9uIChzdGF0dXMpLiBEYXRhIGZvbGxvd3MuXCIpO1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihkYXRhKTtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgX3N0b3JlX3JlamVjdDogZnVuY3Rpb24oeGhyLCBtZXNzYWdlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJTdG9yZSBvZiBvYmplY3QgZmFpbGVkLiBSZXN1bHQ6IFwiICsgbWVzc2FnZSk7XG4gICAgfSxcbn0pO1xuXG5aZXNrT2JqZWN0Lm1peGVkVG9JZCA9IGZ1bmN0aW9uKG1peGVkKSB7XG4gICAgaWYgKF8uaXNOdW1iZXIobWl4ZWQpKSB7XG4gICAgICAgIHJldHVybiBwYXJzZUludChtaXhlZCwgMTApO1xuICAgIH1cbiAgICBpZiAoXy5pc09iamVjdChtaXhlZCkpIHtcbiAgICAgICAgcmV0dXJuIG1peGVkO1xuICAgIH1cbn07XG5cblplc2tPYmplY3QuZmV0Y2hCeUlkID0gZnVuY3Rpb24oQ29uc3RydWN0b3IsIG1peGVkKSB7XG4gICAgdmFyIHJlc3VsdCA9IG5ldyBDb25zdHJ1Y3RvcihtaXhlZCk7XG4gICAgcmV0dXJuIHJlc3VsdC5mZXRjaCgpO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBaZXNrT2JqZWN0O1xuIl19