"use strict";

/*
 * $Id$
 *
 * Copyright (C) 2017 Market Acumen, Inc. All rights reserved
 */
// import _ from "lodash";
// import ZeskException from "./ZeskException";

// import $ from "jquery";
// import qs from "qs";

var _ = require("lodash");
var ZeskException = require("./ZeskException");

var $ = require("jquery");
var qs = require("qs");

var RSVP = require("rsvp-that-works");
var format = require("string-format-obj");

var ZeskObject = function ZeskObject(mixed, options) {
    this._class = $.extend({
        id_column: null,
        primary_keys: [],
        member_types: {},
        member_defaults: {}
    }, this._class || this.class_definition());
    this._initialize_class();
    this._options = _.isObject(options) ? _.cloneDeep(options) : {};
    this._need_load = false;
    $.extend(this, this._class.member_defaults);
    if (mixed) {
        this._init_instance(mixed);
    }
    this._original = $.extend({}, this._members());
    this.initialize();
};

Object.assign(ZeskObject.prototype, {
    _members: function _members() {
        var _this = this;

        var result = {};
        var c = this._class;
        _.forEach(this._class.member_types, function (type, key) {
            result[key] = _this[key] || c.member_defaults[key];
        });
        return result;
    },
    class_definition: function class_definition() {
        return {};
    },

    id_column: function id_column() {
        return this._class.id_column || null;
    },

    _initialize_class: function _initialize_class() {
        var c = this._class;
        _.forEach(c.member_types, function (type, name) {
            if (_.isUndefined(c.member_defaults[name])) {
                c.member_defaults[name] = null;
            }
        });
    },
    _init_instance: function _init_instance(mixed) {
        if (_.isObject(mixed)) {
            var self = this;
            var c = this._class;
            _.forEach(mixed, function (value, key) {
                if (!c.member_types[key]) {
                    self[key] = value;
                    // Extra value, store as usual for now.
                    return;
                }
                self[key] = value;
            });
            this._need_load = false;
        } else if ((_.isNumber(mixed) || _.isString(mixed)) && this.id_column()) {
            this[this._class.id_column] = mixed;
            this._need_load = true;
        } else {
            console.log("Unknown init type for " + this.constructor.name + ": " + mixed);
        }
    },

    super_initialize: function super_initialize() {
        this._endpoints = $.extend({
            GET: null,
            PUT: null,
            POST: null,
            DELETE: null
        }, this._endpoints || {});
    },

    is_new: function is_new() {
        var self = this,
            result = true;
        $.each(this._class.primary_keys, function () {
            if (self[this]) {
                result = false;
                return false;
            }
        });
        return result;
    },

    fetch: function fetch(options) {
        var _this2 = this;

        if (!_.isObject(options)) {
            options = {};
        }
        if (!this._endpoints.GET) {
            throw new ZeskException("{class} does not have GET endpoint", { class: this.constructor.name });
        }
        var promise = new RSVP.Promise();
        var url = this._format_url(this._endpoints.GET, options);
        this._ajax("GET", url, {
            success: function success(data) {
                this._fetch_resolve(data);
                promise.resolve(this, data);
            },
            error: function error(xhr, message) {
                _this2._fetch_reject();
                promise.reject(new Error(message));
            },
            dataType: "json"
        });
        return promise;
    },

    store: function store() {
        var _this3 = this;

        var promise = new RSVP.Promise();
        this._ajax(this.is_new() ? "POST" : "PUT", this._format_url(this._endpoints.PUT), {
            success: function success(data) {
                _this3._store_resolve(data);
                promise.resolve(_this3, data);
            },
            error: function error(xhr, message) {
                _this3._store_reject(xhr, message);
                promise.reject(new Error(message));
            }
        });
        return promise;
    },

    _format_url: function _format_url(url) {
        var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

        var q = qs.stringify(options);
        var u = format(url, this);
        if (!q) {
            return u;
        }
        return u + (q && u.indexOf("?") >= 0 ? "&" : "?") + q;
    },

    _ajax: function _ajax(method, url, data) {
        data = data || {};
        if (_.isObject(data.data)) {
            data.data = JSON.stringify(data.data);
        }
        $.ajax(url, $.extend({
            dataType: "json",
            contentType: "application/json",
            context: this,
            method: method
        }, data));
    },

    /**
     * Run on each child object as fetched as a member of this object. Should convert to a JavaScript class.
     */
    _resolve_object: function _resolve_object(data) {
        return data;
    },
    _fetch_resolve: function _fetch_resolve(data) {
        var self = this;
        var c = this._class;
        $.each(data, function (member) {
            if (member.substr(0, 1) === "_") {
                return;
            }
            if (c.member_types[member]) {
                if (_.isObject(this)) {
                    self[member] = self._resolve_object(this);
                } else {
                    self[member] = this;
                }
            }
        });
        this._need_load = false;
        console.log("Loaded " + this.constructor.name + " #" + this[this._class.id_column]);
    },

    _fetch_reject: function _fetch_reject(xhr, message) {},
    _store_resolve: function _store_resolve(data) {},

    _store_reject: function _store_reject(xhr, message) {}
});

ZeskObject.mixedToId = function (mixed) {
    if (_.isNumber(mixed)) {
        return parseInt(mixed, 10);
    }
    if (_.isObject(mixed)) {
        return mixed;
    }
};

ZeskObject.fetchById = function (Constructor, mixed) {
    var result = new Constructor(mixed);
    return result.fetch();
};

module.exports = ZeskObject;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9aZXNrT2JqZWN0LmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiWmVza0V4Y2VwdGlvbiIsIiQiLCJxcyIsIlJTVlAiLCJmb3JtYXQiLCJaZXNrT2JqZWN0IiwibWl4ZWQiLCJvcHRpb25zIiwiX2NsYXNzIiwiZXh0ZW5kIiwiaWRfY29sdW1uIiwicHJpbWFyeV9rZXlzIiwibWVtYmVyX3R5cGVzIiwibWVtYmVyX2RlZmF1bHRzIiwiY2xhc3NfZGVmaW5pdGlvbiIsIl9pbml0aWFsaXplX2NsYXNzIiwiX29wdGlvbnMiLCJpc09iamVjdCIsImNsb25lRGVlcCIsIl9uZWVkX2xvYWQiLCJfaW5pdF9pbnN0YW5jZSIsIl9vcmlnaW5hbCIsIl9tZW1iZXJzIiwiaW5pdGlhbGl6ZSIsIk9iamVjdCIsImFzc2lnbiIsInByb3RvdHlwZSIsInJlc3VsdCIsImMiLCJmb3JFYWNoIiwidHlwZSIsImtleSIsIm5hbWUiLCJpc1VuZGVmaW5lZCIsInNlbGYiLCJ2YWx1ZSIsImlzTnVtYmVyIiwiaXNTdHJpbmciLCJjb25zb2xlIiwibG9nIiwiY29uc3RydWN0b3IiLCJzdXBlcl9pbml0aWFsaXplIiwiX2VuZHBvaW50cyIsIkdFVCIsIlBVVCIsIlBPU1QiLCJERUxFVEUiLCJpc19uZXciLCJlYWNoIiwiZmV0Y2giLCJjbGFzcyIsInByb21pc2UiLCJQcm9taXNlIiwidXJsIiwiX2Zvcm1hdF91cmwiLCJfYWpheCIsInN1Y2Nlc3MiLCJkYXRhIiwiX2ZldGNoX3Jlc29sdmUiLCJyZXNvbHZlIiwiZXJyb3IiLCJ4aHIiLCJtZXNzYWdlIiwiX2ZldGNoX3JlamVjdCIsInJlamVjdCIsIkVycm9yIiwiZGF0YVR5cGUiLCJzdG9yZSIsIl9zdG9yZV9yZXNvbHZlIiwiX3N0b3JlX3JlamVjdCIsInEiLCJzdHJpbmdpZnkiLCJ1IiwiaW5kZXhPZiIsIm1ldGhvZCIsIkpTT04iLCJhamF4IiwiY29udGVudFR5cGUiLCJjb250ZXh0IiwiX3Jlc29sdmVfb2JqZWN0IiwibWVtYmVyIiwic3Vic3RyIiwibWl4ZWRUb0lkIiwicGFyc2VJbnQiLCJmZXRjaEJ5SWQiLCJDb25zdHJ1Y3RvciIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7O0FBS0E7QUFDQTs7QUFFQTtBQUNBOztBQUVBLElBQUlBLElBQUlDLFFBQVEsUUFBUixDQUFSO0FBQ0EsSUFBSUMsZ0JBQWdCRCxRQUFRLGlCQUFSLENBQXBCOztBQUVBLElBQUlFLElBQUlGLFFBQVEsUUFBUixDQUFSO0FBQ0EsSUFBSUcsS0FBS0gsUUFBUSxJQUFSLENBQVQ7O0FBRUEsSUFBSUksT0FBT0osUUFBUSxpQkFBUixDQUFYO0FBQ0EsSUFBSUssU0FBU0wsUUFBUSxtQkFBUixDQUFiOztBQUVBLElBQUlNLGFBQWEsU0FBYkEsVUFBYSxDQUFTQyxLQUFULEVBQWVDLE9BQWYsRUFBd0I7QUFDckMsU0FBS0MsTUFBTCxHQUFjUCxFQUFFUSxNQUFGLENBQ1Y7QUFDSUMsbUJBQVcsSUFEZjtBQUVJQyxzQkFBYyxFQUZsQjtBQUdJQyxzQkFBYyxFQUhsQjtBQUlJQyx5QkFBaUI7QUFKckIsS0FEVSxFQU9WLEtBQUtMLE1BQUwsSUFBZSxLQUFLTSxnQkFBTCxFQVBMLENBQWQ7QUFTQSxTQUFLQyxpQkFBTDtBQUNBLFNBQUtDLFFBQUwsR0FBZ0JsQixFQUFFbUIsUUFBRixDQUFXVixPQUFYLElBQXNCVCxFQUFFb0IsU0FBRixDQUFZWCxPQUFaLENBQXRCLEdBQTZDLEVBQTdEO0FBQ0EsU0FBS1ksVUFBTCxHQUFrQixLQUFsQjtBQUNBbEIsTUFBRVEsTUFBRixDQUFTLElBQVQsRUFBZSxLQUFLRCxNQUFMLENBQVlLLGVBQTNCO0FBQ0EsUUFBSVAsS0FBSixFQUFXO0FBQ1AsYUFBS2MsY0FBTCxDQUFvQmQsS0FBcEI7QUFDSDtBQUNELFNBQUtlLFNBQUwsR0FBaUJwQixFQUFFUSxNQUFGLENBQVMsRUFBVCxFQUFhLEtBQUthLFFBQUwsRUFBYixDQUFqQjtBQUNBLFNBQUtDLFVBQUw7QUFDSCxDQW5CRDs7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RXNDLFFBQUYsQ0FBVzlCLEtBQVgsQ0FBSixFQUF1QjtBQUNuQixlQUFPNkUsU0FBUzdFLEtBQVQsRUFBZ0IsRUFBaEIsQ0FBUDtBQUNIO0FBQ0QsUUFBSVIsRUFBRW1CLFFBQUYsQ0FBV1gsS0FBWCxDQUFKLEVBQXVCO0FBQ25CLGVBQU9BLEtBQVA7QUFDSDtBQUNKLENBUEQ7O0FBU0FELFdBQVcrRSxTQUFYLEdBQXVCLFVBQVNDLFdBQVQsRUFBc0IvRSxLQUF0QixFQUE2QjtBQUNoRCxRQUFJcUIsU0FBUyxJQUFJMEQsV0FBSixDQUFnQi9FLEtBQWhCLENBQWI7QUFDQSxXQUFPcUIsT0FBT3NCLEtBQVAsRUFBUDtBQUNILENBSEQ7O0FBS0FxQyxPQUFPQyxPQUFQLEdBQWlCbEYsVUFBakIiLCJmaWxlIjoiWmVza09iamVjdC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiAkSWQkXG4gKlxuICogQ29weXJpZ2h0IChDKSAyMDE3IE1hcmtldCBBY3VtZW4sIEluYy4gQWxsIHJpZ2h0cyByZXNlcnZlZFxuICovXG4vLyBpbXBvcnQgXyBmcm9tIFwibG9kYXNoXCI7XG4vLyBpbXBvcnQgWmVza0V4Y2VwdGlvbiBmcm9tIFwiLi9aZXNrRXhjZXB0aW9uXCI7XG5cbi8vIGltcG9ydCAkIGZyb20gXCJqcXVlcnlcIjtcbi8vIGltcG9ydCBxcyBmcm9tIFwicXNcIjtcblxubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xubGV0IFplc2tFeGNlcHRpb24gPSByZXF1aXJlKFwiLi9aZXNrRXhjZXB0aW9uXCIpO1xuXG5sZXQgJCA9IHJlcXVpcmUoXCJqcXVlcnlcIik7XG5sZXQgcXMgPSByZXF1aXJlKFwicXNcIik7XG5cbnZhciBSU1ZQID0gcmVxdWlyZShcInJzdnAtdGhhdC13b3Jrc1wiKTtcbnZhciBmb3JtYXQgPSByZXF1aXJlKFwic3RyaW5nLWZvcm1hdC1vYmpcIik7XG5cbnZhciBaZXNrT2JqZWN0ID0gZnVuY3Rpb24obWl4ZWQsb3B0aW9ucykge1xuICAgIHRoaXMuX2NsYXNzID0gJC5leHRlbmQoXG4gICAgICAgIHtcbiAgICAgICAgICAgIGlkX2NvbHVtbjogbnVsbCxcbiAgICAgICAgICAgIHByaW1hcnlfa2V5czogW10sXG4gICAgICAgICAgICBtZW1iZXJfdHlwZXM6IHt9LFxuICAgICAgICAgICAgbWVtYmVyX2RlZmF1bHRzOiB7fSxcbiAgICAgICAgfSxcbiAgICAgICAgdGhpcy5fY2xhc3MgfHwgdGhpcy5jbGFzc19kZWZpbml0aW9uKClcbiAgICApO1xuICAgIHRoaXMuX2luaXRpYWxpemVfY2xhc3MoKTtcbiAgICB0aGlzLl9vcHRpb25zID0gXy5pc09iamVjdChvcHRpb25zKSA/IF8uY2xvbmVEZWVwKG9wdGlvbnMpIDoge307XG4gICAgdGhpcy5fbmVlZF9sb2FkID0gZmFsc2U7XG4gICAgJC5leHRlbmQodGhpcywgdGhpcy5fY2xhc3MubWVtYmVyX2RlZmF1bHRzKTtcbiAgICBpZiAobWl4ZWQpIHtcbiAgICAgICAgdGhpcy5faW5pdF9pbnN0YW5jZShtaXhlZCk7XG4gICAgfVxuICAgIHRoaXMuX29yaWdpbmFsID0gJC5leHRlbmQoe30sIHRoaXMuX21lbWJlcnMoKSk7XG4gICAgdGhpcy5pbml0aWFsaXplKCk7XG59O1xuXG5PYmplY3QuYXNzaWduKFplc2tPYmplY3QucHJvdG90eXBlLCB7XG5fbWVtYmVyczogZnVuY3Rpb24gKCkge1xuICAgIGxldCByZXN1bHQgPSB7fTtcbiAgICBsZXQgYyA9IHRoaXMuX2NsYXNzO1xuICAgIF8uZm9yRWFjaCh0aGlzLl9jbGFzcy5tZW1iZXJfdHlwZXMsICh0eXBlLCBrZXkpID0+IHtcbiAgICAgICAgcmVzdWx0W2tleV0gPSB0aGlzW2tleV0gfHwgYy5tZW1iZXJfZGVmYXVsdHNba2V5XTtcbiAgICB9KTtcbiAgICByZXR1cm4gcmVzdWx0O1xufSxcbmNsYXNzX2RlZmluaXRpb246IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuIHt9O1xuICAgIH0sXG5cbmlkX2NvbHVtbjogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB0aGlzLl9jbGFzcy5pZF9jb2x1bW4gfHwgbnVsbDtcbn0sXG5cbl9pbml0aWFsaXplX2NsYXNzOiBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IGMgPSB0aGlzLl9jbGFzcztcbiAgICBfLmZvckVhY2goYy5tZW1iZXJfdHlwZXMsICh0eXBlLCBuYW1lKSA9PiB7XG4gICAgICAgIGlmIChfLmlzVW5kZWZpbmVkKGMubWVtYmVyX2RlZmF1bHRzW25hbWVdKSkge1xuICAgICAgICAgICAgYy5tZW1iZXJfZGVmYXVsdHNbbmFtZV0gPSBudWxsO1xuICAgICAgICB9XG4gICAgfSk7XG59LFxuICAgX2luaXRfaW5zdGFuY2U6IGZ1bmN0aW9uIChtaXhlZCkge1xuICAgICAgICBpZiAoXy5pc09iamVjdChtaXhlZCkpIHtcbiAgICAgICAgICAgIGxldCBzZWxmID0gdGhpcztcbiAgICAgICAgICAgIGxldCBjID0gdGhpcy5fY2xhc3M7XG4gICAgICAgICAgICBfLmZvckVhY2gobWl4ZWQsICh2YWx1ZSwga2V5KSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFjLm1lbWJlcl90eXBlc1trZXldKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGZba2V5XSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgICAgICAvLyBFeHRyYSB2YWx1ZSwgc3RvcmUgYXMgdXN1YWwgZm9yIG5vdy5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzZWxmW2tleV0gPSB2YWx1ZTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5fbmVlZF9sb2FkID0gZmFsc2U7XG4gICAgICAgIH0gZWxzZSBpZiAoKF8uaXNOdW1iZXIobWl4ZWQpIHx8IF8uaXNTdHJpbmcobWl4ZWQpKSAmJiB0aGlzLmlkX2NvbHVtbigpKSB7XG4gICAgICAgICAgICB0aGlzW3RoaXMuX2NsYXNzLmlkX2NvbHVtbl0gPSBtaXhlZDtcbiAgICAgICAgICAgIHRoaXMuX25lZWRfbG9hZCA9IHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlVua25vd24gaW5pdCB0eXBlIGZvciBcIiArIHRoaXMuY29uc3RydWN0b3IubmFtZSArIFwiOiBcIiArIG1peGVkKTtcbiAgICAgICAgfVxuICAgIH0sXG5cbiAgICBzdXBlcl9pbml0aWFsaXplOiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHRoaXMuX2VuZHBvaW50cyA9ICQuZXh0ZW5kKFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIEdFVDogbnVsbCxcbiAgICAgICAgICAgICAgICBQVVQ6IG51bGwsXG4gICAgICAgICAgICAgICAgUE9TVDogbnVsbCxcbiAgICAgICAgICAgICAgICBERUxFVEU6IG51bGwsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgdGhpcy5fZW5kcG9pbnRzIHx8IHt9XG4gICAgICAgICk7XG4gICAgfSxcblxuICAgIGlzX25ldzogZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXMsIHJlc3VsdCA9IHRydWU7XG4gICAgICAgICQuZWFjaCh0aGlzLl9jbGFzcy5wcmltYXJ5X2tleXMsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgaWYgKHNlbGZbdGhpc10pIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0sXG5cbiAgICBmZXRjaDogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCFfLmlzT2JqZWN0KG9wdGlvbnMpKSB7XG4gICAgICAgICAgIG9wdGlvbnMgPSB7fTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuX2VuZHBvaW50cy5HRVQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBaZXNrRXhjZXB0aW9uKFwie2NsYXNzfSBkb2VzIG5vdCBoYXZlIEdFVCBlbmRwb2ludFwiLCB7IGNsYXNzOiB0aGlzLmNvbnN0cnVjdG9yLm5hbWUgfSk7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIHByb21pc2UgPSBuZXcgUlNWUC5Qcm9taXNlKCk7XG4gICAgICAgIHZhciB1cmwgPSB0aGlzLl9mb3JtYXRfdXJsKHRoaXMuX2VuZHBvaW50cy5HRVQsIG9wdGlvbnMpO1xuICAgICAgICB0aGlzLl9hamF4KFwiR0VUXCIsIHVybCwge1xuICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgIHRoaXMuX2ZldGNoX3Jlc29sdmUoZGF0YSk7XG4gICAgICAgICAgICAgICAgcHJvbWlzZS5yZXNvbHZlKHRoaXMsIGRhdGEpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yOiAoeGhyLCBtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fZmV0Y2hfcmVqZWN0KCk7XG4gICAgICAgICAgICAgICAgcHJvbWlzZS5yZWplY3QobmV3IEVycm9yKG1lc3NhZ2UpKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkYXRhVHlwZTogXCJqc29uXCIsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcHJvbWlzZTtcbiAgICB9LFxuXG4gICAgc3RvcmU6IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIHByb21pc2UgPSBuZXcgUlNWUC5Qcm9taXNlKCk7XG4gICAgICAgIHRoaXMuX2FqYXgodGhpcy5pc19uZXcoKSA/IFwiUE9TVFwiIDogXCJQVVRcIiwgdGhpcy5fZm9ybWF0X3VybCh0aGlzLl9lbmRwb2ludHMuUFVUKSwge1xuICAgICAgICAgICAgc3VjY2VzczogKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9zdG9yZV9yZXNvbHZlKGRhdGEpO1xuICAgICAgICAgICAgICAgIHByb21pc2UucmVzb2x2ZSh0aGlzLCBkYXRhKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJvcjogKHhociwgbWVzc2FnZSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX3N0b3JlX3JlamVjdCh4aHIsIG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIHByb21pc2UucmVqZWN0KG5ldyBFcnJvcihtZXNzYWdlKSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHByb21pc2U7XG4gICAgfSxcblxuICAgIF9mb3JtYXRfdXJsOiBmdW5jdGlvbiAodXJsLCBvcHRpb25zID0ge30pIHtcbiAgICAgICAgdmFyIHEgPSBxcy5zdHJpbmdpZnkob3B0aW9ucyk7XG4gICAgICAgIHZhciB1ID0gZm9ybWF0KHVybCwgdGhpcyk7XG4gICAgICAgIGlmICghcSkge1xuICAgICAgICAgICAgcmV0dXJuIHU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHUgKyAocSAmJiB1LmluZGV4T2YoXCI/XCIpID49IDAgPyBcIiZcIiA6IFwiP1wiKSArIHE7XG4gICAgfSxcblxuICAgIF9hamF4OiBmdW5jdGlvbiAobWV0aG9kLCB1cmwsIGRhdGEpIHtcbiAgICAgICAgZGF0YSA9IGRhdGEgfHwge307XG4gICAgICAgIGlmIChfLmlzT2JqZWN0KGRhdGEuZGF0YSkpIHtcbiAgICAgICAgICAgIGRhdGEuZGF0YSA9IEpTT04uc3RyaW5naWZ5KGRhdGEuZGF0YSk7IFxuICAgICAgICB9XG4gICAgICAgICQuYWpheChcbiAgICAgICAgICAgIHVybCxcbiAgICAgICAgICAgICQuZXh0ZW5kKFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgZGF0YVR5cGU6IFwianNvblwiLFxuICAgICAgICAgICAgICAgICAgICBjb250ZW50VHlwZTogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IHRoaXMsXG4gICAgICAgICAgICAgICAgICAgIG1ldGhvZDogbWV0aG9kLFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgZGF0YVxuICAgICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH0sXG5cbiAgICAvKipcbiAgICAgKiBSdW4gb24gZWFjaCBjaGlsZCBvYmplY3QgYXMgZmV0Y2hlZCBhcyBhIG1lbWJlciBvZiB0aGlzIG9iamVjdC4gU2hvdWxkIGNvbnZlcnQgdG8gYSBKYXZhU2NyaXB0IGNsYXNzLlxuICAgICAqL1xuICAgIF9yZXNvbHZlX29iamVjdDogZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfSxcbiAgICBfZmV0Y2hfcmVzb2x2ZTogZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgICAgICB2YXIgYyA9IHRoaXMuX2NsYXNzO1xuICAgICAgICAkLmVhY2goZGF0YSwgZnVuY3Rpb24obWVtYmVyKSB7XG4gICAgICAgICAgICBpZiAobWVtYmVyLnN1YnN0cigwLCAxKSA9PT0gXCJfXCIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYy5tZW1iZXJfdHlwZXNbbWVtYmVyXSkge1xuICAgICAgICAgICAgICAgIGlmIChfLmlzT2JqZWN0KHRoaXMpKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGZbbWVtYmVyXSA9IHNlbGYuX3Jlc29sdmVfb2JqZWN0KHRoaXMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGZbbWVtYmVyXSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5fbmVlZF9sb2FkID0gZmFsc2U7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiTG9hZGVkIFwiICsgdGhpcy5jb25zdHJ1Y3Rvci5uYW1lICsgXCIgI1wiICsgdGhpc1t0aGlzLl9jbGFzcy5pZF9jb2x1bW5dKTtcbiAgICB9LFxuXG4gICAgX2ZldGNoX3JlamVjdDogZnVuY3Rpb24gKHhociwgbWVzc2FnZSkge1xuXG4gICAgfSxcbiAgICBfc3RvcmVfcmVzb2x2ZTogZnVuY3Rpb24gKGRhdGEpIHt9LFxuXG4gICAgX3N0b3JlX3JlamVjdDogZnVuY3Rpb24gKHhociwgbWVzc2FnZSkge1xuXG4gICAgfVxufSk7XG5cblplc2tPYmplY3QubWl4ZWRUb0lkID0gZnVuY3Rpb24obWl4ZWQpIHtcbiAgICBpZiAoXy5pc051bWJlcihtaXhlZCkpIHtcbiAgICAgICAgcmV0dXJuIHBhcnNlSW50KG1peGVkLCAxMCk7XG4gICAgfVxuICAgIGlmIChfLmlzT2JqZWN0KG1peGVkKSkge1xuICAgICAgICByZXR1cm4gbWl4ZWQ7XG4gICAgfVxufTtcblxuWmVza09iamVjdC5mZXRjaEJ5SWQgPSBmdW5jdGlvbihDb25zdHJ1Y3RvciwgbWl4ZWQpIHtcbiAgICB2YXIgcmVzdWx0ID0gbmV3IENvbnN0cnVjdG9yKG1peGVkKTtcbiAgICByZXR1cm4gcmVzdWx0LmZldGNoKCk7XG59O1xuXG5tb2R1bGUuZXhwb3J0cyA9IFplc2tPYmplY3Q7XG4iXX0=