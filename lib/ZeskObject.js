"use strict";

/**
 * Copyright &copy; 2017 Market Acumen, Inc.
 */
var _ = require("lodash");
var ZeskException = require("./ZeskException");

var $ = require("jquery");
var qs = require("qs");
var serializers = require("./MemberTypes").serializers;

var RSVP = require("rsvp-that-works");
var format = require("string-format-obj");

var ZeskObject = function ZeskObject(mixed, options) {
    this._options = _.isObject(options) ? _.cloneDeep(options) : {};
    this._class = $.extend({
        id_column: null,
        primary_keys: [],
        member_types: {},
        null: {},
        member_defaults: {}
    }, this._options.class || {}, this._class || this.class_definition());
    this._initialize_class();
    this._need_load = false;
    $.extend(this, this._class.member_defaults);
    if (mixed) {
        this._init_instance(mixed);
    }
    this._original = $.extend({}, this._members());
    this.initialize();
};

Object.assign(ZeskObject.prototype, {
    _members: function _members() {
        var _this = this;

        var result = {};
        var c = this._class;
        _.forEach(this._class.member_types, function (type, key) {
            result[key] = _this[key] || c.member_defaults[key];
        });
        return result;
    },
    /**
     * Called after object is created with "new" 
     */
    initialize: function initialize() {},
    /**
     * Called after item is fetched and initialized from remote source
     */
    fetched: function fetched() {},

    /**
     * Return the class definition
     */
    class_definition: function class_definition() {
        return {};
    },

    id_column: function id_column() {
        return this._class.id_column || null;
    },

    _initialize_class: function _initialize_class() {
        var c = this._class;
        _.forEach(c.member_types, function (type, name) {
            if (_.isUndefined(c.member_defaults[name])) {
                c.member_defaults[name] = null;
            }
        });
    },
    _init_instance: function _init_instance(mixed) {
        if (_.isObject(mixed)) {
            var self = this;
            var c = this._class;
            _.forEach(mixed, function (value, key) {
                if (!c.member_types[key]) {
                    self[key] = value;
                    // Extra value, store as usual for now.
                    return;
                }
                self[key] = value;
            });
            this._need_load = false;
        } else if ((_.isNumber(mixed) || _.isString(mixed)) && this.id_column()) {
            this[this._class.id_column] = mixed;
            this._need_load = true;
        } else {
            console.log("Unknown init type for " + this.constructor.name + ": " + mixed);
        }
    },

    super_initialize: function super_initialize() {
        this._endpoints = $.extend({
            GET: null,
            PUT: null,
            POST: null,
            DELETE: null
        }, this._endpoints || {});
    },

    is_new: function is_new() {
        var self = this,
            result = true;
        $.each(this._class.primary_keys, function () {
            if (self[this]) {
                result = false;
                return false;
            }
        });
        return result;
    },

    fetch: function fetch(options) {
        var _this2 = this;

        if (!_.isObject(options)) {
            options = {};
        }
        if (!this._endpoints.GET) {
            throw new ZeskException("{class} does not have GET endpoint", { class: this.constructor.name });
        }
        var promise = new RSVP.Promise();
        var url = this._format_url(this._endpoints.GET, options);
        this._ajax("GET", url, {
            success: function success(data) {
                _this2._fetch_resolve(data);
                _this2.fetched();
                promise.resolve(_this2, data);
            },
            error: function error(xhr, message) {
                _this2._fetch_reject();
                promise.reject(new Error(message));
            },
            dataType: "json"
        });
        return promise;
    },

    store: function store() {
        var _this3 = this;

        var promise = new RSVP.Promise();
        var method = this.is_new() ? "PUT" : "POST";
        var url = this._format_url(this._endpoints[method]);
        this._ajax(method, url, {
            success: function success(data) {
                _this3._store_resolve(data);
                data.this = _this3;
                promise.resolve(data);
            },
            error: function error(xhr, message) {
                _this3._store_reject(xhr, message);
                promise.reject(new Error(message));
            },
            data: this._storeData()
        });
        return promise;
    },

    _objectToId: function _objectToId(v) {
        if (!_.isObject(v)) {
            return null;
        }
        if (v._class && v._class.id_column) {
            return v[v._class.id_column];
        }
        if (v.id) {
            return v.id;
        }
        return null;
    },

    _convertType: function _convertType(value, type) {
        if (value === null) {
            return null;
        }
        if (type === "object") {
            var newvalue = this._objectToId(value);
            if (newvalue !== null) {
                return newvalue;
            }
        }
        if (serializers[type]) {
            return serializers[type](value);
        }
        return String(value);
    },
    _storeData: function _storeData() {
        var _this4 = this;

        var c = this._class;
        var data = {};
        _.forEach(c.member_types, function (type, key) {
            var value = _this4._convertType(_this4[key], type);
            if (value !== null || c.null[key]) {
                data[key] = value;
            }
        });
        return data;
    },

    _format_url: function _format_url(url) {
        var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

        var q = qs.stringify(options);
        var u = format(url, this);
        if (!q) {
            return u;
        }
        return u + (q && u.indexOf("?") >= 0 ? "&" : "?") + q;
    },

    _ajax: function _ajax(method, url, data) {
        data = data || {};
        if (_.isObject(data.data)) {
            data.data = JSON.stringify(data.data);
        }
        $.ajax(url, $.extend({
            dataType: "json",
            contentType: "application/json",
            context: this,
            method: method
        }, data));
    },

    /**
     * Run on each child object as fetched as a member of this object. Should convert to a JavaScript class.
     */
    _resolve_object: function _resolve_object(data) {
        return data;
    },
    _fetch_resolve: function _fetch_resolve(data) {
        var self = this;
        var c = this._class;
        $.each(data, function (member) {
            if (member.substr(0, 1) === "_") {
                return;
            }
            if (c.member_types[member]) {
                if (_.isObject(this)) {
                    self[member] = self._resolve_object(this);
                } else {
                    self[member] = this;
                }
            }
        });
        this._need_load = false;
        console.log("Loaded " + this.constructor.name + " #" + this[this._class.id_column]);
    },

    _fetch_reject: function _fetch_reject(xhr, message) {
        console.error("Fetch of object failed " + message);
    },
    _store_resolve: function _store_resolve(data) {
        if (data.status) {
            console.info("Store of object succeeded. Result: " + JSON.stringify(data));
        } else {
            console.error("Store of object failed in application (status). Data follows.");
            console.error(data);
        }
    },
    _store_reject: function _store_reject(xhr, message) {
        console.error("Store of object failed. Result: " + message);
    }
});

ZeskObject.mixedToId = function (mixed) {
    if (_.isNumber(mixed)) {
        return parseInt(mixed, 10);
    }
    if (_.isObject(mixed)) {
        return mixed;
    }
};

ZeskObject.fetchById = function (Constructor, mixed) {
    var result = new Constructor(mixed);
    return result.fetch();
};

module.exports = ZeskObject;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9aZXNrT2JqZWN0LmpzIl0sIm5hbWVzIjpbIl8iLCJyZXF1aXJlIiwiWmVza0V4Y2VwdGlvbiIsIiQiLCJxcyIsInNlcmlhbGl6ZXJzIiwiUlNWUCIsImZvcm1hdCIsIlplc2tPYmplY3QiLCJtaXhlZCIsIm9wdGlvbnMiLCJfb3B0aW9ucyIsImlzT2JqZWN0IiwiY2xvbmVEZWVwIiwiX2NsYXNzIiwiZXh0ZW5kIiwiaWRfY29sdW1uIiwicHJpbWFyeV9rZXlzIiwibWVtYmVyX3R5cGVzIiwibnVsbCIsIm1lbWJlcl9kZWZhdWx0cyIsImNsYXNzIiwiY2xhc3NfZGVmaW5pdGlvbiIsIl9pbml0aWFsaXplX2NsYXNzIiwiX25lZWRfbG9hZCIsIl9pbml0X2luc3RhbmNlIiwiX29yaWdpbmFsIiwiX21lbWJlcnMiLCJpbml0aWFsaXplIiwiT2JqZWN0IiwiYXNzaWduIiwicHJvdG90eXBlIiwicmVzdWx0IiwiYyIsImZvckVhY2giLCJ0eXBlIiwia2V5IiwiZmV0Y2hlZCIsIm5hbWUiLCJpc1VuZGVmaW5lZCIsInNlbGYiLCJ2YWx1ZSIsImlzTnVtYmVyIiwiaXNTdHJpbmciLCJjb25zb2xlIiwibG9nIiwiY29uc3RydWN0b3IiLCJzdXBlcl9pbml0aWFsaXplIiwiX2VuZHBvaW50cyIsIkdFVCIsIlBVVCIsIlBPU1QiLCJERUxFVEUiLCJpc19uZXciLCJlYWNoIiwiZmV0Y2giLCJwcm9taXNlIiwiUHJvbWlzZSIsInVybCIsIl9mb3JtYXRfdXJsIiwiX2FqYXgiLCJzdWNjZXNzIiwiX2ZldGNoX3Jlc29sdmUiLCJkYXRhIiwicmVzb2x2ZSIsImVycm9yIiwieGhyIiwibWVzc2FnZSIsIl9mZXRjaF9yZWplY3QiLCJyZWplY3QiLCJFcnJvciIsImRhdGFUeXBlIiwic3RvcmUiLCJtZXRob2QiLCJfc3RvcmVfcmVzb2x2ZSIsInRoaXMiLCJfc3RvcmVfcmVqZWN0IiwiX3N0b3JlRGF0YSIsIl9vYmplY3RUb0lkIiwidiIsImlkIiwiX2NvbnZlcnRUeXBlIiwibmV3dmFsdWUiLCJTdHJpbmciLCJxIiwic3RyaW5naWZ5IiwidSIsImluZGV4T2YiLCJKU09OIiwiYWpheCIsImNvbnRlbnRUeXBlIiwiY29udGV4dCIsIl9yZXNvbHZlX29iamVjdCIsIm1lbWJlciIsInN1YnN0ciIsInN0YXR1cyIsImluZm8iLCJtaXhlZFRvSWQiLCJwYXJzZUludCIsImZldGNoQnlJZCIsIkNvbnN0cnVjdG9yIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7O0FBR0EsSUFBSUEsSUFBSUMsUUFBUSxRQUFSLENBQVI7QUFDQSxJQUFJQyxnQkFBZ0JELFFBQVEsaUJBQVIsQ0FBcEI7O0FBRUEsSUFBSUUsSUFBSUYsUUFBUSxRQUFSLENBQVI7QUFDQSxJQUFJRyxLQUFLSCxRQUFRLElBQVIsQ0FBVDtBQUNBLElBQUlJLGNBQWNKLFFBQVEsZUFBUixFQUF5QkksV0FBM0M7O0FBRUEsSUFBSUMsT0FBT0wsUUFBUSxpQkFBUixDQUFYO0FBQ0EsSUFBSU0sU0FBU04sUUFBUSxtQkFBUixDQUFiOztBQUVBLElBQUlPLGFBQWEsU0FBYkEsVUFBYSxDQUFTQyxLQUFULEVBQWdCQyxPQUFoQixFQUF5QjtBQUN0QyxTQUFLQyxRQUFMLEdBQWdCWCxFQUFFWSxRQUFGLENBQVdGLE9BQVgsSUFBc0JWLEVBQUVhLFNBQUYsQ0FBWUgsT0FBWixDQUF0QixHQUE2QyxFQUE3RDtBQUNBLFNBQUtJLE1BQUwsR0FBY1gsRUFBRVksTUFBRixDQUNWO0FBQ0lDLG1CQUFXLElBRGY7QUFFSUMsc0JBQWMsRUFGbEI7QUFHSUMsc0JBQWMsRUFIbEI7QUFJSUMsY0FBTSxFQUpWO0FBS0lDLHlCQUFpQjtBQUxyQixLQURVLEVBUVYsS0FBS1QsUUFBTCxDQUFjVSxLQUFkLElBQXVCLEVBUmIsRUFTVixLQUFLUCxNQUFMLElBQWUsS0FBS1EsZ0JBQUwsRUFUTCxDQUFkO0FBV0EsU0FBS0MsaUJBQUw7QUFDQSxTQUFLQyxVQUFMLEdBQWtCLEtBQWxCO0FBQ0FyQixNQUFFWSxNQUFG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LENBUEQ7O0FBU0FELFdBQVcyRixTQUFYLEdBQXVCLFVBQVNDLFdBQVQsRUFBc0IzRixLQUF0QixFQUE2QjtBQUNoRCxRQUFJdUIsU0FBUyxJQUFJb0UsV0FBSixDQUFnQjNGLEtBQWhCLENBQWI7QUFDQSxXQUFPdUIsT0FBT3VCLEtBQVAsRUFBUDtBQUNILENBSEQ7O0FBS0E4QyxPQUFPQyxPQUFQLEdBQWlCOUYsVUFBakIiLCJmaWxlIjoiWmVza09iamVjdC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0ICZjb3B5OyAyMDE3IE1hcmtldCBBY3VtZW4sIEluYy5cbiAqL1xubGV0IF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xubGV0IFplc2tFeGNlcHRpb24gPSByZXF1aXJlKFwiLi9aZXNrRXhjZXB0aW9uXCIpO1xuXG5sZXQgJCA9IHJlcXVpcmUoXCJqcXVlcnlcIik7XG5sZXQgcXMgPSByZXF1aXJlKFwicXNcIik7XG5sZXQgc2VyaWFsaXplcnMgPSByZXF1aXJlKFwiLi9NZW1iZXJUeXBlc1wiKS5zZXJpYWxpemVycztcblxudmFyIFJTVlAgPSByZXF1aXJlKFwicnN2cC10aGF0LXdvcmtzXCIpO1xudmFyIGZvcm1hdCA9IHJlcXVpcmUoXCJzdHJpbmctZm9ybWF0LW9ialwiKTtcblxudmFyIFplc2tPYmplY3QgPSBmdW5jdGlvbihtaXhlZCwgb3B0aW9ucykge1xuICAgIHRoaXMuX29wdGlvbnMgPSBfLmlzT2JqZWN0KG9wdGlvbnMpID8gXy5jbG9uZURlZXAob3B0aW9ucykgOiB7fTtcbiAgICB0aGlzLl9jbGFzcyA9ICQuZXh0ZW5kKFxuICAgICAgICB7XG4gICAgICAgICAgICBpZF9jb2x1bW46IG51bGwsXG4gICAgICAgICAgICBwcmltYXJ5X2tleXM6IFtdLFxuICAgICAgICAgICAgbWVtYmVyX3R5cGVzOiB7fSxcbiAgICAgICAgICAgIG51bGw6IHt9LFxuICAgICAgICAgICAgbWVtYmVyX2RlZmF1bHRzOiB7fSxcbiAgICAgICAgfSxcbiAgICAgICAgdGhpcy5fb3B0aW9ucy5jbGFzcyB8fCB7fSxcbiAgICAgICAgdGhpcy5fY2xhc3MgfHwgdGhpcy5jbGFzc19kZWZpbml0aW9uKClcbiAgICApO1xuICAgIHRoaXMuX2luaXRpYWxpemVfY2xhc3MoKTtcbiAgICB0aGlzLl9uZWVkX2xvYWQgPSBmYWxzZTtcbiAgICAkLmV4dGVuZCh0aGlzLCB0aGlzLl9jbGFzcy5tZW1iZXJfZGVmYXVsdHMpO1xuICAgIGlmIChtaXhlZCkge1xuICAgICAgICB0aGlzLl9pbml0X2luc3RhbmNlKG1peGVkKTtcbiAgICB9XG4gICAgdGhpcy5fb3JpZ2luYWwgPSAkLmV4dGVuZCh7fSwgdGhpcy5fbWVtYmVycygpKTtcbiAgICB0aGlzLmluaXRpYWxpemUoKTtcbn07XG5cbk9iamVjdC5hc3NpZ24oWmVza09iamVjdC5wcm90b3R5cGUsIHtcbiAgICBfbWVtYmVyczogZnVuY3Rpb24oKSB7XG4gICAgICAgIGxldCByZXN1bHQgPSB7fTtcbiAgICAgICAgbGV0IGMgPSB0aGlzLl9jbGFzcztcbiAgICAgICAgXy5mb3JFYWNoKHRoaXMuX2NsYXNzLm1lbWJlcl90eXBlcywgKHR5cGUsIGtleSkgPT4ge1xuICAgICAgICAgICAgcmVzdWx0W2tleV0gPSB0aGlzW2tleV0gfHwgYy5tZW1iZXJfZGVmYXVsdHNba2V5XTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSxcbiAgICAvKipcbiAgICAgKiBDYWxsZWQgYWZ0ZXIgb2JqZWN0IGlzIGNyZWF0ZWQgd2l0aCBcIm5ld1wiIFxuICAgICAqL1xuICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkge30sXG4gICAgLyoqXG4gICAgICogQ2FsbGVkIGFmdGVyIGl0ZW0gaXMgZmV0Y2hlZCBhbmQgaW5pdGlhbGl6ZWQgZnJvbSByZW1vdGUgc291cmNlXG4gICAgICovXG4gICAgZmV0Y2hlZDogZnVuY3Rpb24oKSB7fSxcblxuICAgIC8qKlxuICAgICAqIFJldHVybiB0aGUgY2xhc3MgZGVmaW5pdGlvblxuICAgICAqL1xuICAgIGNsYXNzX2RlZmluaXRpb246IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4ge307XG4gICAgfSxcblxuICAgIGlkX2NvbHVtbjogZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jbGFzcy5pZF9jb2x1bW4gfHwgbnVsbDtcbiAgICB9LFxuXG4gICAgX2luaXRpYWxpemVfY2xhc3M6IGZ1bmN0aW9uKCkge1xuICAgICAgICBsZXQgYyA9IHRoaXMuX2NsYXNzO1xuICAgICAgICBfLmZvckVhY2goYy5tZW1iZXJfdHlwZXMsICh0eXBlLCBuYW1lKSA9PiB7XG4gICAgICAgICAgICBpZiAoXy5pc1VuZGVmaW5lZChjLm1lbWJlcl9kZWZhdWx0c1tuYW1lXSkpIHtcbiAgICAgICAgICAgICAgICBjLm1lbWJlcl9kZWZhdWx0c1tuYW1lXSA9IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgX2luaXRfaW5zdGFuY2U6IGZ1bmN0aW9uKG1peGVkKSB7XG4gICAgICAgIGlmIChfLmlzT2JqZWN0KG1peGVkKSkge1xuICAgICAgICAgICAgbGV0IHNlbGYgPSB0aGlzO1xuICAgICAgICAgICAgbGV0IGMgPSB0aGlzLl9jbGFzcztcbiAgICAgICAgICAgIF8uZm9yRWFjaChtaXhlZCwgKHZhbHVlLCBrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoIWMubWVtYmVyX3R5cGVzW2tleV0pIHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZltrZXldID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIC8vIEV4dHJhIHZhbHVlLCBzdG9yZSBhcyB1c3VhbCBmb3Igbm93LlxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHNlbGZba2V5XSA9IHZhbHVlO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLl9uZWVkX2xvYWQgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIGlmICgoXy5pc051bWJlcihtaXhlZCkgfHwgXy5pc1N0cmluZyhtaXhlZCkpICYmIHRoaXMuaWRfY29sdW1uKCkpIHtcbiAgICAgICAgICAgIHRoaXNbdGhpcy5fY2xhc3MuaWRfY29sdW1uXSA9IG1peGVkO1xuICAgICAgICAgICAgdGhpcy5fbmVlZF9sb2FkID0gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVW5rbm93biBpbml0IHR5cGUgZm9yIFwiICsgdGhpcy5jb25zdHJ1Y3Rvci5uYW1lICsgXCI6IFwiICsgbWl4ZWQpO1xuICAgICAgICB9XG4gICAgfSxcblxuICAgIHN1cGVyX2luaXRpYWxpemU6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLl9lbmRwb2ludHMgPSAkLmV4dGVuZChcbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBHRVQ6IG51bGwsXG4gICAgICAgICAgICAgICAgUFVUOiBudWxsLFxuICAgICAgICAgICAgICAgIFBPU1Q6IG51bGwsXG4gICAgICAgICAgICAgICAgREVMRVRFOiBudWxsLFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRoaXMuX2VuZHBvaW50cyB8fCB7fVxuICAgICAgICApO1xuICAgIH0sXG5cbiAgICBpc19uZXc6IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXMsXG4gICAgICAgICAgICByZXN1bHQgPSB0cnVlO1xuICAgICAgICAkLmVhY2godGhpcy5fY2xhc3MucHJpbWFyeV9rZXlzLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGlmIChzZWxmW3RoaXNdKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LFxuXG4gICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCFfLmlzT2JqZWN0KG9wdGlvbnMpKSB7XG4gICAgICAgICAgICBvcHRpb25zID0ge307XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCF0aGlzLl9lbmRwb2ludHMuR0VUKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgWmVza0V4Y2VwdGlvbihcIntjbGFzc30gZG9lcyBub3QgaGF2ZSBHRVQgZW5kcG9pbnRcIiwgeyBjbGFzczogdGhpcy5jb25zdHJ1Y3Rvci5uYW1lIH0pO1xuICAgICAgICB9XG4gICAgICAgIHZhciBwcm9taXNlID0gbmV3IFJTVlAuUHJvbWlzZSgpO1xuICAgICAgICB2YXIgdXJsID0gdGhpcy5fZm9ybWF0X3VybCh0aGlzLl9lbmRwb2ludHMuR0VULCBvcHRpb25zKTtcbiAgICAgICAgdGhpcy5fYWpheChcIkdFVFwiLCB1cmwsIHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX2ZldGNoX3Jlc29sdmUoZGF0YSk7XG4gICAgICAgICAgICAgICAgdGhpcy5mZXRjaGVkKCk7XG4gICAgICAgICAgICAgICAgcHJvbWlzZS5yZXNvbHZlKHRoaXMsIGRhdGEpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yOiAoeGhyLCBtZXNzYWdlKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fZmV0Y2hfcmVqZWN0KCk7XG4gICAgICAgICAgICAgICAgcHJvbWlzZS5yZWplY3QobmV3IEVycm9yKG1lc3NhZ2UpKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkYXRhVHlwZTogXCJqc29uXCIsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcHJvbWlzZTtcbiAgICB9LFxuXG4gICAgc3RvcmU6IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgcHJvbWlzZSA9IG5ldyBSU1ZQLlByb21pc2UoKTtcbiAgICAgICAgdmFyIG1ldGhvZCA9IHRoaXMuaXNfbmV3KCkgPyBcIlBVVFwiIDogXCJQT1NUXCI7XG4gICAgICAgIGxldCB1cmwgPSB0aGlzLl9mb3JtYXRfdXJsKHRoaXMuX2VuZHBvaW50c1ttZXRob2RdKTtcbiAgICAgICAgdGhpcy5fYWpheChtZXRob2QsIHVybCwge1xuICAgICAgICAgICAgc3VjY2VzczogZGF0YSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5fc3RvcmVfcmVzb2x2ZShkYXRhKTtcbiAgICAgICAgICAgICAgICBkYXRhLnRoaXMgPSB0aGlzO1xuICAgICAgICAgICAgICAgIHByb21pc2UucmVzb2x2ZShkYXRhKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBlcnJvcjogKHhociwgbWVzc2FnZSkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX3N0b3JlX3JlamVjdCh4aHIsIG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIHByb21pc2UucmVqZWN0KG5ldyBFcnJvcihtZXNzYWdlKSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZGF0YTogdGhpcy5fc3RvcmVEYXRhKCksXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gcHJvbWlzZTtcbiAgICB9LFxuXG4gICAgX29iamVjdFRvSWQ6IGZ1bmN0aW9uKHYpIHtcbiAgICAgICAgaWYgKCFfLmlzT2JqZWN0KHYpKSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgICAgICBpZiAodi5fY2xhc3MgJiYgdi5fY2xhc3MuaWRfY29sdW1uKSB7XG4gICAgICAgICAgICByZXR1cm4gdlt2Ll9jbGFzcy5pZF9jb2x1bW5dO1xuICAgICAgICB9XG4gICAgICAgIGlmICh2LmlkKSB7XG4gICAgICAgICAgICByZXR1cm4gdi5pZDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9LFxuXG4gICAgX2NvbnZlcnRUeXBlOiBmdW5jdGlvbih2YWx1ZSwgdHlwZSkge1xuICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0eXBlID09PSBcIm9iamVjdFwiKSB7XG4gICAgICAgICAgICBsZXQgbmV3dmFsdWUgPSB0aGlzLl9vYmplY3RUb0lkKHZhbHVlKTtcbiAgICAgICAgICAgIGlmIChuZXd2YWx1ZSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXd2YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoc2VyaWFsaXplcnNbdHlwZV0pIHtcbiAgICAgICAgICAgIHJldHVybiBzZXJpYWxpemVyc1t0eXBlXSh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7XG4gICAgfSxcbiAgICBfc3RvcmVEYXRhOiBmdW5jdGlvbigpIHtcbiAgICAgICAgbGV0IGMgPSB0aGlzLl9jbGFzcztcbiAgICAgICAgbGV0IGRhdGEgPSB7fTtcbiAgICAgICAgXy5mb3JFYWNoKGMubWVtYmVyX3R5cGVzLCAodHlwZSwga2V5KSA9PiB7XG4gICAgICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLl9jb252ZXJ0VHlwZSh0aGlzW2tleV0sIHR5cGUpO1xuICAgICAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsIHx8IGMubnVsbFtrZXldKSB7XG4gICAgICAgICAgICAgICAgZGF0YVtrZXldID0gdmFsdWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gZGF0YTtcbiAgICB9LFxuXG4gICAgX2Zvcm1hdF91cmw6IGZ1bmN0aW9uKHVybCwgb3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIHZhciBxID0gcXMuc3RyaW5naWZ5KG9wdGlvbnMpO1xuICAgICAgICB2YXIgdSA9IGZvcm1hdCh1cmwsIHRoaXMpO1xuICAgICAgICBpZiAoIXEpIHtcbiAgICAgICAgICAgIHJldHVybiB1O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB1ICsgKHEgJiYgdS5pbmRleE9mKFwiP1wiKSA+PSAwID8gXCImXCIgOiBcIj9cIikgKyBxO1xuICAgIH0sXG5cbiAgICBfYWpheDogZnVuY3Rpb24obWV0aG9kLCB1cmwsIGRhdGEpIHtcbiAgICAgICAgZGF0YSA9IGRhdGEgfHwge307XG4gICAgICAgIGlmIChfLmlzT2JqZWN0KGRhdGEuZGF0YSkpIHtcbiAgICAgICAgICAgIGRhdGEuZGF0YSA9IEpTT04uc3RyaW5naWZ5KGRhdGEuZGF0YSk7XG4gICAgICAgIH1cbiAgICAgICAgJC5hamF4KFxuICAgICAgICAgICAgdXJsLFxuICAgICAgICAgICAgJC5leHRlbmQoXG4gICAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZTogXCJqc29uXCIsXG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnRUeXBlOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgICAgICAgICAgICAgICAgY29udGV4dDogdGhpcyxcbiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiBtZXRob2QsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBkYXRhXG4gICAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgfSxcblxuICAgIC8qKlxuICAgICAqIFJ1biBvbiBlYWNoIGNoaWxkIG9iamVjdCBhcyBmZXRjaGVkIGFzIGEgbWVtYmVyIG9mIHRoaXMgb2JqZWN0LiBTaG91bGQgY29udmVydCB0byBhIEphdmFTY3JpcHQgY2xhc3MuXG4gICAgICovXG4gICAgX3Jlc29sdmVfb2JqZWN0OiBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgIHJldHVybiBkYXRhO1xuICAgIH0sXG4gICAgX2ZldGNoX3Jlc29sdmU6IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgICAgICB2YXIgYyA9IHRoaXMuX2NsYXNzO1xuICAgICAgICAkLmVhY2goZGF0YSwgZnVuY3Rpb24obWVtYmVyKSB7XG4gICAgICAgICAgICBpZiAobWVtYmVyLnN1YnN0cigwLCAxKSA9PT0gXCJfXCIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYy5tZW1iZXJfdHlwZXNbbWVtYmVyXSkge1xuICAgICAgICAgICAgICAgIGlmIChfLmlzT2JqZWN0KHRoaXMpKSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGZbbWVtYmVyXSA9IHNlbGYuX3Jlc29sdmVfb2JqZWN0KHRoaXMpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHNlbGZbbWVtYmVyXSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5fbmVlZF9sb2FkID0gZmFsc2U7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiTG9hZGVkIFwiICsgdGhpcy5jb25zdHJ1Y3Rvci5uYW1lICsgXCIgI1wiICsgdGhpc1t0aGlzLl9jbGFzcy5pZF9jb2x1bW5dKTtcbiAgICB9LFxuXG4gICAgX2ZldGNoX3JlamVjdDogZnVuY3Rpb24oeGhyLCBtZXNzYWdlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJGZXRjaCBvZiBvYmplY3QgZmFpbGVkIFwiICsgbWVzc2FnZSk7XG4gICAgfSxcbiAgICBfc3RvcmVfcmVzb2x2ZTogZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICBpZiAoZGF0YS5zdGF0dXMpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhcIlN0b3JlIG9mIG9iamVjdCBzdWNjZWVkZWQuIFJlc3VsdDogXCIgKyBKU09OLnN0cmluZ2lmeShkYXRhKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKFwiU3RvcmUgb2Ygb2JqZWN0IGZhaWxlZCBpbiBhcHBsaWNhdGlvbiAoc3RhdHVzKS4gRGF0YSBmb2xsb3dzLlwiKTtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZGF0YSk7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIF9zdG9yZV9yZWplY3Q6IGZ1bmN0aW9uKHhociwgbWVzc2FnZSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiU3RvcmUgb2Ygb2JqZWN0IGZhaWxlZC4gUmVzdWx0OiBcIiArIG1lc3NhZ2UpO1xuICAgIH0sXG59KTtcblxuWmVza09iamVjdC5taXhlZFRvSWQgPSBmdW5jdGlvbihtaXhlZCkge1xuICAgIGlmIChfLmlzTnVtYmVyKG1peGVkKSkge1xuICAgICAgICByZXR1cm4gcGFyc2VJbnQobWl4ZWQsIDEwKTtcbiAgICB9XG4gICAgaWYgKF8uaXNPYmplY3QobWl4ZWQpKSB7XG4gICAgICAgIHJldHVybiBtaXhlZDtcbiAgICB9XG59O1xuXG5aZXNrT2JqZWN0LmZldGNoQnlJZCA9IGZ1bmN0aW9uKENvbnN0cnVjdG9yLCBtaXhlZCkge1xuICAgIHZhciByZXN1bHQgPSBuZXcgQ29uc3RydWN0b3IobWl4ZWQpO1xuICAgIHJldHVybiByZXN1bHQuZmV0Y2goKTtcbn07XG5cbm1vZHVsZS5leHBvcnRzID0gWmVza09iamVjdDtcbiJdfQ==