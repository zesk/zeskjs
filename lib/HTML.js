'use strict';

/*
 * $Id$
 *
 * Copyright (C) 2017 Market Acumen, Inc. All rights reserved
 */
var $ = require('jquery');
var zesk = require('./Zesk');

var avalue = zesk.avalue;
var is_object = zesk.is_object;
var is_string = zesk.is_string;
var _escape_map = {
	"&": "&amp;",
	"<": "&lt;",
	">": "&gt;",
	"\"": "&quot;",
	"`": "&#96;",
	"'": "&#x27"
};
var _escape_map_flip;
var HTML = {
	specials: function specials(html) {
		return $("<textarea />").text(html).html();
	},
	escape: function escape(text) {
		return String(text).tr(_escape_map);
	},
	unescape: function unescape(text) {
		return String(text).tr(_escape_map_flip);
	},
	encode: function encode(text) {
		var result = document.createElement('a').appendChild(document.createTextNode(text)).parentNode.innerHTML;
		return result.str_replace('"', '&quot;');
	},
	decode: function decode(html) {
		var a = document.createElement('a');
		a.innerHTML = html;
		return a.textContent;
	},
	to_attributes: function to_attributes(mixed) {
		var obj = {};
		if (!is_string(mixed) || mixed.length === 0) {
			return arguments[1] || null;
		}
		$.each(mixed.split(" "), function () {
			var token = this.trim(),
			    c = token.substr(0, 1);
			if (c === '#') {
				obj.id = token;
				return;
			}
			if (c === '.') {
				token = token.substr(1);
			}
			if (obj['class']) {
				obj['class'] += ' ' + token;
			} else {
				obj['class'] = token;
			}
		});
		return obj;
	},
	attributes: function attributes(_attributes) {
		var a,
		    r = [];
		if (!_attributes) {
			return "";
		}
		for (a in _attributes) {
			if (_attributes.hasOwnProperty(a)) {
				if (a.substr(0, 1) === '*') {
					r.push(a.substr(1) + "=\"" + _attributes[a] + "\"");
				} else {
					r.push(a.toString() + "=\"" + HTML.encode(_attributes[a]) + "\"");
				}
			}
		}
		if (r.length === 0) {
			return "";
		}
		return " " + r.join(" ");
	},
	tag: function tag(name, mixed) {
		var attributes,
		    content,
		    args = arguments;
		if (is_object(mixed)) {
			attributes = mixed;
			content = avalue(args, 2, null);
		} else if (args.length > 2) {
			attributes = HTML.to_attributes(mixed);
			content = args[2];
		} else {
			attributes = {};
			content = mixed;
		}
		name = name.toLowerCase();
		return "<" + name + " " + HTML.attributes(attributes) + (content === null ? " />" : ">" + content + "</" + name + ">");
	},
	tags: function tags(name, mixed) {
		var attributes,
		    content,
		    args = arguments,
		    result = "";
		if (is_object(mixed)) {
			attributes = mixed;
			content = avalue(args, 2, null);
		} else if (args.length > 2) {
			attributes = HTML.to_attributes(mixed);
			content = args[2];
		} else {
			attributes = {};
			content = mixed;
		}
		$.each(content, function () {
			result += HTML.tag(name, attributes, this);
		});
		return result;
	}
};

// Zesk.tag = function(name) {
// 	var a = arguments;
// 	if (a.length > 2) {
// 		return HTML.tag(name, a[1], a[2]);
// 	} else {
// 		return HTML.tag(name, a[1]);
// 	}
// };

module.exports = HTML;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9IVE1MLmpzIl0sIm5hbWVzIjpbIiQiLCJyZXF1aXJlIiwiemVzayIsImF2YWx1ZSIsImlzX29iamVjdCIsImlzX3N0cmluZyIsIl9lc2NhcGVfbWFwIiwiX2VzY2FwZV9tYXBfZmxpcCIsIkhUTUwiLCJzcGVjaWFscyIsImh0bWwiLCJ0ZXh0IiwiZXNjYXBlIiwiU3RyaW5nIiwidHIiLCJ1bmVzY2FwZSIsImVuY29kZSIsInJlc3VsdCIsImRvY3VtZW50IiwiY3JlYXRlRWxlbWVudCIsImFwcGVuZENoaWxkIiwiY3JlYXRlVGV4dE5vZGUiLCJwYXJlbnROb2RlIiwiaW5uZXJIVE1MIiwic3RyX3JlcGxhY2UiLCJkZWNvZGUiLCJhIiwidGV4dENvbnRlbnQiLCJ0b19hdHRyaWJ1dGVzIiwibWl4ZWQiLCJvYmoiLCJsZW5ndGgiLCJhcmd1bWVudHMiLCJlYWNoIiwic3BsaXQiLCJ0b2tlbiIsInRyaW0iLCJjIiwic3Vic3RyIiwiaWQiLCJhdHRyaWJ1dGVzIiwiciIsImhhc093blByb3BlcnR5IiwicHVzaCIsInRvU3RyaW5nIiwiam9pbiIsInRhZyIsIm5hbWUiLCJjb250ZW50IiwiYXJncyIsInRvTG93ZXJDYXNlIiwidGFncyIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7O0FBS0EsSUFBTUEsSUFBSUMsUUFBUSxRQUFSLENBQVY7QUFDQSxJQUFNQyxPQUFPRCxRQUFRLFFBQVIsQ0FBYjs7QUFFQSxJQUFJRSxTQUFTRCxLQUFLQyxNQUFsQjtBQUNBLElBQUlDLFlBQVlGLEtBQUtFLFNBQXJCO0FBQ0EsSUFBSUMsWUFBWUgsS0FBS0csU0FBckI7QUFDQSxJQUFJQyxjQUFjO0FBQ2IsTUFBSyxPQURRO0FBRWIsTUFBSyxNQUZRO0FBR2IsTUFBSyxNQUhRO0FBSWIsT0FBTSxRQUpPO0FBS2IsTUFBSyxPQUxRO0FBTWIsTUFBSztBQU5RLENBQWxCO0FBUUEsSUFBSUMsZ0JBQUo7QUFDQSxJQUFJQyxPQUFPO0FBQ1BD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QUFLb0IsYUFBTCxDQUFtQkMsS0FBbkIsQ0FBYjtBQUNBbUIsYUFBVUMsS0FBSyxDQUFMLENBQVY7QUFDQSxHQUhNLE1BR0E7QUFDTlQsZ0JBQWEsRUFBYjtBQUNBUSxhQUFVbkIsS0FBVjtBQUNBO0FBQ0Q3QixJQUFFaUMsSUFBRixDQUFPZSxPQUFQLEVBQWdCLFlBQVc7QUFDMUIvQixhQUFVVCxLQUFLc0MsR0FBTCxDQUFTQyxJQUFULEVBQWVQLFVBQWYsRUFBMkIsSUFBM0IsQ0FBVjtBQUNBLEdBRkQ7QUFHQSxTQUFPdkIsTUFBUDtBQUNBO0FBM0ZNLENBQVg7O0FBOEZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FBRUFtQyxPQUFPQyxPQUFQLEdBQWlCN0MsSUFBakIiLCJmaWxlIjoiSFRNTC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiAkSWQkXG4gKlxuICogQ29weXJpZ2h0IChDKSAyMDE3IE1hcmtldCBBY3VtZW4sIEluYy4gQWxsIHJpZ2h0cyByZXNlcnZlZFxuICovXG5jb25zdCAkID0gcmVxdWlyZSgnanF1ZXJ5Jyk7XG5jb25zdCB6ZXNrID0gcmVxdWlyZSgnLi9aZXNrJyk7XG5cbnZhciBhdmFsdWUgPSB6ZXNrLmF2YWx1ZTtcbnZhciBpc19vYmplY3QgPSB6ZXNrLmlzX29iamVjdDtcbnZhciBpc19zdHJpbmcgPSB6ZXNrLmlzX3N0cmluZztcbnZhciBfZXNjYXBlX21hcCA9IHtcblx0ICAgIFwiJlwiOiBcIiZhbXA7XCIsXG5cdCAgICBcIjxcIjogXCImbHQ7XCIsXG5cdCAgICBcIj5cIjogXCImZ3Q7XCIsXG5cdCAgICBcIlxcXCJcIjogXCImcXVvdDtcIixcblx0ICAgIFwiYFwiOiBcIiYjOTY7XCIsXG5cdCAgICBcIidcIjogXCImI3gyN1wiXG5cdH07XG52YXIgX2VzY2FwZV9tYXBfZmxpcDtcbnZhciBIVE1MID0ge1xuICAgIHNwZWNpYWxzOiBmdW5jdGlvbihodG1sKSB7XG5cdCAgICByZXR1cm4gJChcIjx0ZXh0YXJlYSAvPlwiKS50ZXh0KGh0bWwpLmh0bWwoKTtcbiAgICB9LFxuICAgIGVzY2FwZTogZnVuY3Rpb24odGV4dCkge1xuXHQgICAgcmV0dXJuIFN0cmluZyh0ZXh0KS50cihfZXNjYXBlX21hcCk7XG4gICAgfSxcbiAgICB1bmVzY2FwZTogZnVuY3Rpb24odGV4dCkge1xuXHQgICAgcmV0dXJuIFN0cmluZyh0ZXh0KS50cihfZXNjYXBlX21hcF9mbGlwKTtcbiAgICB9LFxuICAgIGVuY29kZTogZnVuY3Rpb24odGV4dCkge1xuXHQgICAgdmFyIHJlc3VsdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KSkucGFyZW50Tm9kZS5pbm5lckhUTUw7XG5cdCAgICByZXR1cm4gcmVzdWx0LnN0cl9yZXBsYWNlKCdcIicsICcmcXVvdDsnKTtcbiAgICB9LFxuICAgIGRlY29kZTogZnVuY3Rpb24oaHRtbCkge1xuXHQgICAgdmFyIGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7XG5cdCAgICBhLmlubmVySFRNTCA9IGh0bWw7XG5cdCAgICByZXR1cm4gYS50ZXh0Q29udGVudDtcbiAgICB9LFxuICAgIHRvX2F0dHJpYnV0ZXM6IGZ1bmN0aW9uKG1peGVkKSB7XG5cdCAgICB2YXIgb2JqID0ge307XG5cdCAgICBpZiAoIWlzX3N0cmluZyhtaXhlZCkgfHwgbWl4ZWQubGVuZ3RoID09PSAwKSB7XG5cdFx0ICAgIHJldHVybiBhcmd1bWVudHNbMV0gfHwgbnVsbDtcblx0ICAgIH1cblx0ICAgICQuZWFjaChtaXhlZC5zcGxpdChcIiBcIiksIGZ1bmN0aW9uKCkge1xuXHRcdCAgICB2YXIgdG9rZW4gPSB0aGlzLnRyaW0oKSwgYyA9IHRva2VuLnN1YnN0cigwLCAxKTtcblx0XHQgICAgaWYgKGMgPT09ICcjJykge1xuXHRcdFx0ICAgIG9iai5pZCA9IHRva2VuO1xuXHRcdFx0ICAgIHJldHVybjtcblx0XHQgICAgfVxuXHRcdCAgICBpZiAoYyA9PT0gJy4nKSB7XG5cdFx0XHQgICAgdG9rZW4gPSB0b2tlbi5zdWJzdHIoMSk7XG5cdFx0ICAgIH1cblx0XHQgICAgaWYgKG9ialsnY2xhc3MnXSkge1xuXHRcdFx0ICAgIG9ialsnY2xhc3MnXSArPSAnICcgKyB0b2tlbjtcblx0XHQgICAgfSBlbHNlIHtcblx0XHRcdCAgICBvYmpbJ2NsYXNzJ10gPSB0b2tlbjtcblx0XHQgICAgfVxuXHQgICAgfSk7XG5cdCAgICByZXR1cm4gb2JqO1xuICAgIH0sXG4gICAgYXR0cmlidXRlczogZnVuY3Rpb24oYXR0cmlidXRlcykge1xuXHQgICAgdmFyIGEsIHIgPSBbXTtcblx0ICAgIGlmICghYXR0cmlidXRlcykge1xuXHRcdCAgICByZXR1cm4gXCJcIjtcblx0ICAgIH1cblx0ICAgIGZvciAoYSBpbiBhdHRyaWJ1dGVzKSB7XG5cdFx0ICAgIGlmIChhdHRyaWJ1dGVzLmhhc093blByb3BlcnR5KGEpKSB7XG5cdFx0XHQgICAgaWYgKGEuc3Vic3RyKDAsIDEpID09PSAnKicpIHtcblx0XHRcdFx0ICAgIHIucHVzaChhLnN1YnN0cigxKSArIFwiPVxcXCJcIiArIGF0dHJpYnV0ZXNbYV0gKyBcIlxcXCJcIik7XG5cdFx0XHQgICAgfSBlbHNlIHtcblx0XHRcdFx0ICAgIHIucHVzaChhLnRvU3RyaW5nKCkgKyBcIj1cXFwiXCIgKyBIVE1MLmVuY29kZShhdHRyaWJ1dGVzW2FdKSArIFwiXFxcIlwiKTtcblx0XHRcdCAgICB9XG5cdFx0ICAgIH1cblx0ICAgIH1cblx0ICAgIGlmIChyLmxlbmd0aCA9PT0gMCkge1xuXHRcdCAgICByZXR1cm4gXCJcIjtcblx0ICAgIH1cblx0ICAgIHJldHVybiBcIiBcIiArIHIuam9pbihcIiBcIik7XG4gICAgfSxcbiAgICB0YWc6IGZ1bmN0aW9uKG5hbWUsIG1peGVkKSB7XG5cdCAgICB2YXIgYXR0cmlidXRlcywgY29udGVudCwgYXJncyA9IGFyZ3VtZW50cztcblx0ICAgIGlmIChpc19vYmplY3QobWl4ZWQpKSB7XG5cdFx0ICAgIGF0dHJpYnV0ZXMgPSBtaXhlZDtcblx0XHQgICAgY29udGVudCA9IGF2YWx1ZShhcmdzLCAyLCBudWxsKTtcblx0ICAgIH0gZWxzZSBpZiAoYXJncy5sZW5ndGggPiAyKSB7XG5cdFx0ICAgIGF0dHJpYnV0ZXMgPSBIVE1MLnRvX2F0dHJpYnV0ZXMobWl4ZWQpO1xuXHRcdCAgICBjb250ZW50ID0gYXJnc1syXTtcblx0ICAgIH0gZWxzZSB7XG5cdFx0ICAgIGF0dHJpYnV0ZXMgPSB7fTtcblx0XHQgICAgY29udGVudCA9IG1peGVkO1xuXHQgICAgfVxuXHQgICAgbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTtcblx0ICAgIHJldHVybiBcIjxcIiArIG5hbWUgKyBcIiBcIiArIEhUTUwuYXR0cmlidXRlcyhhdHRyaWJ1dGVzKSArIChjb250ZW50ID09PSBudWxsID8gXCIgLz5cIiA6IFwiPlwiICsgY29udGVudCArIFwiPC9cIiArIG5hbWUgKyBcIj5cIik7XG4gICAgfSxcbiAgICB0YWdzOiBmdW5jdGlvbihuYW1lLCBtaXhlZCkge1xuXHQgICAgdmFyIGF0dHJpYnV0ZXMsIGNvbnRlbnQsIGFyZ3MgPSBhcmd1bWVudHMsIHJlc3VsdCA9IFwiXCI7XG5cdCAgICBpZiAoaXNfb2JqZWN0KG1peGVkKSkge1xuXHRcdCAgICBhdHRyaWJ1dGVzID0gbWl4ZWQ7XG5cdFx0ICAgIGNvbnRlbnQgPSBhdmFsdWUoYXJncywgMiwgbnVsbCk7XG5cdCAgICB9IGVsc2UgaWYgKGFyZ3MubGVuZ3RoID4gMikge1xuXHRcdCAgICBhdHRyaWJ1dGVzID0gSFRNTC50b19hdHRyaWJ1dGVzKG1peGVkKTtcblx0XHQgICAgY29udGVudCA9IGFyZ3NbMl07XG5cdCAgICB9IGVsc2Uge1xuXHRcdCAgICBhdHRyaWJ1dGVzID0ge307XG5cdFx0ICAgIGNvbnRlbnQgPSBtaXhlZDtcblx0ICAgIH1cblx0ICAgICQuZWFjaChjb250ZW50LCBmdW5jdGlvbigpIHtcblx0XHQgICAgcmVzdWx0ICs9IEhUTUwudGFnKG5hbWUsIGF0dHJpYnV0ZXMsIHRoaXMpO1xuXHQgICAgfSk7XG5cdCAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cbn07XG5cbi8vIFplc2sudGFnID0gZnVuY3Rpb24obmFtZSkge1xuLy8gXHR2YXIgYSA9IGFyZ3VtZW50cztcbi8vIFx0aWYgKGEubGVuZ3RoID4gMikge1xuLy8gXHRcdHJldHVybiBIVE1MLnRhZyhuYW1lLCBhWzFdLCBhWzJdKTtcbi8vIFx0fSBlbHNlIHtcbi8vIFx0XHRyZXR1cm4gSFRNTC50YWcobmFtZSwgYVsxXSk7XG4vLyBcdH1cbi8vIH07XG5cbm1vZHVsZS5leHBvcnRzID0gSFRNTDtcbiJdfQ==